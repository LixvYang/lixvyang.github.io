<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://yanglixin.com/posts/program/golang/%E5%8D%95%E6%B5%8B/%E5%8D%95%E6%B5%8B%E6%80%BB%E7%BB%93/ut.html"><meta property="og:title" content="Go å•æµ‹æ€»ç»“"><meta property="og:description" content="è¿™é‡Œæ€»ç»“äº†æˆ‘åˆ°ç›®å‰ä¸ºæ­¢åœ¨goå•æµ‹æ–¹é¢çš„æ‰€æœ‰å§¿åŠ¿ï¼Œç­‰å¾…è¡¥å……."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-10-05T02:57:17.000Z"><meta property="article:author" content="ç¦»å¿ƒ"><meta property="article:tag" content="golang"><meta property="article:tag" content="UT"><meta property="article:published_time" content="2023-09-18T00:00:00.000Z"><meta property="article:modified_time" content="2023-10-05T02:57:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Go å•æµ‹æ€»ç»“","image":[""],"datePublished":"2023-09-18T00:00:00.000Z","dateModified":"2023-10-05T02:57:17.000Z","author":[{"@type":"Person","name":"ç¦»å¿ƒ"}]}</script><link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>Go å•æµ‹æ€»ç»“</title><meta name="description" content="è¿™é‡Œæ€»ç»“äº†æˆ‘åˆ°ç›®å‰ä¸ºæ­¢åœ¨goå•æµ‹æ–¹é¢çš„æ‰€æœ‰å§¿åŠ¿ï¼Œç­‰å¾…è¡¥å…….">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-898c079a.css" as="style"><link rel="stylesheet" href="/assets/style-898c079a.css">
    <link rel="modulepreload" href="/assets/app-8b169e14.js"><link rel="modulepreload" href="/assets/ut.html-23bf2978.js"><link rel="modulepreload" href="/assets/ut.html-49d3d596.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><!----><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:home" width="1em" height="1em"></iconify-icon>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/posts/program/golang/"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="file-icons:go-old" width="1em" height="1em"></iconify-icon>Golangç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/posts/thinking/"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icons8:idea" width="1em" height="1em"></iconify-icon>æ€è€ƒ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/archives.html"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="teenyicons:archive-outline" width="1em" height="1em"></iconify-icon>å½’æ¡£<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/intro.html"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="material-symbols:info-outline" width="1em" height="1em"></iconify-icon>å…³äº<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/lixvyang" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><iconify-icon class="font-icon icon" style="" mode="style" inline icon="file-icons:test-go" width="1em" height="1em"></iconify-icon>Go å•æµ‹æ€»ç»“</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">ç¦»å¿ƒ</span></span><span property="author" content="ç¦»å¿ƒ"></span></span><span class="page-original-info">åŸåˆ›</span><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-09-18T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 27 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT27M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category5 clickable" role="navigation">tutorial</span><!--]--><meta property="articleSection" content="tutorial"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag7 clickable" role="navigation">golang</span><span class="page-tag-item tag1 clickable" role="navigation">UT</span><!--]--><meta property="keywords" content="golang,UT"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#å•æµ‹">å•æµ‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å•æµ‹å‡½æ•°">å•æµ‹å‡½æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æµ‹è¯•ç»„">æµ‹è¯•ç»„</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æµ‹è¯•è¦†ç›–ç‡">æµ‹è¯•è¦†ç›–ç‡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#åŸºå‡†æµ‹è¯•">åŸºå‡†æµ‹è¯•</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#ç½‘ç»œæµ‹è¯•">ç½‘ç»œæµ‹è¯•</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#httptest">httptest</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#gock">gock</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#mysqlå’Œrediså•æµ‹">MySQLå’ŒRediså•æµ‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#go-sqlmock">go-sqlmock</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#miniredis">miniredis</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#gomock-æ¨¡æ‹Ÿæ¥å£è¡Œä¸º">GoMock æ¨¡æ‹Ÿæ¥å£è¡Œä¸º</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#ä½¿ç”¨monkeyæ‰“æ¡©">ä½¿ç”¨monkeyæ‰“æ¡©</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#ç¼–å†™å¯æµ‹è¯•çš„ä»£ç ">ç¼–å†™å¯æµ‹è¯•çš„ä»£ç </a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ¥å£æŠ½è±¡è¿›è¡Œè§£è€¦">æ¥å£æŠ½è±¡è¿›è¡Œè§£è€¦</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¾èµ–æ³¨å…¥ä»£æ›¿éšå¼ä¾èµ–">ä¾èµ–æ³¨å…¥ä»£æ›¿éšå¼ä¾èµ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#solidåŸåˆ™">SOLIDåŸåˆ™</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>è¿™é‡Œæ€»ç»“äº†æˆ‘åˆ°ç›®å‰ä¸ºæ­¢åœ¨goå•æµ‹æ–¹é¢çš„æ‰€æœ‰å§¿åŠ¿ï¼Œç­‰å¾…è¡¥å…….</p><!-- more --><h1 id="go-å•æµ‹æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#go-å•æµ‹æ€»ç»“" aria-hidden="true">#</a> Go å•æµ‹æ€»ç»“</h1><h2 id="å•æµ‹" tabindex="-1"><a class="header-anchor" href="#å•æµ‹" aria-hidden="true">#</a> å•æµ‹</h2><p>Go å•æµ‹ç¦»ä¸å¼€<code>go test</code> å‘½ä»¤çš„ï¼Œç¼–å†™æµ‹è¯•ä»£ç å’Œæ™®é€šçš„goä»£ç è¿‡ç¨‹è¯­æ³•æ˜¯ç±»ä¼¼çš„ã€‚</p><p>go testå‘½ä»¤æ˜¯æŒ‰ç…§ä¸€å®šçº¦å®šå’Œç»„ç»‡æµ‹è¯•ä»£ç çš„é©±åŠ¨äºŒè¿›åˆ¶ç¨‹åºã€‚åœ¨åŒ…ç›®å½•ä¸‹ï¼Œæ‰€æœ‰ä»¥<code>_test.go</code>çš„æ–‡ä»¶go testæµ‹è¯•çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”æ‰§è¡Œgo buildä¸ä¼šè¢«ç¼–è¯‘åˆ°æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å»ã€‚</p><p>åœ¨<code>*_test.go</code>æ–‡ä»¶ä¸­æœ‰ä¸‰ç§ç±»å‹çš„å‡½æ•°ï¼Œå•å…ƒæµ‹è¯•å‡½æ•°ã€åŸºå‡†æµ‹è¯•å‡½æ•°å’Œç¤ºä¾‹å‡½æ•°ã€‚</p><table><thead><tr><th>ç±»å‹</th><th>æ ¼å¼</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>æµ‹è¯•å‡½æ•°</td><td>å‡½æ•°åå‰ç¼€ä¸ºTest</td><td>æµ‹è¯•ç¨‹åºçš„ä¸€äº›é€»è¾‘è¡Œä¸ºæ˜¯å¦æ­£ç¡®</td></tr><tr><td>åŸºå‡†å‡½æ•°</td><td>å‡½æ•°åå‰ç¼€ä¸ºBenchmark</td><td>æµ‹è¯•å‡½æ•°çš„æ€§èƒ½</td></tr><tr><td>ç¤ºä¾‹å‡½æ•°</td><td>å‡½æ•°åå‰ç¼€ä¸ºExample</td><td>ä¸ºæ–‡æ¡£æä¾›ç¤ºä¾‹æ–‡æ¡£</td></tr></tbody></table><h3 id="å•æµ‹å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å•æµ‹å‡½æ•°" aria-hidden="true">#</a> å•æµ‹å‡½æ•°</h3><p>æ¯ä¸ªæµ‹è¯•å‡½æ•°å¿…é¡»å¯¼å…¥<code>testing</code>åŒ…ï¼Œæµ‹è¯•å‡½æ•°çš„åŸºæœ¬æ ¼å¼ï¼ˆç­¾åï¼‰å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_Name</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­å‚æ•°tæ˜¯ç”¨äºæŠ¥å‘Šå’Œé™„åŠ æ—¥å¿—ä¿¡æ¯çš„ä½œç”¨ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ¯ä¸ªæµ‹è¯•é€šè¿‡åéœ€è¦é€šè¿‡t.Logf()/t.Errorf()/t.Fatal()ç­‰æ–¹æ³•æŠ¥å‘Šç»“æœã€‚</li><li>ç³»åˆ—æ–¹æ³•æ¥éªŒè¯æµ‹è¯•æœŸæœ›,å¦‚t.Equal()ã€t.NotEqual()ç­‰ã€‚</li><li>å½“æ–­è¨€å¤±è´¥æ—¶,t.Fatal()/t.Error()ä¼šä½¿å½“å‰æµ‹è¯•ç›´æ¥å¤±è´¥å¹¶åœæ­¢ã€‚</li><li>tå¯¹è±¡å¯ä»¥ä¿å­˜æ¯ä¸ªæµ‹è¯•çš„è¯¦ç»†ä¿¡æ¯,å¦‚åç§°ã€æ—¶é—´ç­‰ã€‚</li></ul><p>æµ‹è¯•å‡½æ•°ç¤ºä¾‹ï¼š</p><p>é€šå¸¸æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œä¼šæœ‰å¾ˆå¤šä¸€ä¸ªä¸ªçš„å°å‡½æ•°ã€ç»“æ„ä½“ã€æ–¹æ³•ã€æ¥å£ï¼Œæ¥ç»„æˆæœ€ç»ˆä»£ç ä¾èµ–çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™äº›ç»„ä»¶éƒ½æ˜¯å¯ä»¥æœ‰ä¿éšœåœ°å¯ä»¥è¿è¡Œï¼Œå•æµ‹ï¼ˆunit testï¼‰å°±æ˜¯åˆ©ç”¨å„ç§æ–¹æ³•æµ‹è¯•å•å…ƒç»„ä»¶çš„ç¨‹åºï¼Œä»–å°†ç»“æœä¸é¢„æœŸè¾“å‡ºè¿›è¡Œæ¯”è¾ƒã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªquicksortåŒ…ï¼Œå†™å…¥quickSortå¿«æ’ç¨‹åºå‡½æ•°ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">quickSort</span><span class="token punctuation">(</span>arr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token function">separateSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">separateSort</span><span class="token punctuation">(</span>arr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span>start<span class="token punctuation">,</span>end <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token keyword">if</span> start <span class="token operator">&gt;=</span> end <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	i <span class="token operator">:=</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
	<span class="token function">separateSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start<span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token function">separateSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token comment">// é€‰å–æœ€åä¸€ä½å½“å¯¹æ¯”æ•°å­—</span>
	pivot <span class="token operator">:=</span> arr<span class="token punctuation">[</span>end<span class="token punctuation">]</span>

	<span class="token keyword">var</span> i <span class="token operator">=</span> start
	<span class="token keyword">for</span> j <span class="token operator">:=</span> start<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>i <span class="token operator">==</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// äº¤æ¢ä½ç½® 	</span>
				arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
			i<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>end<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

	<span class="token keyword">return</span> i	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€åœ¨å¯¹åº”çš„åŒ…ä¸‹åˆ›å»ºä¸€ä¸ªquicksort_test.goæµ‹è¯•æ–‡ä»¶ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªæµ‹è¯•å‡½æ•°ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// quicksort_test.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;reflect&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_QuickSort</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	got <span class="token operator">:=</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// ç¨‹åºè¾“å‡ºçš„ç»“æœ</span>
	want <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span>           <span class="token comment">// æœŸæœ›çš„ç»“æœ</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>want<span class="token punctuation">,</span> got<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment">// å› ä¸ºsliceä¸èƒ½æ¯”è¾ƒç›´æ¥ï¼Œå€ŸåŠ©åå°„åŒ…ä¸­çš„æ–¹æ³•æ¯”è¾ƒ</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;expected:%v, got:%v&quot;</span><span class="token punctuation">,</span> want<span class="token punctuation">,</span> got<span class="token punctuation">)</span> <span class="token comment">// æµ‹è¯•å¤±è´¥è¾“å‡ºé”™è¯¯æç¤º</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶åŒ…ä¸‹çš„æ–‡ä»¶:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ls <span class="token operator">-</span>l                 
total <span class="token number">24</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span>  <span class="token number">1</span> lixin  staff   <span class="token number">26</span> Aug <span class="token number">21</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">42</span> <span class="token keyword">go</span><span class="token punctuation">.</span>mod
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span>  <span class="token number">1</span> lixin  staff  <span class="token number">590</span> Aug <span class="token number">21</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">42</span> quicksort<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span>  <span class="token number">1</span> lixin  staff  <span class="token number">428</span> Aug <span class="token number">21</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">44</span> quicksort_test<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨quicksortåŒ…ç›®å½•ä¸‹æ‰§è¡Œ<code>go test å‘½ä»¤</code>ï¼Œç»“æœ:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go$ <span class="token keyword">go</span> test              
PASS
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>337s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æ„Ÿè§‰ä¸å¤ªå¤Ÿï¼Œæˆ‘ä»¬å†å†™ä¸€ä¸ª:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_partition</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	got <span class="token operator">:=</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token comment">// ç¨‹åºè¾“å‡ºçš„ç»“æœ</span>
	want <span class="token operator">:=</span> <span class="token number">2</span>                                             <span class="token comment">// æœŸæœ›çš„ç»“æœ</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>want<span class="token punctuation">,</span> got<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;expected:%v, got:%v&quot;</span><span class="token punctuation">,</span> want<span class="token punctuation">,</span> got<span class="token punctuation">)</span> <span class="token comment">// æµ‹è¯•å¤±è´¥è¾“å‡ºé”™è¯¯æç¤º</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥ä¸º<code>go test</code>å‘½ä»¤æ·»åŠ <code>-v</code>å‚æ•°ï¼ŒæŸ¥çœ‹æµ‹è¯•å‡½æ•°åç§°å’Œè¿è¡Œæ—¶é—´ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>v
<span class="token operator">==</span><span class="token operator">=</span> RUN   Test_QuickSort
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> Test_QuickSort <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   Test_partition
    quicksort_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span> expected<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> got<span class="token punctuation">:</span><span class="token number">2</span>
<span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> Test_partition <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
FAIL
exit status <span class="token number">1</span>
FAIL    quicksort       <span class="token number">0</span><span class="token punctuation">.</span>319s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ¬¡æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçœ‹åˆ° <code>Test_partition</code> è¿™ä¸ªå‡½æ•°å•æµ‹ç”¨ä¾‹æ²¡æœ‰æˆåŠŸï¼Œè¿˜å¯ä»¥å† go test ååŠ runå‚æ•°ï¼Œå®ƒå¯¹åº”ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œåªæœ‰è·Ÿå‡½æ•°åå¯¹çš„ä¸Šçš„æ‰ä¼šè¢« go test æ‰§è¡Œ</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>v <span class="token operator">-</span>run<span class="token operator">=</span>Sort
<span class="token operator">==</span><span class="token operator">=</span> RUN   Test_QuickSort
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> Test_QuickSort <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
PASS
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>436s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æµ‹è¯•ç»„" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•ç»„" aria-hidden="true">#</a> æµ‹è¯•ç»„</h3><p>é€šå¸¸æˆ‘ä»¬å†™å•æµ‹ç”¨ä¾‹ä¸ä¼šåªå†™ä¸€ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸ä¼šä¸€ä¸ªä¸€ä¸ªå»å†™å•æµ‹ç”¨ä¾‹ï¼Œè€Œæ˜¯ç”¨ut groupçš„å½¢å¼å»å†™, æ¯”å¦‚è¿™æ ·:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_QuickSort</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> args <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		input <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token punctuation">}</span>

	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name <span class="token builtin">string</span>
		args args
		want <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span>
			args<span class="token punctuation">:</span> args<span class="token punctuation">{</span>
				input<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			want<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;test success&quot;</span><span class="token punctuation">,</span>
			args<span class="token punctuation">:</span> args<span class="token punctuation">{</span>
				input<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			want<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> got <span class="token operator">:=</span> <span class="token function">quickSort</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>args<span class="token punctuation">.</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>got<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>want<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;quickSort() = %v, want %v&quot;</span><span class="token punctuation">,</span> got<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>want<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æµ‹è¯•è¦†ç›–ç‡" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•è¦†ç›–ç‡" aria-hidden="true">#</a> æµ‹è¯•è¦†ç›–ç‡</h3><p>Goæä¾›å†…ç½®åŠŸèƒ½æ¥æ£€æŸ¥ä½ çš„ä»£ç è¦†ç›–ç‡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>go test -cover</code>æ¥æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡ã€‚ä¾‹å¦‚ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>cover
PASS
coverage<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token operator">%</span> of statements
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>331s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Goè¿˜é¢å¤–æä¾›ä¸€ä¸ª-coverprofileå‚æ•°ï¼Œå¯ä»¥å°†ç›¸å…³ä¿¡æ¯è¾“å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œgo tool cover -html=c.outæ‰“å¼€:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>cover <span class="token operator">-</span>coverprofile<span class="token operator">=</span>c<span class="token punctuation">.</span>out
PASS
coverage<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token operator">%</span> of statements
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>263s
âœ  demo_ut_go <span class="token keyword">go</span> tool cover <span class="token operator">-</span>html<span class="token operator">=</span>c<span class="token punctuation">.</span>out
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/04f135b1-a740-4274-b9f4-7697fcb8bed3/Untitled.png" alt="Untitled" tabindex="0" loading="lazy"><figcaption>Untitled</figcaption></figure><p>ç»¿è‰²è¡¨ç¤ºè¯­å¥è¢«è¦†ç›–äº†ï¼Œè€Œçº¢è‰²è¡¨ç¤ºæ²¡æœ‰</p><h3 id="åŸºå‡†æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#åŸºå‡†æµ‹è¯•" aria-hidden="true">#</a> <strong>åŸºå‡†æµ‹è¯•</strong></h3><p>åŸºå‡†æµ‹è¯•ä¿—ç§°å‹æµ‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Benchmark_Name</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºå‡†æµ‹è¯•ä»¥<code>Benchmark</code>ä¸ºå‰ç¼€ï¼Œéœ€è¦ä¸€ä¸ª<code>*testing.B</code>ç±»å‹çš„å‚æ•°bï¼ŒåŸºå‡†æµ‹è¯•å¿…é¡»è¦æ‰§è¡Œ<code>b.N</code>æ¬¡ï¼Œè¿™æ ·çš„æµ‹è¯•æ‰æœ‰å¯¹ç…§æ€§ï¼Œ<code>b.N</code>çš„å€¼æ˜¯ç³»ç»Ÿæ ¹æ®å®é™…æƒ…å†µå»è°ƒæ•´çš„ï¼Œä»è€Œä¿è¯æµ‹è¯•çš„ç¨³å®šæ€§ã€‚</p><p>æˆ‘ä»¬ä¸ºä¸Šè¿°çš„quickSortåŒ…æä¾›å‹æµ‹å¦‚ä¸‹:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Benchmark_quickSort</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºå‡†æµ‹è¯•ä¸ä¼šé»˜è®¤æ‰§è¡Œï¼Œéœ€è¦åŠ -benchå‚æ•°:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>bench<span class="token operator">=</span>quick              
goos<span class="token punctuation">:</span> darwin
goarch<span class="token punctuation">:</span> arm64
pkg<span class="token punctuation">:</span> quicksort
Benchmark_quickSort<span class="token operator">-</span><span class="token number">10</span>          <span class="token number">24164910</span>                <span class="token number">49.55</span> ns<span class="token operator">/</span>op
PASS
ok      quicksort       <span class="token number">2</span><span class="token punctuation">.</span>673s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Benchmark_quickSort-10è¡¨ç¤ºå¯¹quickSortå‡½æ•°è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œ10è¡¨ç¤ºGOMAXPROCSçš„å€¼ï¼Œè¿™å¯¹å…µæ³•åŸºå‡†æµ‹è¯•éå¸¸é‡è¦ï¼Œ24164910å’Œ49.55 ns/opè¡¨ç¤º24164910æ¬¡è°ƒç”¨è€—æ—¶å¹³å‡å€¼ä¸º49.55 nsã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºåŸºå‡†æµ‹è¯•æ·»åŠ <code>-benchmem</code>å‚æ•°ï¼Œæ¥è·å¾—å†…å­˜åˆ†é…çš„ç»Ÿè®¡æ•°æ®ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>bench<span class="token operator">=</span>quick <span class="token operator">-</span>benchmem 
goos<span class="token punctuation">:</span> darwin
goarch<span class="token punctuation">:</span> arm64
pkg<span class="token punctuation">:</span> quicksort
Benchmark_quickSort<span class="token operator">-</span><span class="token number">10</span>          <span class="token number">24359230</span>                <span class="token number">49.65</span> ns<span class="token operator">/</span>op            <span class="token number">0</span> B<span class="token operator">/</span>op          <span class="token number">0</span> allocs<span class="token operator">/</span>op
PASS
ok      quicksort       <span class="token number">2</span><span class="token punctuation">.</span>429s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œ<code>0 B/op</code>è¡¨ç¤ºæ¯æ¬¡æ“ä½œå†…å­˜åˆ†é…äº†0å­—èŠ‚ ,<code>0 allocs/op</code>åˆ™è¡¨ç¤ºæ¯æ¬¡æ“ä½œè¿›è¡Œäº†0æ¬¡å†…å­˜åˆ†é…ã€‚</p><h2 id="ç½‘ç»œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œæµ‹è¯•" aria-hidden="true">#</a> ç½‘ç»œæµ‹è¯•</h2><p>ä¹‹å‰çš„ç¯‡å¹…ï¼Œæˆ‘ä»¬è®²äº†å•å…ƒæµ‹è¯•å’ŒåŸºç¡€æµ‹è¯•ï¼Œä½†æ˜¯åœ¨å®é™…ä¸šåŠ¡ä¸­åœºæ™¯ä¼šéå¸¸å¤æ‚ï¼Œæ— è®ºæ˜¯serverç«¯å¯¹å¤–æä¾›æœåŠ¡è¿˜æ˜¯æˆ‘ä»¬ä¾èµ–å…¶ä»–äººçš„æœåŠ¡ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä¸æƒ³åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å»çœŸæ­£å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œè¿™ä¸€éƒ¨åˆ†å°±æ¥ä»‹ç»ä¸¤ç§æ–¹æ³•æ¥mockç½‘ç»œæµ‹è¯•:</p><h3 id="httptest" tabindex="-1"><a class="header-anchor" href="#httptest" aria-hidden="true">#</a> <strong>httptest</strong></h3><p>åœ¨Webå¼€å‘åœºæ™¯ä¸‹çš„å•å…ƒæµ‹è¯•ï¼Œå¦‚æœæ¶‰åŠåˆ°HTTPè¯·æ±‚æ¨èå¤§å®¶ä½¿ç”¨Goæ ‡åº“Â <code>net/http/httptest</code>Â è¿›è¡Œæµ‹è¯•ï¼Œèƒ½å¤Ÿæ˜¾è‘—æé«˜æµ‹è¯•æ•ˆç‡ã€‚</p><p>åœ¨è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬ä»¥å¸¸è§çš„ginæ¡†æ¶ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä¸ºhttp serverç¼–å†™å•å…ƒæµ‹è¯•ã€‚</p><p>å‡è®¾æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘æ˜¯æ­å»ºä¸€ä¸ªhttp serverç«¯ï¼Œå¯¹å¤–æä¾›HTTPæœåŠ¡ã€‚æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª<code>helloHandler</code>å‡½æ•°ï¼Œç”¨æ¥å¤„ç†ç”¨æˆ·è¯·æ±‚ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// gin.go</span>
<span class="token keyword">package</span> httptest_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>

	<span class="token string">&quot;github.com/gin-gonic/gin&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// Param è¯·æ±‚å‚æ•°</span>
<span class="token keyword">type</span> Param <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span> <span class="token string">`json:&quot;name&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// helloHandler /helloè¯·æ±‚å¤„ç†å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">helloHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> p Param
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
			<span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;we need a name&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
		<span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;hello %s&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// SetupRouter è·¯ç”±</span>
<span class="token keyword">func</span> <span class="token function">SetupRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">,</span> helloHandler<span class="token punctuation">)</span>
	<span class="token keyword">return</span> router
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	r <span class="token operator">:=</span> <span class="token function">SetupRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;:8080&quot;</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ç›´æ¥è¿è¡Œè¿™ä¸ªå‡½æ•°, å‘ç”Ÿcurlç½‘ç»œè¯·æ±‚:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go curl  <span class="token operator">-</span>X POST &#39;http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>hello<span class="token char">&#39; -d &#39;</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;lixin&quot;</span><span class="token punctuation">}</span>&#39;
<span class="token punctuation">{</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;hello lixin&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸º<code>helloHandler</code>å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>httptest</code>è¿™ä¸ªå·¥å…·mockä¸€ä¸ªHTTPè¯·æ±‚å’Œå“åº”è®°å½•å™¨ï¼Œè®©æˆ‘ä»¬çš„serverç«¯æ¥æ”¶å¹¶å¤„ç†æˆ‘ä»¬mockçš„HTTPè¯·æ±‚ï¼ŒåŒæ—¶ä½¿ç”¨å“åº”è®°å½•å™¨æ¥è®°å½•serverç«¯è¿”å›çš„å“åº”å†…å®¹ã€‚</p><p>å•å…ƒæµ‹è¯•çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// gin_test.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/json&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;net/http/httptest&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;testing&quot;</span>

	<span class="token string">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_helloHandler</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// å®šä¹‰ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹</span>
	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name   <span class="token builtin">string</span>
		param  <span class="token builtin">string</span>
		expect <span class="token builtin">string</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span><span class="token string">&quot;base case&quot;</span><span class="token punctuation">,</span> <span class="token string">`{&quot;name&quot;: &quot;yanglixin&quot;}`</span><span class="token punctuation">,</span> <span class="token string">&quot;hello yanglixin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span><span class="token string">&quot;bad case&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;we need a name&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	r <span class="token operator">:=</span> <span class="token function">SetupRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// mockä¸€ä¸ªHTTPè¯·æ±‚</span>
			req <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>
				<span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>                      <span class="token comment">// è¯·æ±‚æ–¹æ³•</span>
				<span class="token string">&quot;/hello&quot;</span><span class="token punctuation">,</span>                    <span class="token comment">// è¯·æ±‚URL</span>
				strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>param<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// è¯·æ±‚å‚æ•°</span>
			<span class="token punctuation">)</span>
			<span class="token comment">// mockä¸€ä¸ªå“åº”è®°å½•å™¨</span>
			w <span class="token operator">:=</span> httptest<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// è®©serverç«¯å¤„ç†mockè¯·æ±‚å¹¶è®°å½•è¿”å›çš„å“åº”å†…å®¹</span>
			r<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
			<span class="token comment">// æ ¡éªŒçŠ¶æ€ç æ˜¯å¦ç¬¦åˆé¢„æœŸ</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> w<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
			<span class="token comment">// è§£æå¹¶æ£€éªŒå“åº”å†…å®¹æ˜¯å¦å¤åˆé¢„æœŸ</span>
			<span class="token keyword">var</span> resp <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
			err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>expect<span class="token punctuation">,</span> resp<span class="token punctuation">[</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼ŒæŸ¥çœ‹æµ‹è¯•ç»“æœã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>v <span class="token operator">-</span>run<span class="token operator">=</span>Test_helloHandler    
<span class="token operator">==</span><span class="token operator">=</span> RUN   Test_helloHandler
<span class="token punctuation">[</span>GIN<span class="token operator">-</span>debug<span class="token punctuation">]</span> <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> Creating an Engine instance with the Logger and Recovery middleware already attached<span class="token punctuation">.</span>

<span class="token punctuation">[</span>GIN<span class="token operator">-</span>debug<span class="token punctuation">]</span> <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> Running in <span class="token string">&quot;debug&quot;</span> mode<span class="token punctuation">.</span> Switch to <span class="token string">&quot;release&quot;</span> mode in production<span class="token punctuation">.</span>
 <span class="token operator">-</span> using env<span class="token punctuation">:</span>   export GIN_MODE<span class="token operator">=</span>release
 <span class="token operator">-</span> using code<span class="token punctuation">:</span>  gin<span class="token punctuation">.</span><span class="token function">SetMode</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>ReleaseMode<span class="token punctuation">)</span>

<span class="token punctuation">[</span>GIN<span class="token operator">-</span>debug<span class="token punctuation">]</span> POST   <span class="token operator">/</span>hello                    <span class="token operator">--</span><span class="token operator">&gt;</span> quicksort<span class="token punctuation">.</span>helloHandler <span class="token punctuation">(</span><span class="token number">3</span> handlers<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   Test_helloHandler<span class="token operator">/</span>base_case
<span class="token punctuation">[</span>GIN<span class="token punctuation">]</span> <span class="token number">2023</span><span class="token operator">/</span><span class="token number">08</span><span class="token operator">/</span><span class="token number">21</span> <span class="token operator">-</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">:</span><span class="token number">45</span> <span class="token operator">|</span> <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">297.625</span>Âµs <span class="token operator">|</span>       <span class="token number">192.0</span><span class="token number">.2</span><span class="token number">.1</span> <span class="token operator">|</span> POST     <span class="token string">&quot;/hello&quot;</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   Test_helloHandler<span class="token operator">/</span>bad_case
<span class="token punctuation">[</span>GIN<span class="token punctuation">]</span> <span class="token number">2023</span><span class="token operator">/</span><span class="token number">08</span><span class="token operator">/</span><span class="token number">21</span> <span class="token operator">-</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">:</span><span class="token number">45</span> <span class="token operator">|</span> <span class="token number">200</span> <span class="token operator">|</span>       <span class="token number">4.291</span>Âµs <span class="token operator">|</span>       <span class="token number">192.0</span><span class="token number">.2</span><span class="token number">.1</span> <span class="token operator">|</span> POST     <span class="token string">&quot;/hello&quot;</span>
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> Test_helloHandler <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
    <span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> Test_helloHandler<span class="token operator">/</span>base_case <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
    <span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> Test_helloHandler<span class="token operator">/</span>bad_case <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
PASS
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>651s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å°±æ˜¯httpteståœ¨HTTP ServeræœåŠ¡ä¸­ä¸ºè¯·æ±‚å¤„ç†å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•çš„ç”¨ä¾‹äº†ã€‚</p><h3 id="gock" tabindex="-1"><a class="header-anchor" href="#gock" aria-hidden="true">#</a> <strong>gock</strong></h3><p>ä¸Šé¢çš„ç¤ºä¾‹ä»‹ç»äº†å¦‚ä½•åœ¨HTTP ServeræœåŠ¡ç±»åœºæ™¯ä¸‹ä¸ºè¯·æ±‚å¤„ç†å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æ˜¯åœ¨ä»£ç ä¸­è¯·æ±‚å¤–éƒ¨APIçš„åœºæ™¯ï¼ˆæ¯”å¦‚é€šè¿‡APIè°ƒç”¨å…¶ä»–æœåŠ¡è·å–è¿”å›å€¼ï¼‰åˆè¯¥æ€ä¹ˆç¼–å†™å•å…ƒæµ‹è¯•å‘¢ï¼Ÿ</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œä¾èµ–å¤–éƒ¨APIï¼š<code>http://qiniu.com/post</code>æä¾›çš„æ•°æ®ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;encoding/json&quot;</span>
	<span class="token string">&quot;io/ioutil&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// api.go</span>

<span class="token comment">// ReqParam APIè¯·æ±‚å‚æ•°</span>
<span class="token keyword">type</span> ReqParam <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	X <span class="token builtin">int</span> <span class="token string">`json:&quot;x&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// Result APIè¿”å›ç»“æœ</span>
<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Value <span class="token builtin">int</span> <span class="token string">`json:&quot;value&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetResultByAPI</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	p <span class="token operator">:=</span> <span class="token operator">&amp;</span>ReqParam<span class="token punctuation">{</span>X<span class="token punctuation">:</span> x<span class="token punctuation">}</span>
	b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>

	<span class="token comment">// è°ƒç”¨å…¶ä»–æœåŠ¡çš„API</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://qiniu.com/post&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
		bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>
	body<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">var</span> ret Result
	<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// è¿™é‡Œæ˜¯å¯¹APIè¿”å›çš„æ•°æ®åšä¸€äº›é€»è¾‘å¤„ç†</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">.</span>Value <span class="token operator">+</span> y
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å¯¹ç±»ä¼¼ä¸Šè¿°è¿™ç±»ä¸šåŠ¡ä»£ç ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¦‚æœä¸æƒ³åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­çœŸæ­£å»å‘é€è¯·æ±‚æˆ–è€…ä¾èµ–çš„å¤–éƒ¨æ¥å£è¿˜æ²¡æœ‰å¼€å‘å®Œæˆæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å•å…ƒæµ‹è¯•ä¸­å¯¹ä¾èµ–çš„APIè¿›è¡Œmockã€‚</p><p>ä½¿ç”¨<code>gock</code>å¯¹å¤–éƒ¨APIè¿›è¡Œmockï¼Œå³mockæŒ‡å®šå‚æ•°è¿”å›çº¦å®šå¥½çš„å“åº”å†…å®¹ã€‚ ä¸‹é¢çš„ä»£ç ä¸­mockäº†ä¸¤ç»„æ•°æ®ï¼Œç»„æˆäº†ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// api_test.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;testing&quot;</span>

	<span class="token string">&quot;github.com/stretchr/testify/assert&quot;</span>
	<span class="token string">&quot;gopkg.in/h2non/gock.v1&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestGetResultByAPI</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> gock<span class="token punctuation">.</span><span class="token function">Off</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æµ‹è¯•æ‰§è¡Œååˆ·æ–°æŒ‚èµ·çš„mock</span>

	<span class="token comment">// mock è¯·æ±‚å¤–éƒ¨apiæ—¶ä¼ å‚x=1è¿”å›100</span>
	gock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;http://qiniu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">&quot;/post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">MatchType</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">JSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Reply</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">JSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// è°ƒç”¨æˆ‘ä»¬çš„ä¸šåŠ¡å‡½æ•°</span>
	res <span class="token operator">:=</span> <span class="token function">GetResultByAPI</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token comment">// æ ¡éªŒè¿”å›ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ</span>
	assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span>

	<span class="token comment">// mock è¯·æ±‚å¤–éƒ¨apiæ—¶ä¼ å‚x=2è¿”å›200</span>
	gock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;http://qiniu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">&quot;/post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">MatchType</span><span class="token punctuation">(</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">JSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Reply</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">JSON</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// è°ƒç”¨æˆ‘ä»¬çš„ä¸šåŠ¡å‡½æ•°</span>
	res <span class="token operator">=</span> <span class="token function">GetResultByAPI</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token comment">// æ ¡éªŒè¿”å›ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ</span>
	assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">)</span>

	assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> gock<span class="token punctuation">.</span><span class="token function">IsDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// æ–­è¨€mockè¢«è§¦å‘</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œä¸Šé¢å†™å¥½çš„å•å…ƒæµ‹è¯•ï¼Œçœ‹ä¸€ä¸‹æµ‹è¯•ç»“æœã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>âœ  demo_ut_go   go <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-run</span><span class="token operator">=</span>TestGetResultByAPI
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestGetResultByAPI
--- PASS: TestGetResultByAPI <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      quicksort       <span class="token number">0</span>.582s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æµ‹è¯•ç»“æœå’Œé¢„æœŸçš„å®Œå…¨ä¸€è‡´ã€‚</p><h2 id="mysqlå’Œrediså•æµ‹" tabindex="-1"><a class="header-anchor" href="#mysqlå’Œrediså•æµ‹" aria-hidden="true">#</a> MySQLå’ŒRediså•æµ‹</h2><p>æˆ‘ä»¬åœ¨ä¸Šä¸€éƒ¨åˆ†ä»‹ç»äº†httptestå’Œgockå·¥å…·è¿›è¡Œç½‘ç»œæµ‹è¯•ï¼Œé™¤äº†ç½‘ç»œä¾èµ–ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸­ä¹Ÿä¼šç»å¸¸ç”¨åˆ°å„ç§æ•°æ®åº“ï¼Œæ¯”å¦‚å¸¸è§çš„MySQLå’ŒRedisç­‰ã€‚æœ¬éƒ¨åˆ†å°±åˆ†åˆ«ä¸¾ä¾‹æ¥æ¼”ç¤ºå¦‚ä½•åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™å¯¹MySQLå’ŒRedisè¿›è¡Œmockã€‚</p><h3 id="go-sqlmock" tabindex="-1"><a class="header-anchor" href="#go-sqlmock" aria-hidden="true">#</a> <strong>go-sqlmock</strong></h3><p><a href="https://github.com/DATA-DOG/go-sqlmock" target="_blank" rel="noopener noreferrer">sqlmock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>Â æ˜¯ä¸€ä¸ªå®ç°Â <code>sql/driver</code>Â çš„mockåº“ã€‚å®ƒä¸éœ€è¦å»ºç«‹çœŸæ­£çš„æ•°æ®åº“è¿æ¥å°±å¯ä»¥åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿä»»ä½• sql é©±åŠ¨ç¨‹åºçš„è¡Œä¸ºã€‚ä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™mock sqlè¯­å¥çš„æ‰§è¡Œç»“æœã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å®‰è£…</span>
<span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>DATA<span class="token operator">-</span>DOG<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>sqlmock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>go-sqlmock</code>å®˜æ–¹æ–‡æ¡£ä¸­æä¾›çš„åŸºç¡€ç¤ºä¾‹ä»£ç ã€‚ åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ª<code>recordStats</code>å‡½æ•°ç”¨æ¥è®°å½•ç”¨æˆ·æµè§ˆå•†å“æ—¶äº§ç”Ÿçš„ç›¸å…³æ•°æ®ã€‚å…·ä½“å®ç°çš„åŠŸèƒ½æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡Œä»¥ä¸‹ä¸¤æ¬¡SQLæ“ä½œï¼š</p><ul><li><p>åœ¨<code>products</code>è¡¨ä¸­å°†å½“å‰å•†å“çš„æµè§ˆæ¬¡æ•°+1</p></li><li><p>åœ¨<code>product_viewers</code>è¡¨ä¸­è®°å½•æµè§ˆå½“å‰å•†å“çš„ç”¨æˆ·id</p></li></ul><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// app.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;database/sql&quot;</span>

<span class="token comment">// recordStats è®°å½•ç”¨æˆ·æµè§ˆäº§å“ä¿¡æ¯</span>
<span class="token keyword">func</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> productID <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// å¼€å¯äº‹åŠ¡</span>
	<span class="token comment">// æ“ä½œviewså’Œproduct_viewersä¸¤å¼ è¡¨</span>
	tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// æ›´æ–°productsè¡¨</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE products SET views = views + 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// product_viewersè¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>
		<span class="token string">&quot;INSERT INTO product_viewers (user_id, product_id) VALUES (?, ?)&quot;</span><span class="token punctuation">,</span>
		userID<span class="token punctuation">,</span> productID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// æ³¨æ„ï¼šæµ‹è¯•çš„è¿‡ç¨‹ä¸­å¹¶ä¸éœ€è¦çœŸæ­£çš„è¿æ¥</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root@/blog&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// userIDä¸º1çš„ç”¨æˆ·æµè§ˆäº†productIDä¸º5çš„äº§å“</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/*some user id*/</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token comment">/*some product id*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸ºä»£ç ä¸­çš„<code>recordStats</code>å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯åˆä¸æƒ³åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­è¿æ¥çœŸå®çš„æ•°æ®åº“è¿›è¡Œæµ‹è¯•ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥åƒä¸‹é¢ç¤ºä¾‹ä»£ç ä¸­é‚£æ ·ä½¿ç”¨<code>sqlmock</code>å·¥å…·å»mockæ•°æ®åº“æ“ä½œã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;testing&quot;</span>

	<span class="token string">&quot;github.com/DATA-DOG/go-sqlmock&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// TestShouldUpdateStats sqlæ‰§è¡ŒæˆåŠŸçš„æµ‹è¯•ç”¨ä¾‹</span>
<span class="token keyword">func</span> <span class="token function">TestShouldUpdateStats</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mockä¸€ä¸ª*sql.DBå¯¹è±¡ï¼Œä¸éœ€è¦è¿æ¥çœŸå®çš„æ•°æ®åº“</span>
	db<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;an error &#39;%s&#39; was not expected when opening a stub database connection&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// mockæ‰§è¡ŒæŒ‡å®šSQLè¯­å¥æ—¶çš„è¿”å›ç»“æœ</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnResult</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">NewResult</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO product_viewers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnResult</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">NewResult</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// å°†mockçš„DBå¯¹è±¡ä¼ å…¥æˆ‘ä»¬çš„å‡½æ•°ä¸­</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error was not expected while updating stats: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ç¡®ä¿æœŸæœ›çš„ç»“æœéƒ½æ»¡è¶³</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;there were unfulfilled expectations: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// TestShouldRollbackStatUpdatesOnFailure sqlæ‰§è¡Œå¤±è´¥å›æ»šçš„æµ‹è¯•ç”¨ä¾‹</span>
<span class="token keyword">func</span> <span class="token function">TestShouldRollbackStatUpdatesOnFailure</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;an error &#39;%s&#39; was not expected when opening a stub database connection&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	mock<span class="token punctuation">.</span><span class="token function">ExpectBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnResult</span><span class="token punctuation">(</span>sqlmock<span class="token punctuation">.</span><span class="token function">NewResult</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO product_viewers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WithArgs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">WillReturnError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;some error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// now we execute our method</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">recordStats</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;was expecting an error, but there was none&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// we make sure that all expectations were met</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> mock<span class="token punctuation">.</span><span class="token function">ExpectationsWereMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;there were unfulfilled expectations: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªæ‰§è¡ŒæˆåŠŸçš„æµ‹è¯•ç”¨ä¾‹å’Œä¸€ä¸ªæ‰§è¡Œå¤±è´¥å›æ»šçš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿æˆ‘ä»¬ä»£ç ä¸­çš„æ¯ä¸ªé€»è¾‘åˆ†æ”¯éƒ½èƒ½è¢«æµ‹è¯•åˆ°ï¼Œæé«˜å•å…ƒæµ‹è¯•è¦†ç›–ç‡çš„åŒæ—¶ä¹Ÿä¿è¯äº†ä»£ç çš„å¥å£®æ€§ã€‚</p><p>æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œçœ‹ä¸€ä¸‹æœ€ç»ˆçš„æµ‹è¯•ç»“æœã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>v <span class="token operator">-</span>run<span class="token operator">=</span>TestShould
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestShouldUpdateStats
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> TestShouldUpdateStats <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestShouldRollbackStatUpdatesOnFailure
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> TestShouldRollbackStatUpdatesOnFailure <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
PASS
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>624s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ç»“æœéƒ½ç¬¦åˆé¢„æœŸï¼Œå•å…ƒæµ‹è¯•é€šè¿‡ã€‚</p><p>åœ¨å¾ˆå¤šä½¿ç”¨ORMå·¥å…·çš„åœºæ™¯ä¸‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>go-sqlmock</code>åº“mockæ•°æ®åº“æ“ä½œè¿›è¡Œæµ‹è¯•ã€‚</p><h3 id="miniredis" tabindex="-1"><a class="header-anchor" href="#miniredis" aria-hidden="true">#</a> <strong>miniredis</strong></h3><p>é™¤äº†ç»å¸¸ç”¨åˆ°MySQLå¤–ï¼ŒRedisåœ¨æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿä¼šç»å¸¸ç”¨åˆ°ã€‚æ¥ä¸‹æ¥çš„è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†ä¸€èµ·å­¦ä¹ å¦‚ä½•åœ¨å•å…ƒæµ‹è¯•ä¸­mock Redisçš„ç›¸å…³æ“ä½œã€‚</p><p><a href="https://github.com/alicebob/miniredis" target="_blank" rel="noopener noreferrer">miniredis<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ˜¯ä¸€ä¸ªçº¯goå®ç°çš„ç”¨äºå•å…ƒæµ‹è¯•çš„redis serverã€‚å®ƒæ˜¯ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ã€åŸºäºå†…å­˜çš„redisæ›¿ä»£å“ï¼Œå®ƒå…·æœ‰çœŸæ­£çš„TCPæ¥å£ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“æˆæ˜¯redisç‰ˆæœ¬çš„<code>net/http/httptest</code>ã€‚</p><p>å½“æˆ‘ä»¬ä¸ºä¸€äº›åŒ…å«Redisæ“ä½œçš„ä»£ç ç¼–å†™å•å…ƒæµ‹è¯•æ—¶å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥mock Redisæ“ä½œã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å®‰è£…. è¿™é‡Œä»¥github.com/go-redis/redisåº“ä¸ºä¾‹ï¼Œç¼–å†™äº†ä¸€ä¸ªåŒ…å«è‹¥å¹²Redisæ“ä½œçš„DoSomethingWithRediså‡½æ•°ã€‚</span>
<span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>alicebob<span class="token operator">/</span>miniredis<span class="token operator">/</span>v2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>// redis_op.go
package main

<span class="token function">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>

	<span class="token string">&quot;github.com/go-redis/redis/v8&quot;</span> // æ³¨æ„å¯¼å…¥ç‰ˆæœ¬
<span class="token punctuation">)</span>

const <span class="token punctuation">(</span>
	KeyValidWebsite <span class="token operator">=</span> <span class="token string">&quot;app:valid:website:list&quot;</span>
<span class="token punctuation">)</span>

func DoSomethingWithRedis<span class="token punctuation">(</span>rdb *redis.Client, key string<span class="token punctuation">)</span> bool <span class="token punctuation">{</span>
	// è¿™é‡Œå¯ä»¥æ˜¯å¯¹redisæ“ä½œçš„ä¸€äº›é€»è¾‘
	ctx :<span class="token operator">=</span> context.TODO<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>rdb.SIsMember<span class="token punctuation">(</span>ctx, KeyValidWebsite, key<span class="token punctuation">)</span>.<span class="token function-name function">Val</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token builtin class-name">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	val, err :<span class="token operator">=</span> rdb.Get<span class="token punctuation">(</span>ctx, key<span class="token punctuation">)</span>.Result<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>
		<span class="token builtin class-name">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>strings.HasPrefix<span class="token punctuation">(</span>val, <span class="token string">&quot;https://&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		val <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span> + val
	<span class="token punctuation">}</span>
	// è®¾ç½® blog key äº”ç§’è¿‡æœŸ
	<span class="token keyword">if</span> err :<span class="token operator">=</span> rdb.Set<span class="token punctuation">(</span>ctx, <span class="token string">&quot;blog&quot;</span>, val, <span class="token number">5</span>*time.Second<span class="token punctuation">)</span>.Err<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>
		<span class="token builtin class-name">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token builtin class-name">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢çš„ä»£ç æ˜¯æˆ‘ä½¿ç”¨<code>miniredis</code>åº“ä¸º<code>DoSomethingWithRedis</code>å‡½æ•°ç¼–å†™çš„å•å…ƒæµ‹è¯•ä»£ç ï¼Œå…¶ä¸­<code>miniredis</code>ä¸ä»…æ”¯æŒmockå¸¸ç”¨çš„Redisæ“ä½œï¼Œè¿˜æä¾›äº†å¾ˆå¤šå®ç”¨çš„å¸®åŠ©å‡½æ•°ï¼Œä¾‹å¦‚æ£€æŸ¥keyçš„å€¼æ˜¯å¦ä¸é¢„æœŸç›¸ç­‰çš„<code>s.CheckGet()</code>å’Œå¸®åŠ©æ£€æŸ¥keyè¿‡æœŸæ—¶é—´çš„<code>s.FastForward()</code>ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	<span class="token comment">// redis_op_test.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>

	<span class="token string">&quot;github.com/alicebob/miniredis/v2&quot;</span>
	<span class="token string">&quot;github.com/go-redis/redis/v8&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestDoSomethingWithRedis</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mockä¸€ä¸ªredis server</span>
	s<span class="token punctuation">,</span> err <span class="token operator">:=</span> miniredis<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// å‡†å¤‡æ•°æ®</span>
	s<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;lixin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yanglixin.com&quot;</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span><span class="token function">SAdd</span><span class="token punctuation">(</span>KeyValidWebsite<span class="token punctuation">,</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// è¿æ¥mockçš„redis server</span>
	rdb <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span> s<span class="token punctuation">.</span><span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// mock redis serverçš„åœ°å€</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// è°ƒç”¨å‡½æ•°</span>
	ok <span class="token operator">:=</span> <span class="token function">DoSomethingWithRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// å¯ä»¥æ‰‹åŠ¨æ£€æŸ¥redisä¸­çš„å€¼æ˜¯å¦å¤åˆé¢„æœŸ</span>
	<span class="token keyword">if</span> got<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;blog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> got <span class="token operator">!=</span> <span class="token string">&quot;https://yanglixin.com&quot;</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;&#39;blog&#39; has the wrong value&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨å¸®åŠ©å·¥å…·æ£€æŸ¥</span>
	s<span class="token punctuation">.</span><span class="token function">CheckGet</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://yanglixin.com&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// è¿‡æœŸæ£€æŸ¥</span>
	s<span class="token punctuation">.</span><span class="token function">FastForward</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">// å¿«è¿›5ç§’</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span><span class="token string">&quot;blog&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;&#39;blog&#39; should not have existed anymore&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œæ‰§è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹å•å…ƒæµ‹è¯•ç»“æœï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>âœ  demo_ut_go <span class="token keyword">go</span> test <span class="token operator">-</span>v <span class="token operator">-</span>run<span class="token operator">=</span>TestDoSomethingWithRedis
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestDoSomethingWithRedis
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> TestDoSomethingWithRedis <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
PASS
ok      quicksort       <span class="token number">0</span><span class="token punctuation">.</span>597s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>miniredis</code>åŸºæœ¬ä¸Šæ”¯æŒç»å¤§å¤šæ•°çš„Rediså‘½ä»¤ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡æŸ¥çœ‹æ–‡æ¡£äº†è§£æ›´å¤šç”¨æ³•ã€‚</p><p>å½“ç„¶é™¤äº†ä½¿ç”¨<code>miniredis</code>æ­å»ºæœ¬åœ°redis serverè¿™ç§æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å„ç§æ‰“æ¡©å·¥å…·å¯¹å…·ä½“æ–¹æ³•è¿›è¡Œæ‰“æ¡©ã€‚åœ¨ç¼–å†™å•å…ƒæµ‹è¯•æ—¶å…·ä½“ä½¿ç”¨å“ªç§mockæ–¹å¼è¿˜æ˜¯è¦æ ¹æ®å®é™…æƒ…å†µæ¥å†³å®šã€‚</p><h2 id="gomock-æ¨¡æ‹Ÿæ¥å£è¡Œä¸º" tabindex="-1"><a class="header-anchor" href="#gomock-æ¨¡æ‹Ÿæ¥å£è¡Œä¸º" aria-hidden="true">#</a> GoMock æ¨¡æ‹Ÿæ¥å£è¡Œä¸º</h2><p>è¿™æ˜¯æˆ‘å¾ˆä¹…ä¹‹å‰åœ¨bilibiliå½•çš„è§†é¢‘GoMock è§†é¢‘ã€‚</p><p><a href="https://www.bilibili.com/video/BV1Qs4y1m7ic/?spm_id_from=333.337.search-card.all.click" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1Qs4y1m7ic/?spm_id_from=333.337.search-card.all.click<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>GoMockæ˜¯goå®˜æ–¹æä¾›çš„ä¸€æ¬¾Mockå·¥å…·ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜æ¨¡æ‹Ÿæ¥å£è¡Œä¸ºåšæµ‹è¯•çš„å·¥å…·ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªPersonæ¥å£ä¸‹çš„Eatæ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¨¡æ‹Ÿè¿™ä¸ªæ¥å£</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ctrl <span class="token operator">:=</span> gomock<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
mockPerson <span class="token operator">:=</span> mocks<span class="token punctuation">.</span><span class="token function">NewMockPerson</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span>
mockPerson<span class="token punctuation">.</span> <span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">Eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token string">&quot;lixin is sleep&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä½¿ç”¨gomockåˆ›å»ºä¸€ä¸ªmockPersonï¼Œå»æ¨¡æ‹Ÿpersonæ¥å£çš„è¡Œä¸º åç»­æ–¹ä¾¿å»åšå•æµ‹</p><p>æ‰“å¼€å®‰è£…<a href="https://github.com/golang/mock" target="_blank" rel="noopener noreferrer">https://github.com/golang/mock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">go</span> install github<span class="token punctuation">.</span>com<span class="token operator">/</span>golang<span class="token operator">/</span>mock<span class="token operator">/</span>mockgen@v1<span class="token punctuation">.</span><span class="token number">6.0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¾“å…¥mockgenæŸ¥çœ‹æ˜¯å¦ä¸‹è½½åœ¨$GOPATH/bin ç›®å½•ä¸‹åŸºæœ¬ç”¨æ³•æ­¥éª¤</p><p>é¦–å…ˆé€‰å®šä¸€ä¸ªmockçš„demoç›®å½•</p><p>æ¯”å¦‚è¯´å«gomock-learn,ç„¶ååœ¨æ­¤ç›®å½•ä¸‹åˆ›å»ºå¯¹åº”çš„modï¼Œç„¶åå¼•å…¥å¯¹åº”çš„gomockåŒ…</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">go</span> mod init gomock<span class="token operator">-</span>learn
<span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>golang<span class="token operator">/</span>mock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥åˆ›å»ºä¸¤ä¸ªç›®å½•personå’Œstudentåˆ†åˆ«ç”¨æ¥æ”¾å¯¹åº”çš„æ¥å£å’Œä»£ç ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// person.go</span>
<span class="token keyword">package</span> person

<span class="token keyword">type</span> Person <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Eat</span><span class="token punctuation">(</span>food <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Sleep</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// student.go</span>
<span class="token keyword">package</span> student

<span class="token keyword">import</span> <span class="token string">&quot;gomock-learn/person&quot;</span>

<span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	p    person<span class="token punctuation">.</span>Person
	Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Student<span class="token punctuation">)</span> <span class="token function">Eat</span><span class="token punctuation">(</span>food <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Student<span class="token punctuation">)</span> <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€ä½ è¦åˆ›å»ºä¸€ä¸ªmocksç›®å½•ï¼Œä¸ç„¶å¦‚æœæ²¡æœ‰mockç›®å½•çš„è¯ç”¨mockgenå‘½ä»¤è¡Œä¼šå¤±è´¥</p><p>ä½¿ç”¨æ–¹æ³•ï¼Œç›´æ¥åœ¨ç›¸åº”çš„ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>mockgen <span class="token operator">-</span>destination mocks<span class="token operator">/</span>mock_person<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token operator">-</span><span class="token keyword">package</span><span class="token operator">=</span>mocks gomock<span class="token operator">-</span>learn<span class="token operator">/</span>person Person
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å¿…é¡»è‡ªå·±åˆ›å»ºmocksç›®å½•å› ä¸ºGoMockä¸ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºï¼Œå½“å®ƒå‘ç°mocksç›®å½•ä¸å­˜åœ¨æ—¶ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ä»¥ä¸‹æ˜¯å¯¹mockgenå‘½ä»¤å‚æ•°çš„è¯´æ˜ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code> <span class="token operator">-</span>destination<span class="token operator">=</span>mocks<span class="token operator">/</span>mock_person<span class="token punctuation">.</span><span class="token keyword">go</span>ï¼šå°†è‡ªåŠ¨ç”Ÿæˆçš„mockä»£ç å­˜å‚¨åˆ°æ–‡ä»¶mocks<span class="token operator">/</span>mock_person<span class="token punctuation">.</span><span class="token keyword">go</span>ä¸­ã€‚<span class="token operator">-</span>

<span class="token keyword">package</span><span class="token operator">=</span>mocksï¼šå°†ç”Ÿæˆçš„mockä»£ç æ”¾ç½®åˆ°mocksåŒ…ä¸­ã€‚

gomock<span class="token operator">-</span>learn<span class="token operator">/</span>personï¼šä¸ºè¿™ä¸ªåŒ…ç”Ÿæˆmockä»£ç ã€‚

Personï¼šä¸ºè¿™ä¸ªæ¥å£ç”Ÿæˆmockä»£ç ã€‚è¿™ä¸ªå‚æ•°æ˜¯ä¸ªå¿…å¡«å‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°æŒ‡å®šè¦ç”Ÿæˆmockä»£ç çš„æ¥å£ã€‚å¦‚æœéœ€è¦æŒ‡å®šå¤šä¸ªæ¥å£ï¼Œå¯ä»¥å°†æ¥å£é€šè¿‡é€—å·è¿æ¥èµ·æ¥ï¼Œæ¯”å¦‚ï¼šPerson1<span class="token punctuation">,</span>Person2ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»“åˆgo-generateä½¿ç”¨GoMock, åœ¨å¯¹åº”çš„æ¥å£å‰åŠ å…¥æ³¨é‡Š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//go:generate mockgen -destination mocks/mock_person.go -package=mocks gomock-learn/person Person</span>

<span class="token keyword">type</span> Person <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Eat</span><span class="token punctuation">(</span>food <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Sleep</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨å¯¹åº”çš„ç›®å½•ä¸‹è¾“å…¥</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">go</span> generate <span class="token punctuation">.</span><span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¯ä»¥å‘ç°å°±åœ¨å¯¹åº”çš„mocksç›®å½•ä¸‹é‡Œæœ‰ä¸€ä¸ªmock_xx.goå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢å°±æ˜¯æˆ‘ä»¬å¯ä»¥Mockçš„æ•°æ®ã€‚</p><p>æ­¤æ—¶çš„ç›®å½•æ˜¯è¿™æ ·çš„</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>â”œâ”€â”€ <span class="token keyword">go</span><span class="token punctuation">.</span>mod
â”œâ”€â”€ <span class="token keyword">go</span><span class="token punctuation">.</span>sum
â”œâ”€â”€ mocks
â”‚   â””â”€â”€ mock_person<span class="token punctuation">.</span><span class="token keyword">go</span>
â”œâ”€â”€ person
â”‚   â””â”€â”€ person<span class="token punctuation">.</span><span class="token keyword">go</span>
â””â”€â”€ student
    â”œâ”€â”€ student<span class="token punctuation">.</span><span class="token keyword">go</span>
    â””â”€â”€ student_test<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨å‚æ•°åŒ¹é…, æœ‰æ—¶å€™ä½ å¯èƒ½ä¸å¤ªç¡®å®šè°ƒç”¨mockæ—¶æŒ‡å®šçš„å‚æ•°ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªå¯¹åº”çš„Matcheræ¥ä»£è¡¨ä¸€ä¸ªmockæ–¹æ³•å¯ä»¥æ¥å—çš„å‚æ•°èŒƒå›´ï¼Œæ¯”å¦‚gomock.Eq(x)æŒ‡å®šä¼ å…¥å€¼å¿…é¡»ç­‰äºxã€‚</p><p>ä»¥ä¸‹æ˜¯GoMockä¸­ä¸€äº›é¢„å®šä¹‰çš„matcherï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>    gomock<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼šåŒ¹é…ä»»ä½•ç±»å‹çš„ä»»ä½•å€¼
    gomock<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>ï¼šåŒ¹é…ä½¿ç”¨åå°„reflect<span class="token punctuation">.</span>DeepEqualä¸xç›¸ç­‰çš„å€¼gomock<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼šåŒ¹é…ç­‰äº<span class="token boolean">nil</span>çš„å€¼
    gomock<span class="token punctuation">.</span><span class="token function">Not</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>ï¼šï¼ˆè¿™é‡Œçš„mæ˜¯ä¸€ä¸ªMatcherï¼‰åŒ¹é…åŒmä¸åŒ¹é…çš„å€¼
    gomock<span class="token punctuation">.</span><span class="token function">Not</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>ï¼šï¼ˆè¿™é‡Œçš„xä¸æ˜¯Matcherï¼‰åŒ¹é…ä½¿ç”¨åå°„reflect<span class="token punctuation">.</span>DeepEqualä¸xä¸ç›¸ç­‰çš„å€¼
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯xï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç”¨</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>mockDoer<span class="token punctuation">.</span><span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DoSomething</span><span class="token punctuation">(</span>gomock<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello GoMock&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…·ä½“ä¾‹å­</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_Eat</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctrl <span class="token operator">:=</span> gomock<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	mockPerson <span class="token operator">:=</span> mocks<span class="token punctuation">.</span><span class="token function">NewMockPerson</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span>

	mockPerson<span class="token punctuation">.</span>
		<span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Eat</span><span class="token punctuation">(</span><span class="token string">&quot;Apple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Times</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	testStudent <span class="token operator">:=</span> Student<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> mockPerson<span class="token punctuation">}</span>
	testStudent<span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span><span class="token string">&quot;Apple&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_Sleep</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctrl <span class="token operator">:=</span> gomock<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	mockPerson <span class="token operator">:=</span> mocks<span class="token punctuation">.</span><span class="token function">NewMockPerson</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span>
	testStudent <span class="token operator">:=</span> Student<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> mockPerson<span class="token punctuation">}</span>

	mockPerson<span class="token punctuation">.</span>
		<span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token string">&quot;lixin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token string">&quot;lixin is sleep&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s is sleep!\\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> testStudent<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;lixin is sleep&quot;</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Error!!!!!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–­è¨€è°ƒç”¨é¡ºåº, æœ‰æ—¶å€™æˆ‘ä»¬æœŸæœ›æ§åˆ¶ä¸€äº›mockæµç¨‹çš„é¡ºåºï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­è°ƒç”¨Afterçš„æ–¹æ³•</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_Eat</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctrl <span class="token operator">:=</span> gomock<span class="token punctuation">.</span><span class="token function">NewController</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	mockPerson <span class="token operator">:=</span> mocks<span class="token punctuation">.</span><span class="token function">NewMockPerson</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span>

	first <span class="token operator">:=</span> mockPerson<span class="token punctuation">.</span><span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">)</span>

	mockPerson<span class="token punctuation">.</span>
		<span class="token function">EXPECT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Eat</span><span class="token punctuation">(</span><span class="token string">&quot;Apple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">After</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span>

	testStudent <span class="token operator">:=</span> Student<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">:</span> mockPerson<span class="token punctuation">}</span>
	testStudent<span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">)</span>
	testStudent<span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span><span class="token string">&quot;Apple&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŒ‡å®šmockè¡Œä¸º, æ¯”å¦‚è¯´å¯ä»¥åœ¨æ‰§è¡Œå®Œæ¯•ååŠ ä¸€ä¸ªDoå‡½æ•°å»åšä¸€äº›äº‹æƒ…ã€‚</p><h2 id="ä½¿ç”¨monkeyæ‰“æ¡©" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨monkeyæ‰“æ¡©" aria-hidden="true">#</a> <strong><strong>ä½¿ç”¨monkeyæ‰“æ¡©</strong></strong></h2><p>åœ¨è¿™ä¸€ç¯‡ä¸­æˆ‘ä»¬å°†ä»‹ç»ä¸€ä¸ªæ›´å¼ºå¤§çš„æ‰“æ¡©å·¥å…·â€”â€”<code>monkey</code>ï¼Œå®ƒæ”¯æŒä¸ºä»»æ„å‡½æ•°åŠæ–¹æ³•è¿›è¡Œæ‰“æ¡©ã€‚</p><p><a href="https://github.com/bouk/monkey" target="_blank" rel="noopener noreferrer">monkey<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ˜¯ä¸€ä¸ªGoå•å…ƒæµ‹è¯•ä¸­ååˆ†å¸¸ç”¨çš„æ‰“æ¡©å·¥å…·ï¼Œå®ƒåœ¨è¿è¡Œæ—¶é€šè¿‡æ±‡ç¼–è¯­è¨€é‡å†™å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°†ç›®æ ‡å‡½æ•°æˆ–æ–¹æ³•çš„å®ç°è·³è½¬åˆ°æ¡©å®ç°ï¼Œå…¶åŸç†ç±»ä¼¼äºçƒ­è¡¥ä¸ã€‚</p><p>monkeyåº“å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯ä½¿ç”¨æ—¶éœ€æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š</p><ul><li>monkeyä¸æ”¯æŒå†…è”å‡½æ•°ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™éœ€è¦é€šè¿‡å‘½ä»¤è¡Œå‚æ•°<code>gcflags=-l</code>å…³é—­Goè¯­è¨€çš„å†…è”ä¼˜åŒ–ã€‚</li><li>monkeyä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸è¦æŠŠå®ƒç”¨åˆ°å¹¶å‘çš„å•å…ƒæµ‹è¯•ä¸­ã€‚</li></ul><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å®‰è£…</span>
<span class="token keyword">go</span> get bou<span class="token punctuation">.</span>ke<span class="token operator">/</span>monkey
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><p>å‡è®¾ä½ ä»¬å…¬å¸ä¸­å°æä¾›äº†ä¸€ä¸ªç”¨æˆ·ä¸­å¿ƒçš„åº“<code>varys</code>ï¼Œä½¿ç”¨è¿™ä¸ªåº“å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ ¹æ®uidè·å–ç”¨æˆ·ç›¸å…³ä¿¡æ¯ã€‚ä½†æ˜¯å½“ä½ ç¼–å†™ä»£ç çš„æ—¶å€™è¿™ä¸ªåº“è¿˜æ²¡å®ç°ï¼Œæˆ–è€…è¿™ä¸ªåº“è¦ç»è¿‡å†…ç½‘è¯·æ±‚ä½†ä½ ç°åœ¨æ²¡è¿™èƒ½åŠ›ï¼Œè¿™ä¸ªæ—¶å€™è¦ä¸º<code>MyFunc</code>ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œå°±éœ€è¦åšä¸€äº›mockå·¥ä½œã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// func.go</span>
<span class="token keyword">func</span> <span class="token function">MyFunc</span><span class="token punctuation">(</span>uid <span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token builtin">string</span><span class="token punctuation">{</span>
	u<span class="token punctuation">,</span> err <span class="token operator">:=</span> varys<span class="token punctuation">.</span><span class="token function">GetInfoByUID</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;welcome&quot;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// è¿™é‡Œæ˜¯ä¸€äº›é€»è¾‘ä»£ç ...</span>

	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;hello %s\n&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä½¿ç”¨<code>monkey</code>åº“å¯¹<code>varys.GetInfoByUID</code>è¿›è¡Œæ‰“æ¡©ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// func_test.go</span>

<span class="token keyword">func</span> <span class="token function">TestMyFunc</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// å¯¹ varys.GetInfoByUID è¿›è¡Œæ‰“æ¡©</span>
	<span class="token comment">// æ— è®ºä¼ å…¥çš„uidæ˜¯å¤šå°‘ï¼Œéƒ½è¿”å› &amp;varys.UserInfo{Name: &quot;lixin&quot;}, nil</span>
	monkey<span class="token punctuation">.</span><span class="token function">Patch</span><span class="token punctuation">(</span>varys<span class="token punctuation">.</span>GetInfoByUID<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>varys<span class="token punctuation">.</span>UserInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>varys<span class="token punctuation">.</span>UserInfo<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	ret <span class="token operator">:=</span> <span class="token function">MyFunc</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼š<code>go test -run=TestMyFunc -v -gcflags=-l</code></p><p>è¾“å‡ºï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">==</span><span class="token operator">=</span> RUN   TestMyFunc
--- PASS: TestMyFunc <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      monkey_demo     <span class="token number">0</span>.009s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†å¯¹å‡½æ•°è¿›è¡Œmockå¤–<code>monkey</code>ä¹Ÿæ”¯æŒå¯¹æ–¹æ³•è¿›è¡Œmockã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// method.go</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
	Birthday <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// CalcAge è®¡ç®—ç”¨æˆ·å¹´é¾„</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">CalcAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">,</span> err <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">&quot;2006-01-02&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>Birthday<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">365</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetInfo è·å–ç”¨æˆ·ç›¸å…³ä¿¡æ¯</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">string</span><span class="token punctuation">{</span>
	age <span class="token operator">:=</span> u<span class="token punctuation">.</span><span class="token function">CalcAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> age <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%så¾ˆç¥ç§˜ï¼Œæˆ‘ä»¬è¿˜ä¸äº†è§£taã€‚&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%sä»Šå¹´%då²äº†ï¼Œtaæ˜¯æˆ‘ä»¬çš„æœ‹å‹ã€‚&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬ä¸º<code>GetInfo</code>ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™<code>CalcAge</code>æ–¹æ³•çš„åŠŸèƒ½è¿˜æœªå®Œæˆï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨monkeyè¿›è¡Œæ‰“æ¡©ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// method_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestUser_GetInfo</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> u <span class="token operator">=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
		Name<span class="token punctuation">:</span>     <span class="token string">&quot;lixin&quot;</span><span class="token punctuation">,</span>
		Birthday<span class="token punctuation">:</span> <span class="token string">&quot;2002-12-20&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ä¸ºå¯¹è±¡æ–¹æ³•æ‰“æ¡©</span>
	monkey<span class="token punctuation">.</span><span class="token function">PatchInstanceMethod</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;CalcAge&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">18</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	ret <span class="token operator">:=</span> u<span class="token punctuation">.</span><span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// å†…éƒ¨è°ƒç”¨u.CalcAgeæ–¹æ³•æ—¶ä¼šè¿”å›18</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">&quot;æœ‹å‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>â¯ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-run</span><span class="token operator">=</span>User <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestUser_GetInfo
--- PASS: TestUser_GetInfo <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      monkey_demo     <span class="token number">0</span>.012s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>monkey</code>åŸºæœ¬ä¸Šèƒ½æ»¡è¶³æˆ‘ä»¬åœ¨å•å…ƒæµ‹è¯•ä¸­æ‰“æ¡©çš„ä»»ä½•éœ€æ±‚ã€‚</p><p>ç¤¾åŒºä¸­è¿˜æœ‰ä¸€ä¸ªå‚è€ƒmonkeyåº“å®ç°çš„<a href="https://github.com/agiledragon/gomonkey" target="_blank" rel="noopener noreferrer">gomonkey<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>åº“ï¼ŒåŸç†å’Œä½¿ç”¨è¿‡ç¨‹åŸºæœ¬ç›¸ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†å•°å—¦äº†ã€‚é™¤æ­¤ä¹‹å¤–ç¤¾åŒºé‡Œè¿˜æœ‰ä¸€äº›å…¶ä»–æ‰“æ¡©å·¥å…·å¦‚<a href="https://github.com/prashantv/gostub" target="_blank" rel="noopener noreferrer">GoStub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç­‰ã€‚</p><h2 id="ç¼–å†™å¯æµ‹è¯•çš„ä»£ç " tabindex="-1"><a class="header-anchor" href="#ç¼–å†™å¯æµ‹è¯•çš„ä»£ç " aria-hidden="true">#</a> <strong><strong>ç¼–å†™å¯æµ‹è¯•çš„ä»£ç </strong></strong></h2><p>ç¼–å†™å¯æµ‹è¯•çš„ä»£ç æ¯”å†™UTæ›´é‡è¦ï¼Œå®é™…ä¸Šç¼–å†™å¯æµ‹è¯•çš„ä»£ç éœ€è¦æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™å°±æ³¨æ„ã€‚</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªæ ¹æ®æ—¶é—´åˆ¤æ–­æŠ¥è­¦ä¿¡æ¯å‘é€é€Ÿç‡çš„æ¨¡å—ï¼Œç™½å¤©å·¥ä½œæ—¶é—´å…è®¸å¤§é‡å‘é€æŠ¥è­¦ä¿¡æ¯ï¼Œè€Œæ™šä¸Šåˆ™å‡å°å‘é€é€Ÿç‡ï¼Œå‡Œæ™¨ä¸å…è®¸å‘é€æŠ¥è­¦çŸ­ä¿¡ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// judgeRate æŠ¥è­¦é€Ÿç‡å†³ç­–å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">judgeRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> hour <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> hour <span class="token operator">&gt;=</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> hour <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token number">10</span>
	<span class="token keyword">case</span> hour <span class="token operator">&gt;=</span> <span class="token number">20</span> <span class="token operator">&amp;&amp;</span> hour <span class="token operator">&lt;=</span> <span class="token number">23</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°å†…éƒ¨ä½¿ç”¨äº†<code>time.Now()</code>æ¥è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´ä½œä¸ºåˆ¤æ–­çš„ä¾æ®ï¼Œçœ‹èµ·æ¥å¾ˆåˆç†ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªå‡½æ•°ç°åœ¨éšå¼åŒ…å«äº†ä¸€ä¸ªä¸ç¡®å®šå› ç´ â€”â€”æ—¶é—´ã€‚åœ¨ä¸åŒçš„æ—¶åˆ»æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªå‡½æ•°éƒ½å¯èƒ½ä¼šå¾—åˆ°ä¸ä¸€æ ·çš„ç»“æœã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ä¸ºè¿™ä¸ªå‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•å‘¢ï¼Ÿ</p><p>å¦‚æœä¸ä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ— æ³•ä¸ºè¿™ä¸ªå‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¿™ä¸ªå‡½æ•°æˆäº†â€œä¸å¯æµ‹è¯•çš„ä»£ç â€ï¼ˆå½“ç„¶å¯ä»¥ä½¿ç”¨æ‰“æ¡©å·¥å…·å¯¹<code>time.Now</code>è¿›è¡Œæ‰“æ¡©ï¼Œä½†é‚£ä¸æ˜¯æœ¬æ–‡è¦å¼ºè°ƒçš„é‡ç‚¹ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¥å¦‚ä½•æ”¹é€ å®ƒï¼Ÿ</p><p>æˆ‘ä»¬é€šè¿‡ä¸ºå‡½æ•°ä¼ å‚æ•°çš„æ–¹å¼ä¼ å…¥éœ€è¦åˆ¤æ–­çš„æ—¶åˆ»ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// judgeRateByTime æŠ¥è­¦é€Ÿç‡å†³ç­–å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">judgeRateByTime</span><span class="token punctuation">(</span>now time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> hour <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> hour <span class="token operator">&gt;=</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> hour <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token number">10</span>
	<span class="token keyword">case</span> hour <span class="token operator">&gt;=</span> <span class="token number">20</span> <span class="token operator">&amp;&amp;</span> hour <span class="token operator">&lt;=</span> <span class="token number">23</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·æˆ‘ä»¬ä¸ä»…è§£å†³äº†å‡½æ•°ä¸ç³»ç»Ÿæ—¶é—´çš„ç´§è€¦åˆï¼Œè€Œä¸”è¿˜æ‰©å±•äº†å‡½æ•°çš„åŠŸèƒ½ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦è·å–ä»»æ„æ—¶åˆ»çš„é€Ÿç‡å€¼ã€‚ä¸ºæ”¹é€ åçš„<code>judgeRateByTime</code>ç¼–å†™å•å…ƒæµ‹è¯•ä¹Ÿæ›´æ–¹ä¾¿äº†ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Test_judgeRateByTime</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name <span class="token builtin">string</span>
		arg  time<span class="token punctuation">.</span>Time
		want <span class="token builtin">int</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;å·¥ä½œæ—¶é—´&quot;</span><span class="token punctuation">,</span>
			arg<span class="token punctuation">:</span>  time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">,</span>
			want<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;æ™šä¸Š&quot;</span><span class="token punctuation">,</span>
			arg<span class="token punctuation">:</span>  time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">,</span>
			want<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;å‡Œæ™¨&quot;</span><span class="token punctuation">,</span>
			arg<span class="token punctuation">:</span>  time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">,</span>
			want<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> got <span class="token operator">:=</span> <span class="token function">judgeRateByTime</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> got <span class="token operator">!=</span> tt<span class="token punctuation">.</span>want <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;judgeRateByTime() = %v, want %v&quot;</span><span class="token punctuation">,</span> got<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>want<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¥å£æŠ½è±¡è¿›è¡Œè§£è€¦" tabindex="-1"><a class="header-anchor" href="#æ¥å£æŠ½è±¡è¿›è¡Œè§£è€¦" aria-hidden="true">#</a> æ¥å£æŠ½è±¡è¿›è¡Œè§£è€¦</h3><p>åŒæ ·æ˜¯å‡½æ•°ä¸­éšå¼ä¾èµ–çš„é—®é¢˜ï¼Œå‡è®¾æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªè·å–åº—é“ºå®¢å•ä»·çš„éœ€æ±‚ï¼Œå®ƒå®Œæˆçš„åŠŸèƒ½å°±åƒä¸‹é¢çš„ç¤ºä¾‹å‡½æ•°ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// GetAveragePricePerStore æ¯å®¶åº—çš„äººå‡ä»·</span>
<span class="token keyword">func</span> <span class="token function">GetAveragePricePerStore</span><span class="token punctuation">(</span>storeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;https://qiniu.com/api/orders?storeName=&quot;</span> <span class="token operator">+</span> storeName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> orders <span class="token punctuation">[</span><span class="token punctuation">]</span>Order
	<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		p <span class="token builtin">int64</span>
		n <span class="token builtin">int64</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> order <span class="token operator">:=</span> <span class="token keyword">range</span> orders <span class="token punctuation">{</span>
		p <span class="token operator">+=</span> order<span class="token punctuation">.</span>Price
		n <span class="token operator">+=</span> order<span class="token punctuation">.</span>Num
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> p <span class="token operator">/</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä¸ºä¸Šé¢çš„ä»£ç ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯æˆ‘ä»¬å¦‚ä½•é¿å…æ¯æ¬¡å•å…ƒæµ‹è¯•æ—¶éƒ½å‘èµ·çœŸå®çš„HTTPè¯·æ±‚å‘¢ï¼Ÿäº¦æˆ–è€…åç»­æˆ‘ä»¬æ”¹å˜äº†è·å–æ•°æ®çš„æ–¹å¼ï¼ˆç›´æ¥è¯»å–ç¼“å­˜æˆ–æ”¹ä¸ºRPCè°ƒç”¨ï¼‰è¿™ä¸ªå‡½æ•°è¯¥æ€ä¹ˆå…¼å®¹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å°†å‡½æ•°ä¸­è·å–æ•°æ®çš„éƒ¨åˆ†æŠ½è±¡ä¸ºæ¥å£ç±»å‹æ¥ä¼˜åŒ–æˆ‘ä»¬çš„ç¨‹åºï¼Œä½¿å…¶æ”¯æŒæ¨¡å—åŒ–çš„æ•°æ®æºé…ç½®ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// OrderInfoGetter è®¢å•ä¿¡æ¯æä¾›è€…</span>
<span class="token keyword">type</span> OrderInfoGetter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">GetOrders</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Order<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åå®šä¹‰ä¸€ä¸ªAPIç±»å‹ï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªé€šè¿‡HTTPè¯·æ±‚è·å–è®¢å•æ•°æ®çš„<code>GetOrders</code>æ–¹æ³•ï¼Œæ­£å¥½å®ç°<code>OrderInfoGetter</code>æ¥å£ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// HttpApi HTTP APIç±»å‹</span>
<span class="token keyword">type</span> HttpApi <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// GetOrders é€šè¿‡HTTPè¯·æ±‚è·å–è®¢å•æ•°æ®çš„æ–¹æ³•</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a HttpApi<span class="token punctuation">)</span> <span class="token function">GetOrders</span><span class="token punctuation">(</span>storeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Order<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;https://qiniu.com/api/orders?storeName=&quot;</span> <span class="token operator">+</span> storeName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> res<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> orders <span class="token punctuation">[</span><span class="token punctuation">]</span>Order
	<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> orders<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†åŸæ¥çš„Â <code>GetAveragePricePerStore</code>Â å‡½æ•°ä¿®æ”¹ä¸ºä»¥ä¸‹å®ç°ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// GetAveragePricePerStore æ¯å®¶åº—çš„äººå‡ä»·</span>
<span class="token keyword">func</span> <span class="token function">GetAveragePricePerStore</span><span class="token punctuation">(</span>getter OrderInfoGetter<span class="token punctuation">,</span> storeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	orders<span class="token punctuation">,</span> err <span class="token operator">:=</span> getter<span class="token punctuation">.</span><span class="token function">GetOrders</span><span class="token punctuation">(</span>storeName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		p <span class="token builtin">int64</span>
		n <span class="token builtin">int64</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> order <span class="token operator">:=</span> <span class="token keyword">range</span> orders <span class="token punctuation">{</span>
		p <span class="token operator">+=</span> order<span class="token punctuation">.</span>Price
		n <span class="token operator">+=</span> order<span class="token punctuation">.</span>Num
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> p <span class="token operator">/</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»è¿‡è¿™ç•ªæ”¹åŠ¨ä¹‹åï¼Œæˆ‘ä»¬çš„ä»£ç å°±èƒ½å¾ˆå®¹æ˜“åœ°å†™å‡ºå•å…ƒæµ‹è¯•ä»£ç ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸æ–¹ä¾¿ç›´æ¥è¯·æ±‚çš„HTTP API, æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œ mock æµ‹è¯•ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Mock ä¸€ä¸ªmockç±»å‹</span>
<span class="token keyword">type</span> Mock <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// GetOrders mockè·å–è®¢å•æ•°æ®çš„æ–¹æ³•</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m Mock<span class="token punctuation">)</span> <span class="token function">GetOrders</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Order<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Order<span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			Price<span class="token punctuation">:</span> <span class="token number">20300</span><span class="token punctuation">,</span>
			Num<span class="token punctuation">:</span>   <span class="token number">2</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			Price<span class="token punctuation">:</span> <span class="token number">642</span><span class="token punctuation">,</span>
			Num<span class="token punctuation">:</span>   <span class="token number">5</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestGetAveragePricePerStore</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">type</span> args <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		getter    OrderInfoGetter
		storeName <span class="token builtin">string</span>
	<span class="token punctuation">}</span>
	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name    <span class="token builtin">string</span>
		args    args
		want    <span class="token builtin">int64</span>
		wantErr <span class="token builtin">bool</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">&quot;mock test&quot;</span><span class="token punctuation">,</span>
			args<span class="token punctuation">:</span> args<span class="token punctuation">{</span>
				getter<span class="token punctuation">:</span>    Mock<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
				storeName<span class="token punctuation">:</span> <span class="token string">&quot;mock&quot;</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			want<span class="token punctuation">:</span>    <span class="token number">12062</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			got<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetAveragePricePerStore</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>args<span class="token punctuation">.</span>getter<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>args<span class="token punctuation">.</span>storeName<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token operator">!=</span> tt<span class="token punctuation">.</span>wantErr <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;GetAveragePricePerStore() error = %v, wantErr %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>wantErr<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> got <span class="token operator">!=</span> tt<span class="token punctuation">.</span>want <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;GetAveragePricePerStore() got = %v, want %v&quot;</span><span class="token punctuation">,</span> got<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>want<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¾èµ–æ³¨å…¥ä»£æ›¿éšå¼ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#ä¾èµ–æ³¨å…¥ä»£æ›¿éšå¼ä¾èµ–" aria-hidden="true">#</a> ä¾èµ–æ³¨å…¥ä»£æ›¿éšå¼ä¾èµ–</h3><p>æˆ‘ä»¬å¯èƒ½ç»å¸¸ä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å…¨å±€å˜é‡çš„æ–¹å¼å¼•å…¥æ—¥å¿—åº“æˆ–æ•°æ®åº“è¿æ¥å®ä¾‹ç­‰ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;github.com/sirupsen/logrus&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> log <span class="token operator">=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> App <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>App<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;app start ...&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>app<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;app start ...&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	app <span class="token operator">:=</span> <span class="token operator">&amp;</span>App<span class="token punctuation">{</span><span class="token punctuation">}</span>
	app<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ä¸­ App ä¸­é€šè¿‡å¼•ç”¨å…¨å±€å˜é‡çš„æ–¹å¼å°†ä¾èµ–é¡¹ç¡¬ç¼–ç åˆ°ä»£ç ä¸­ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•æ—¶å¦‚ä½• mock log å˜é‡å‘¢ï¼Ÿ</p><p>æ­¤å¤–è¿™æ ·çš„ä»£ç è¿˜å­˜åœ¨ä¸€ä¸ªæ›´ä¸¥é‡çš„é—®é¢˜â€”â€”å®ƒä¸å…·ä½“çš„æ—¥å¿—åº“ç¨‹åºå¼ºè€¦åˆã€‚å½“æˆ‘ä»¬åç»­å› ä¸ºæŸäº›åŸå› éœ€è¦æ›´æ¢å¦ä¸€ä¸ªæ—¥å¿—åº“æ—¶ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹ä»£ç å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åº”è¯¥å°†ä¾èµ–é¡¹è§£è€¦å‡ºæ¥ï¼Œå¹¶ä¸”å°†ä¾èµ–æ³¨å…¥åˆ°æˆ‘ä»¬çš„ App å®ä¾‹ä¸­ï¼Œè€Œä¸æ˜¯åœ¨å…¶å†…éƒ¨éšå¼è°ƒç”¨å…¨å±€å˜é‡ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> App <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Logger
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>App<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;app start ...&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewApp æ„é€ å‡½æ•°ï¼Œå°†ä¾èµ–é¡¹æ³¨å…¥</span>
<span class="token keyword">func</span> <span class="token function">NewApp</span><span class="token punctuation">(</span>lg Logger<span class="token punctuation">)</span> <span class="token operator">*</span>App <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>App<span class="token punctuation">{</span>
		Logger<span class="token punctuation">:</span> lg<span class="token punctuation">,</span> <span class="token comment">// ä½¿ç”¨ä¼ å…¥çš„ä¾èµ–é¡¹å®Œæˆåˆå§‹åŒ–</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç å°±å¾ˆå®¹æ˜“ mock logå®ä¾‹ï¼Œå®Œæˆå•å…ƒæµ‹è¯•ã€‚</p><p>ä¾èµ–æ³¨å…¥å°±æ˜¯æŒ‡åœ¨åˆ›å»ºç»„ä»¶ï¼ˆGo ä¸­çš„ structï¼‰çš„æ—¶å€™æ¥æ”¶å®ƒçš„ä¾èµ–é¡¹ï¼Œè€Œä¸æ˜¯å®ƒçš„åˆå§‹åŒ–ä»£ç ä¸­å¼•ç”¨å¤–éƒ¨æˆ–è‡ªè¡Œåˆ›å»ºä¾èµ–é¡¹ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Config é…ç½®é¡¹ç»“æ„ä½“</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// LoadConfFromFile ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½é…ç½®</span>
<span class="token keyword">func</span> <span class="token function">LoadConfFromFile</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Config <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Server server ç¨‹åº</span>
<span class="token keyword">type</span> Server <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Config <span class="token operator">*</span>Config
<span class="token punctuation">}</span>

<span class="token comment">// NewServer Server æ„é€ å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Server <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>
    <span class="token comment">// éšå¼åˆ›å»ºä¾èµ–é¡¹</span>
		Config<span class="token punctuation">:</span> <span class="token function">LoadConfFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;./config.toml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­å°±é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­éšå¼åˆ›å»ºä¾èµ–é¡¹ï¼Œè¿™æ ·çš„ä»£ç å¼ºè€¦åˆã€ä¸æ˜“æ‰©å±•ï¼Œä¹Ÿä¸å®¹æ˜“ç¼–å†™å•å…ƒæµ‹è¯•ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œå°†æ„é€ å‡½æ•°ä¸­çš„ä¾èµ–ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ„é€ å‡½æ•°ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// NewServer Server æ„é€ å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token operator">*</span>Server <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>
		<span class="token comment">// éšå¼åˆ›å»ºä¾èµ–é¡¹</span>
		Config<span class="token punctuation">:</span> conf<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸è¦éšå¼å¼•ç”¨å¤–éƒ¨ä¾èµ–ï¼ˆå…¨å±€å˜é‡ã€éšå¼è¾“å…¥ç­‰ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼å¼•å…¥ä¾èµ–ã€‚ç»è¿‡è¿™æ ·çš„ä¿®æ”¹ä¹‹åï¼Œæ„é€ å‡½æ•°<code>NewServer</code>Â çš„ä¾èµ–é¡¹å°±å¾ˆæ¸…æ™°ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬ç¼–å†™ mock æµ‹è¯•ä»£ç ã€‚</p><p>ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼èƒ½å¤Ÿè®©æˆ‘ä»¬çš„ä»£ç çœ‹èµ·æ¥æ›´æ¸…æ™°ï¼Œä½†æ˜¯è¿‡å¤šçš„æ„é€ å‡½æ•°ä¹Ÿä¼šè®©ä¸»å‡½æ•°çš„ä»£ç è¿…é€Ÿè†¨èƒ€ï¼Œå¥½åœ¨Go è¯­è¨€æä¾›äº†ä¸€äº›ä¾èµ–æ³¨å…¥å·¥å…·ï¼ˆä¾‹å¦‚Â <a href="https://github.com/google/wire" target="_blank" rel="noopener noreferrer">wire<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>Â ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç®¡ç†ä¾èµ–æ³¨å…¥çš„ä»£ç ã€‚</p><h3 id="solidåŸåˆ™" tabindex="-1"><a class="header-anchor" href="#solidåŸåˆ™" aria-hidden="true">#</a> SOLIDåŸåˆ™</h3><p>æœ€åè¡¥å……ä¸€ä¸ªç¨‹åºè®¾è®¡çš„<code>SOLID</code>åŸåˆ™ï¼Œæˆ‘ä»¬åœ¨ç¨‹åºè®¾è®¡æ—¶è·µè¡Œä»¥ä¸‹å‡ ä¸ªåŸåˆ™ä¼šå¸®åŠ©æˆ‘ä»¬å†™å‡ºå¯æµ‹è¯•çš„ä»£ç ã€‚</p><table><thead><tr><th>é¦–å­—æ¯</th><th>æŒ‡ä»£</th><th>æ¦‚å¿µ</th></tr></thead><tbody><tr><td>S</td><td>å•ä¸€èŒè´£åŸåˆ™</td><td>æ¯ä¸ªç±»éƒ½åº”è¯¥åªæœ‰ä¸€ä¸ªèŒè´£ã€‚</td></tr><tr><td>O</td><td>å¼€é—­åŸåˆ™</td><td>ä¸€ä¸ªè½¯ä»¶å®ä½“ï¼Œå¦‚ç±»ã€æ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚</td></tr><tr><td>L</td><td>é‡Œå¼æ›¿æ¢åŸåˆ™</td><td>è®¤ä¸ºâ€œç¨‹åºä¸­çš„å¯¹è±¡åº”è¯¥æ˜¯å¯ä»¥åœ¨ä¸æ”¹å˜ç¨‹åºæ­£ç¡®æ€§çš„å‰æä¸‹è¢«å®ƒçš„å­ç±»æ‰€æ›¿æ¢çš„â€çš„æ¦‚å¿µã€‚</td></tr><tr><td>I</td><td>æ¥å£éš”ç¦»åŸåˆ™</td><td>è®¸å¤šç‰¹å®šäºå®¢æˆ·ç«¯çš„æ¥å£ä¼˜äºä¸€ä¸ªé€šç”¨æ¥å£ã€‚</td></tr><tr><td>D</td><td>ä¾èµ–åè½¬åŸåˆ™</td><td>åº”è¯¥ä¾èµ–æŠ½è±¡ï¼Œè€Œä¸æ˜¯æŸä¸ªå…·ä½“ç¤ºä¾‹ã€‚</td></tr></tbody></table><p>æœ‰æ—¶å€™åœ¨å†™ä»£ç ä¹‹å‰å¤šè€ƒè™‘ä¸€ä¸‹ä»£ç çš„è®¾è®¡æ˜¯å¦ç¬¦åˆä¸Šè¿°åŸåˆ™ã€‚</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/lixvyang/edit/main/src/posts/program/golang/å•æµ‹/å•æµ‹æ€»ç»“/ut.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: lixin@lixins-MacBook-Pro.local">lixin</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">æœ¬ç«™åšå®¢æœªç»æˆæƒç¦æ­¢è½¬è½½</div><div class="vp-copyright">Lixin Â© 2020-2023</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-8b169e14.js" defer></script>
  </body>
</html>
