<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://yanglixin.com/posts/program/redis/note/redis-note.html"><meta property="og:title" content="Redisç¬”è®°"><meta property="og:description" content="Redisç¬”è®°"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-10-05T02:57:17.000Z"><meta property="article:author" content="ç¦»å¿ƒ"><meta property="article:tag" content="redis"><meta property="article:published_time" content="2021-11-23T00:00:00.000Z"><meta property="article:modified_time" content="2023-10-05T02:57:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redisç¬”è®°","image":[""],"datePublished":"2021-11-23T00:00:00.000Z","dateModified":"2023-10-05T02:57:17.000Z","author":[{"@type":"Person","name":"ç¦»å¿ƒ"}]}</script><link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>Redisç¬”è®°</title><meta name="description" content="Redisç¬”è®°">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-898c079a.css" as="style"><link rel="stylesheet" href="/assets/style-898c079a.css">
    <link rel="modulepreload" href="/assets/app-bd92852c.js"><link rel="modulepreload" href="/assets/redis-note.html-78a4d448.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/redis-note.html-f70aa324.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><!----><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="tabler:home" width="1em" height="1em"></iconify-icon>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/posts/program/golang/"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="file-icons:go-old" width="1em" height="1em"></iconify-icon>Golangç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/posts/thinking/"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="icons8:idea" width="1em" height="1em"></iconify-icon>æ€è€ƒ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/archives.html"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="teenyicons:archive-outline" width="1em" height="1em"></iconify-icon>å½’æ¡£<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/intro.html"><iconify-icon class="font-icon icon" style="" mode="style" inline icon="material-symbols:info-outline" width="1em" height="1em"></iconify-icon>å…³äº<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/lixvyang" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><iconify-icon class="font-icon icon" style="" mode="style" inline icon="logos:redis" width="1em" height="1em"></iconify-icon>Redisç¬”è®°</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">ç¦»å¿ƒ</span></span><span property="author" content="ç¦»å¿ƒ"></span></span><span class="page-original-info">åŸåˆ›</span><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2021-11-23T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 128 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT128M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category5 clickable" role="navigation">tutorial</span><!--]--><meta property="articleSection" content="tutorial"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag5 clickable" role="navigation">redis</span><!--]--><meta property="keywords" content="redis"></span></div><hr></div><!----><!----><div class="theme-hope-content"><h1 id="redisç¬”è®°" tabindex="-1"><a class="header-anchor" href="#redisç¬”è®°" aria-hidden="true">#</a> Redisç¬”è®°</h1><!-- ## æ•°æ®ç»“æ„ä¸å¯¹è±¡

### SDS(ç®€å•åŠ¨æ€å­—ç¬¦ä¸²)
> SDS(ç®€å•åŠ¨æ€å­—ç¬¦ä¸²), æ˜¯å¯¹Cè¯­è¨€å­—ç¬¦ä¸²å°è£…äº†ä¸€å±‚

ä¸¾ä¸ªä¾‹å­
```
set msg "hello world"
OK
```
Redisä¼šæ–°å¢ä¸€ä¸ªé”®å€¼å¯¹, å…¶ä¸­: é”®å€¼å¯¹é”®æ˜¯ä¿å­˜msgçš„SDS, å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡SDS
```c
struct sdshdr {
//è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡  ç­‰äºSDSæ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦
int len;
//è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡
int free;
//å­—èŠ‚æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²
char buf[];
};
```

å…¶ä¸­SDSä¿ç•™äº†Cå­—ç¬¦ä¸²ä¸­æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯'\0'çš„æƒ¯ä¾‹, ç›®çš„æ˜¯SDSå¯ä»¥ç›´æ¥é‡ç”¨Cå­—ç¬¦ä¸²å‡½æ•°åº“é‡Œçš„å‡½æ•°.

å¥½å¤„: 
1. å› ä¸ºSDSå†…éƒ¨æœ‰ä¸ªlenå±æ€§, æ‰€ä»¥å¦‚æœæƒ³è·å–å­—ç¬¦ä¸²é•¿åº¦å°±ç›´æ¥è¿”å›len, æ—¶é—´å¤æ‚åº¦æ˜¯O(1), ä½†å¦‚æœç”¨åŸç”Ÿstrlenå‡½æ•° æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(n)äº†
2. SDSä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡º,å› ä¸º SDS åœ¨æ‹¼æ¥å­—ç¬¦ä¸²ä¹‹å‰ä¼šæ£€æŸ¥ SDS ç©ºé—´æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜, å¯ä»¥å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°,ç©ºé—´é¢„åˆ†é…:å½“appendæ—¶å½“SDSé•¿åº¦å°äº1MB,åˆ™å†å¤šåˆ†é…ä¸€å€çš„ç©ºé—´ï¼›è‹¥å¤§äº1MB, åˆ™å¤šåˆ†é…1MBçš„ç©ºé—´ï¼›æƒ°æ€§ç©ºé—´é‡Šæ”¾, å½“éœ€è¦å‡å°‘SDSçš„ç©ºé—´æ—¶, ä¸ä¼šç«‹åˆ»å‡å°‘, å…ˆæ›´æ–°free, è¿™æ ·å¯ä»¥é¿å…å†æ¬¡åˆ†é…å¸¦æ¥çš„æ€§èƒ½æŸè€—, å½“ç„¶ä¹Ÿæœ‰çœŸæ­£çš„é‡Šæ”¾å†…å­˜ç©ºé—´çš„API.
3. SDS ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ã€‚å› ä¸º SDS ä½¿ç”¨ len å±æ€§çš„å€¼è€Œä¸æ˜¯ç©ºå­—ç¬¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œå¹¶ä¸” SDS çš„æ‰€æœ‰ API éƒ½ä¼šä»¥å¤„ç†äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å¤„ç† SDS å­˜æ”¾åœ¨ buf[] æ•°ç»„é‡Œçš„æ•°æ®ã€‚æ‰€ä»¥ SDS ä¸å…‰èƒ½å­˜æ”¾æ–‡æœ¬æ•°æ®ï¼Œè€Œä¸”èƒ½ä¿å­˜å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®ã€‚

### é“¾è¡¨

é“¾è¡¨åœ¨Redisä¸­çš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚åˆ—è¡¨é”®çš„åº•å±‚å®ç°ä¹‹ä¸€å°±æ˜¯é“¾è¡¨ã€‚å½“ä¸€ä¸ªåˆ—è¡¨é”®åŒ…å«äº†æ•°é‡æ¯”è¾ƒå¤šçš„å…ƒç´ ï¼Œåˆæˆ–è€…åˆ—è¡¨ä¸­åŒ…å«çš„å…ƒç´ éƒ½æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼ŒRediså°±ä¼šä½¿ç”¨é“¾è¡¨ä½œä¸ºåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚

æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹æ˜¯
```c
typedef struct listNode {
    struct listNode * prev;
    struct listNode * next;
    void * value;
}listNode;
```
å¤šä¸ªlistNodeå¯ä»¥é€šè¿‡prevå’ŒnextæŒ‡é’ˆç»„æˆåŒç«¯é“¾è¡¨ã€‚
```c
typedef struct list {
listNode * head;
listNode * tail;
// é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡
unsigned long len;
// èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°
void *(*dup)(void *ptr);
// èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°
void (*free)(void *ptr);
// èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°
int (*match)(void *ptr,void *key);
} list;
```
é“¾è¡¨çš„ç‰¹æ€§: åŒç«¯, æ— ç¯, Â·å¸¦è¡¨å¤´æŒ‡é’ˆå’Œè¡¨å°¾æŒ‡é’ˆ, å¸¦é“¾è¡¨é•¿åº¦è®¡æ•°å™¨

å¤šæ€ï¼šé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨void*æŒ‡é’ˆæ¥ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡listç»“æ„çš„dupã€freeã€matchä¸‰ä¸ªå±æ€§ä¸ºèŠ‚ç‚¹å€¼è®¾ç½®ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œæ‰€ä»¥é“¾è¡¨å¯ä»¥ç”¨äºä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼ã€‚

### å­—å…¸

Redisçš„å­—å…¸ç”¨å“ˆå¸Œè¡¨æ¥å®ç°, ä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œé¢æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹, è€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸ä¸­çš„å¤šä¸ªé”®å€¼å¯¹

å“ˆå¸Œè¡¨å®ç°
```c
typedef struct dictht {
//å“ˆå¸Œè¡¨æ•°ç»„
dictEntry **table;
//å“ˆå¸Œè¡¨å¤§å°
unsigned long size;
//å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼
//æ€»æ˜¯ç­‰äºsize-1
unsigned long sizemask;
//è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡
unsigned long used;
} dictht;
```
tableå±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„,æ•°ç»„æ¯ä¸ªå…ƒç´ æŒ‡å‘çš„æ˜¯dictEntryç»“æ„çš„æŒ‡é’ˆ, æ¯ä¸ªdictEntryç»“æ„éƒ½ä¿å­˜ç€ä¸€ä¸ªé”®å€¼å¯¹.
sizeå±æ€§ä¿å­˜å“ˆå¸Œè¡¨çš„å¤§å°, å°±æ˜¯tableæ•°ç›®çš„å¤§å°
usedä¿å­˜æ€»å…±çš„é”®å€¼å¯¹ä¸ªæ•°
sizemaskå±æ€§çš„å€¼æ€»æ˜¯ç­‰äºsize-1ï¼Œè¿™ä¸ªå±æ€§å’Œå“ˆå¸Œå€¼ä¸€èµ·å†³å®šä¸€ä¸ªé”®åº”è¯¥è¢«æ”¾åˆ°tableæ•°ç»„çš„å“ªä¸ªç´¢å¼•ä¸Šé¢ã€‚

å“ˆå¸ŒèŠ‚ç‚¹

```c
typedef struct dictEntry {
//é”®
void *key;
//å€¼
union{
    void *val;
    uint64_tu64;
    int64_ts64;
} v;
//æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨
struct dictEntry *next;
} dictEntry;
```

nextæ˜¯ä¸€ä¸ªæŒ‡é’ˆ,è¿™ä¸ªæŒ‡é’ˆå¯ä»¥å°†å“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹è¿æ¥åœ¨ä¸€èµ·, æ¥è§£å†³å“ˆç³»ç¢°æ’é—®é¢˜.

å­—å…¸å®ç°

```c
typedef struct dict {
//ç±»å‹ç‰¹å®šå‡½æ•°
dictType *type;
//ç§æœ‰æ•°æ®
void *privdata;
//å“ˆå¸Œè¡¨
dictht ht[2];
// rehashç´¢å¼•
//å½“rehash ä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º-1
int rehashidx; /* rehashing not in progress if rehashidx == -1 */
} dict;
```

typeå±æ€§å’Œprivdataå±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œä¸ºåˆ›å»ºå¤šæ€å­—å…¸è€Œè®¾ç½®çš„ï¼š
typeå±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘dictTypeç»“æ„çš„æŒ‡é’ˆï¼Œæ¯ä¸ªdictTypeç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼ŒRedisä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°

è€Œprivdataå±æ€§åˆ™ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°

```c
typedef struct dictType {
//è®¡ç®—å“ˆå¸Œå€¼çš„å‡½æ•°
unsigned int (*hashFunction)(const void *key);
//å¤åˆ¶é”®çš„å‡½æ•°
void *(*keyDup)(void *privdata, const void *key);
//å¤åˆ¶å€¼çš„å‡½æ•°
void *(*valDup)(void *privdata, const void *obj);
//å¯¹æ¯”é”®çš„å‡½æ•°
int (*keyCompare)(void *privdata, const void *key1, const void *key2);
//é”€æ¯é”®çš„å‡½æ•°
void (*keyDestructor)(void *privdata, void *key);
//é”€æ¯å€¼çš„å‡½æ•°
void (*valDestructor)(void *privdata, void *obj);
} dictType;
```

ht å± æ€§ æ˜¯ ä¸€ ä¸ª åŒ… å« ä¸¤ ä¸ª é¡¹ çš„ æ•° ç»„ ï¼Œ æ•° ç»„ ä¸­ çš„ æ¯ ä¸ª é¡¹ éƒ½ æ˜¯ ä¸€ ä¸ªdicthtå“ˆå¸Œè¡¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå­—å…¸åªä½¿ç”¨ht[0]å“ˆå¸Œè¡¨ï¼Œht[1]å“ˆå¸Œè¡¨åªä¼šåœ¨å¯¹ht[0]å“ˆå¸Œè¡¨è¿›è¡Œrehashæ—¶ä½¿ç”¨ã€‚

é™¤äº†ht[1]ä¹‹å¤–ï¼Œå¦ä¸€ä¸ªå’Œrehashæœ‰å…³çš„å±æ€§å°±æ˜¯rehashidxï¼Œå®ƒè®°å½•äº†rehashç›®å‰çš„è¿›åº¦ï¼Œå¦‚æœç›®å‰æ²¡æœ‰åœ¨è¿›è¡Œrehashï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¸º-1ã€‚


rehash

å½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ä¸æ–­å˜å¤§, å°±éœ€è¦rehash
1ï¼‰ä¸ºå­—å…¸çš„ht[1]å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œè¿™ä¸ªå“ˆå¸Œè¡¨çš„ç©ºé—´å¤§å°å–å†³äº è¦ æ‰§ è¡Œ çš„ æ“ ä½œ ï¼Œ ä»¥ åŠ ht[0] å½“ å‰ åŒ… å« çš„ é”® å€¼ å¯¹ æ•° é‡ ï¼ˆ ä¹Ÿ å³ æ˜¯ht[0].usedå±æ€§çš„å€¼ï¼‰ï¼š
- å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œé‚£ä¹ˆht[1]çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].used*2çš„2^nï¼ˆ2çš„næ¬¡æ–¹å¹‚ï¼‰ï¼›
- å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œé‚£ä¹ˆht[1]çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].usedçš„2^nã€‚
2ï¼‰å°†ä¿å­˜åœ¨ht[0]ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹rehashåˆ°ht[1]ä¸Šé¢ï¼šrehashæŒ‡çš„æ˜¯é‡æ–°è®¡ç®—é”®çš„å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œç„¶åå°†é”®å€¼å¯¹æ”¾ç½®åˆ°ht[1]å“ˆå¸Œè¡¨çš„æŒ‡å®šä½ç½®ä¸Šã€‚

å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©

å½“ä»¥ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¢«æ»¡è¶³æ—¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å±•æ“ä½œï¼š

1ï¼‰æœåŠ¡å™¨ç›®å‰æ²¡æœ‰åœ¨æ‰§è¡ŒBGSAVEå‘½ä»¤æˆ–è€…BGREWRITEAOFå‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº1ã€‚
2ï¼‰æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡ŒBGSAVEå‘½ä»¤æˆ–è€…BGREWRITEAOFå‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº5ã€‚

è´Ÿè½½å› å­=å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡/å“ˆå¸Œè¡¨å¤§å°
load_factor = ht[0].used / ht[0].size

å½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å°äº0.1æ—¶ï¼Œç¨‹åºè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©æ“ä½œã€‚

æ¸è¿›å¼rehash
å½“å“ˆå¸Œè¡¨é‡Œçš„æ•°æ®å¾ˆå¤šæ—¶, ä¸€ä¸‹å­ç¬é—´rehashå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜, æ‰€ä»¥redisé‡‡ç”¨æ¸è¿›å¼rehash
```sh
1ï¼‰ä¸ºht[1]åˆ†é…ç©ºé—´ï¼Œè®©å­—å…¸åŒæ—¶æŒæœ‰ht[0]å’Œht[1]ä¸¤ä¸ªå“ˆå¸Œè¡¨ã€‚
2ï¼‰åœ¨å­—å…¸ä¸­ç»´æŒä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡rehashidxï¼Œå¹¶å°†å®ƒçš„å€¼è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºrehashå·¥ä½œæ­£å¼å¼€å§‹ã€‚
3ï¼‰åœ¨rehashè¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æˆ–è€…æ›´æ–°æ“ä½œæ—¶ï¼Œç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œè¿˜ä¼šé¡ºå¸¦å°†ht[0]å“ˆå¸Œè¡¨åœ¨rehashidxç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹rehashåˆ°ht[1]ï¼Œå½“rehashå·¥ä½œå®Œæˆä¹‹åï¼Œç¨‹åºå°†rehashidxå±æ€§çš„å€¼å¢ä¸€ã€‚
4ï¼‰éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œht[0]çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢«rehashè‡³ht[1]ï¼Œè¿™æ—¶ç¨‹åºå°†rehashidxå±æ€§çš„å€¼è®¾ä¸º-1ï¼Œè¡¨ç¤ºrehashæ“ä½œå·²å®Œæˆã€‚

å› ä¸ºåœ¨è¿›è¡Œæ¸è¿›å¼rehashçš„è¿‡ç¨‹ä¸­ï¼Œå­—å…¸ä¼šåŒæ—¶ä½¿ç”¨ht[0]å’Œht[1] ä¸¤ ä¸ª å“ˆ å¸Œ è¡¨ ï¼Œ æ‰€ ä»¥ åœ¨ æ¸ è¿› å¼ rehash è¿› è¡Œ æœŸ é—´ ï¼Œ å­— å…¸ çš„ åˆ  é™¤ï¼ˆdeleteï¼‰ã€æŸ¥æ‰¾ï¼ˆfindï¼‰ã€æ›´æ–°ï¼ˆupdateï¼‰ç­‰æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œã€‚ä¾‹å¦‚ï¼Œè¦åœ¨å­—å…¸é‡Œé¢æŸ¥æ‰¾ä¸€ä¸ªé”®çš„è¯ï¼Œç¨‹åºä¼šå…ˆåœ¨ht[0]é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°çš„è¯ï¼Œå°±ä¼šç»§ç»­åˆ°ht[1]é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚

å¦å¤–ï¼Œåœ¨æ¸è¿›å¼rehashæ‰§è¡ŒæœŸé—´ï¼Œæ–°æ·»åŠ åˆ°å­—å…¸çš„é”®å€¼å¯¹ä¸€å¾‹ä¼šè¢«ä¿å­˜åˆ°ht[1]é‡Œé¢ï¼Œè€Œht[0]åˆ™ä¸å†è¿›è¡Œä»»ä½•æ·»åŠ æ“ä½œï¼Œè¿™ä¸€æªæ–½ä¿è¯äº†ht[0]åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ä¼šåªå‡ä¸å¢ï¼Œå¹¶éšç€rehashæ“ä½œçš„æ‰§è¡Œè€Œæœ€ç»ˆå˜æˆç©ºè¡¨
```

### è·³è¡¨

è·³è¡¨æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„, é€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹å†…ç»´æŒå¤šä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆ, ä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„, è·³è·ƒè¡¨æ”¯æŒå¹³å‡Oï¼ˆlogNï¼‰ã€æœ€åOï¼ˆNï¼‰å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œè¿˜å¯ä»¥é€šè¿‡é¡ºåºæ€§æ“ä½œæ¥æ‰¹é‡å¤„ç†èŠ‚ç‚¹ã€‚

Redisåªåœ¨ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°äº†è·³è·ƒè¡¨ï¼Œä¸€ä¸ªæ˜¯å®ç°æœ‰åºé›†åˆé”®ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„.
è·³è¡¨èŠ‚ç‚¹çš„å±æ€§
```c
typedef struct zskiplistNode {
//Zset å¯¹è±¡çš„å…ƒç´ å€¼
sds ele;
//å…ƒç´ æƒé‡å€¼
double score;
//åå‘æŒ‡é’ˆ
struct zskiplistNode *backward;
//èŠ‚ç‚¹çš„levelæ•°ç»„ï¼Œä¿å­˜æ¯å±‚ä¸Šçš„å‰å‘æŒ‡é’ˆå’Œè·¨åº¦
struct zskiplistLevel {
    struct zskiplistNode *forward;
    unsigned long span;
} level[];
} zskiplistNode;
```
levelå±‚, æŒ‡å‘å¤šä¸ªå…ƒç´ , æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥è®¿é—®å…¶ä»–èŠ‚ç‚¹, ç¨‹åºå¯ä»¥é€šè¿‡å±‚å¿«é€Ÿå®šä½å…ƒç´ æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°è·³è·ƒè¡¨èŠ‚ç‚¹çš„æ—¶å€™ï¼Œç¨‹åºéƒ½æ ¹æ®å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆä¸€ä¸ªä»‹äº1å’Œ32ä¹‹é—´çš„å€¼ä½œä¸ºlevelæ•°ç»„çš„å¤§å°ï¼Œè¿™ä¸ªå¤§å°å°±æ˜¯å±‚çš„â€œé«˜åº¦â€ã€‚

å‰è¿›æŒ‡é’ˆ, æ¯ä¸ªå±‚ä¹‹é—´éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘è¡¨å°¾æ–¹å‘çš„å‰è¿›æŒ‡é’ˆ, ç”¨äºä»è¡¨å¤´å‘è¡¨å°¾æ–¹å‘éå†èŠ‚ç‚¹, å±‚çš„è·¨åº¦spanå±æ€§è®°å½•äº†ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»

è·³è¡¨å±æ€§
```c
typedef struct zskiplist {
struct zskiplistNode *header, *tail;
unsigned long length;
int level;
} zskiplist;
```

### æ•´æ•°é›†åˆ

æ•´æ•°é›†åˆæ˜¯é›†åˆé”®çš„å®ç°ä¹‹ä¸€, å½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œå¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒRediså°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚

```c
typedef struct intset {
//ç¼–ç æ–¹å¼
uint32_t encoding;
//é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡
uint32_t length;
//ä¿å­˜å…ƒç´ çš„æ•°ç»„
int8_t contents[];
} intset;
```
æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯Redisç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥ä¿å­˜ç±»å‹ä¸ºint16_tã€int32_tæˆ–è€…int64_tçš„æ•´æ•°å€¼ï¼Œå¹¶ä¸”ä¿è¯é›†åˆä¸­ä¸ä¼šå‡ºç°é‡å¤å…ƒç´ ã€‚

contentsæ•°ç»„æ˜¯æ•´æ•°é›†åˆçš„åº•å±‚å®ç°, è™½ç„¶intsetç»“æ„å°†contentså±æ€§å£°æ˜ä¸ºint8_tç±»å‹çš„æ•°ç»„ï¼Œä½†å®é™…ä¸Šcontentsæ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½•int8_tç±»å‹çš„å€¼ï¼Œcontentsæ•°ç»„çš„çœŸæ­£ç±»å‹å–å†³äºencodingå±æ€§çš„å€¼ï¼š

encodingçš„å±æ€§æœ‰INTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64, åˆ†åˆ«å°†contentsçš„å±æ€§è®¾ç½®ä¸ºint16_t, int32_t, int64_t

å‡çº§

æ¯å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ï¼Œå¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶ï¼Œæ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§ï¼ˆupgradeï¼‰ï¼Œç„¶åæ‰èƒ½å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ã€‚

å› ä¸ºå¼•å‘å‡çº§çš„æ–°å…ƒç´ çš„é•¿åº¦æ€»æ˜¯æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„é•¿åº¦éƒ½å¤§ï¼Œæ‰€ä»¥è¿™ä¸ªæ–°å…ƒç´ çš„å€¼è¦ä¹ˆå°±å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œè¦ä¹ˆå°±å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼š
- åœ¨æ–°å…ƒç´ å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€å¼€å¤´ï¼ˆç´¢å¼•0ï¼‰ï¼›
- åœ¨æ–°å…ƒç´ å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€æœ«å°¾ï¼ˆç´¢å¼•length-1ï¼‰ã€‚

å‡çº§çš„å¥½å¤„:æå‡çµæ´»æ€§, èŠ‚çœå†…å­˜

ä¸æ”¯æŒé™çº§

### å‹ç¼©åˆ—è¡¨

ziplistæ˜¯listå’Œhashçš„åº•å±‚å®ç°ä¹‹ä¸€, å½“ä¸€ä¸ªåˆ—è¡¨é”®åªåŒ…å«å°‘é‡åˆ—è¡¨é¡¹ï¼Œå¹¶ä¸”æ¯ä¸ªåˆ—è¡¨é¡¹è¦ä¹ˆå°±æ˜¯å°æ•´æ•°å€¼ï¼Œè¦ä¹ˆå°±æ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆRediså°±ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥åšåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚

å‹ç¼©åˆ—è¡¨æ˜¯Redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ï¼Œæ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹ï¼ˆsequentialï¼‰æ•°æ®ç»“æ„ã€‚ä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ã€‚

å‹ç¼©åˆ—è¡¨çš„ç»„æˆ
```
å‹ç¼©åˆ—è¡¨åœ¨è¡¨å¤´æœ‰ä¸‰ä¸ªå­—æ®µï¼š
zlbytesï¼Œè®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å â½¤å¯¹å†…å­˜å­—èŠ‚æ•°ï¼›
zltailï¼Œè®°å½•å‹ç¼©åˆ—è¡¨ã€Œå°¾éƒ¨ã€èŠ‚ç‚¹è·ç¦»èµ·å§‹åœ°å€ç”±å¤šå°‘å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯åˆ—è¡¨å°¾çš„åç§»é‡ï¼›
zllenï¼Œè®°å½•å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼›
zlendï¼Œæ ‡è®°å‹ç¼©åˆ—è¡¨çš„ç»“æŸç‚¹ï¼Œå›ºå®šå€¼ 0xFFï¼ˆâ¼—è¿›åˆ¶255ï¼‰ã€‚
```

åœ¨å‹ç¼©åˆ—è¡¨ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦æŸ¥æ‰¾å®šä½ç¬¬â¼€ä¸ªå…ƒç´ å’Œæœ€åâ¼€ä¸ªå…ƒç´ ï¼Œå¯ä»¥é€šè¿‡è¡¨å¤´ä¸‰ä¸ªå­—æ®µçš„â»“åº¦ç›´æ¥å®šä½ï¼Œå¤æ‚åº¦æ˜¯ O(1)ã€‚â½½æŸ¥æ‰¾å…¶ä»–å…ƒç´ æ—¶ï¼Œå°±æ²¡æœ‰è¿™ä¹ˆâ¾¼æ•ˆäº†ï¼Œåªèƒ½é€ä¸ªæŸ¥æ‰¾ï¼Œæ­¤æ—¶çš„å¤æ‚åº¦å°±æ˜¯ O(N)äº†ï¼Œå› æ­¤å‹ç¼©åˆ—è¡¨ä¸é€‚åˆä¿å­˜è¿‡å¤šçš„å…ƒç´ 

å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹åŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹ï¼šprevlenï¼Œè®°å½•äº†ã€Œå‰â¼€ä¸ªèŠ‚ç‚¹ã€çš„â»“åº¦ï¼›encodingï¼Œè®°å½•äº†å½“å‰èŠ‚ç‚¹å®é™…æ•°æ®çš„ç±»å‹ä»¥åŠâ»“åº¦ï¼›dataï¼Œè®°å½•äº†å½“å‰èŠ‚ç‚¹çš„å®é™…æ•°æ®ï¼›

è¿é”æ›´æ–°

å‹ç¼©åˆ—è¡¨æ–°å¢æŸä¸ªå…ƒç´ æˆ–ä¿®æ”¹æŸä¸ªå…ƒç´ æ—¶ï¼Œå¦‚æœç©ºé—´ä¸ä¸å¤Ÿï¼Œå‹ç¼©åˆ—è¡¨å â½¤çš„å†…å­˜ç©ºé—´å°±éœ€è¦é‡æ–°åˆ†é…ã€‚â½½å½“æ–°æ’â¼Šçš„å…ƒç´ è¾ƒâ¼¤æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åç»­å…ƒç´ çš„ prevlen å â½¤ç©ºé—´éƒ½å‘â½£å˜åŒ–ï¼Œä»â½½å¼•èµ·ã€Œè¿é”æ›´æ–°ã€é—®é¢˜ï¼Œå¯¼è‡´æ¯ä¸ªå…ƒç´ çš„ç©ºé—´éƒ½è¦é‡æ–°åˆ†é…ï¼Œé€ æˆè®¿é—®å‹ç¼©åˆ—è¡¨æ€§èƒ½çš„ä¸‹é™ã€‚

### å¯¹è±¡

Redisé’ˆå¯¹å‰é¢æ‰€è¯´çš„ç±»å‹å»ºç«‹äº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿ, è¿™ä¸ªç³»åˆ—åŒ…æ‹¬å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡è¿™äº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œæ¯ç§å¯¹è±¡éƒ½ç”¨åˆ°äº†è‡³å°‘ä¸€ç§æˆ‘ä»¬å‰é¢æ‰€ä»‹ç»çš„æ•°æ®ç»“æ„ã€‚

Redisçš„æ€»å¯¹è±¡ç±»å‹æ˜¯
```c
typedef struct redisObject {
//ç±»å‹
unsigned type:4;
//ç¼–ç 
unsigned encoding:4;
//æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ
void *ptr;
// ...
} robj;
```

typeç±»å‹è®°å½•äº†å¯¹è±¡çš„ç±»å‹, è¿™ä¸ªç†Ÿæ‚‰å¯ä»¥æ˜¯REDIS_STRING, REDIS_LIST...

encodingå±æ€§è®°å½•äº†å¯¹è±¡åº•å±‚æ‰€ä½¿ç”¨çš„ç¼–ç , æ¯”å¦‚listçš„åº•å±‚å¯¹è±¡æ˜¯listæˆ–è€…quicklist, hashçš„åº•å±‚å¯¹è±¡æ˜¯ziplistæˆ–hash...


## 5ç§å¸¸è§çš„æ•°æ®ç±»å‹

### Stringå†…éƒ¨å®ç°

Stringçš„å†…éƒ¨å®ç°æ˜¯
SDS(ç®€å•åŠ¨æ€å­—ç¬¦ä¸²), æ˜¯å¯¹Cè¯­è¨€å­—ç¬¦ä¸²å°è£…äº†ä¸€å±‚

ä¸¾ä¸ªä¾‹å­
```
set msg "hello world"
OK
```

å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯intã€rawæˆ–è€…embstrã€‚

Redisä¼šæ–°å¢ä¸€ä¸ªé”®å€¼å¯¹, å…¶ä¸­: é”®å€¼å¯¹é”®æ˜¯ä¿å­˜msgçš„SDS, å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡SDS
```
struct sdshdr {
//è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡  ç­‰äºSDSæ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦
int len;
//è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡
int free;
//å­—èŠ‚æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²
char buf[];
};
```

å…¶ä¸­SDSä¿ç•™äº†Cå­—ç¬¦ä¸²ä¸­æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯'\0'çš„æƒ¯ä¾‹, ç›®çš„æ˜¯SDSå¯ä»¥ç›´æ¥é‡ç”¨Cå­—ç¬¦ä¸²å‡½æ•°åº“é‡Œçš„å‡½æ•°.

å¥½å¤„: 
1. å› ä¸ºSDSå†…éƒ¨æœ‰ä¸ªlenå±æ€§, æ‰€ä»¥å¦‚æœæƒ³è·å–å­—ç¬¦ä¸²é•¿åº¦å°±ç›´æ¥è¿”å›len, æ—¶é—´å¤æ‚åº¦æ˜¯O(1), ä½†å¦‚æœç”¨åŸç”Ÿstrlenå‡½æ•° æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(n)äº†
2. SDSä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡º,å› ä¸º SDS åœ¨æ‹¼æ¥å­—ç¬¦ä¸²ä¹‹å‰ä¼šæ£€æŸ¥ SDS ç©ºé—´æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜, å¯ä»¥å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°,ç©ºé—´é¢„åˆ†é…:å½“appendæ—¶å½“SDSé•¿åº¦å°äº1MB,åˆ™å†å¤šåˆ†é…ä¸€å€çš„ç©ºé—´ï¼›è‹¥å¤§äº1MB, åˆ™å¤šåˆ†é…1MBçš„ç©ºé—´ï¼›æƒ°æ€§ç©ºé—´é‡Šæ”¾, å½“éœ€è¦å‡å°‘SDSçš„ç©ºé—´æ—¶, ä¸ä¼šç«‹åˆ»å‡å°‘, å…ˆæ›´æ–°free, è¿™æ ·å¯ä»¥é¿å…å†æ¬¡åˆ†é…å¸¦æ¥çš„æ€§èƒ½æŸè€—, å½“ç„¶ä¹Ÿæœ‰çœŸæ­£çš„é‡Šæ”¾å†…å­˜ç©ºé—´çš„API.
3. SDS ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ã€‚å› ä¸º SDS ä½¿ç”¨ len å±æ€§çš„å€¼è€Œä¸æ˜¯ç©ºå­—ç¬¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸï¼Œå¹¶ä¸” SDS çš„æ‰€æœ‰ API éƒ½ä¼šä»¥å¤„ç†äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å¤„ç† SDS å­˜æ”¾åœ¨ buf[] æ•°ç»„é‡Œçš„æ•°æ®ã€‚æ‰€ä»¥ SDS ä¸å…‰èƒ½å­˜æ”¾æ–‡æœ¬æ•°æ®ï¼Œè€Œä¸”èƒ½ä¿å­˜å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®ã€‚

#### å‘½ä»¤
| å‘½ä»¤ | æè¿° |
| - | - |
| SET KEY VALUE |	è®¾ç½®æŒ‡å®š KEY çš„å€¼ |
| GET KEY |	è·å–æŒ‡å®š KEY çš„å€¼ |
| GETRANGE KEY start end  | è¿”å› KEY ä¸­å­—ç¬¦ä¸²å€¼çš„å­å­—ç¬¦|
| GETSET KEY value |	å°†ç»™å®š KEY çš„å€¼è®¾ä¸º value ï¼Œå¹¶è¿”å› KEY çš„æ—§å€¼|
| GETBIT KEY offset |	å¯¹ KEY æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè·å–æŒ‡å®šåç§»é‡ä¸Šçš„ä½|
| MGET KEY1 [KEY2â€¦] |	è·å–æ‰€æœ‰(ä¸€ä¸ªæˆ–å¤šä¸ª)ç»™å®š KEY çš„å€¼|
| SETBIT KEY offset value |	å¯¹ KEY æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè®¾ç½®æˆ–æ¸…é™¤æŒ‡å®šåç§»é‡ä¸Šçš„ä½|
| SETEX KEY seconds value |	å°†å€¼ value å…³è”åˆ° KEY ï¼Œå¹¶å°† KEY çš„è¿‡æœŸæ—¶é—´è®¾ä¸º seconds (ä»¥ç§’ä¸ºå•ä½)|
| SETNX KEY value |	åªæœ‰åœ¨ KEY ä¸å­˜åœ¨æ—¶è®¾ç½® KEY çš„å€¼|
| SETRANGE KEY offset value |	ç”¨ value å‚æ•°è¦†å†™ç»™å®š KEY æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œä»åç§»é‡ offset å¼€å§‹|
| STRLEN KEY |	è¿”å› KEY æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼çš„é•¿åº¦|
| MSET KEY value KEY value â€¦ 	|åŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ª KEY-value å¯¹|
| MSETNX KEY value KEY value â€¦  |	åŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ª KEY-value å¯¹ï¼Œå½“ä¸”ä»…å½“æ‰€æœ‰ç»™å®š KEY éƒ½ä¸å­˜åœ¨|
| PSETEX KEY milliseconds value |	è¿™ä¸ªå‘½ä»¤å’Œ SETEX å‘½ä»¤ç›¸ä¼¼ï¼Œä½†å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½® KEY çš„ç”Ÿå­˜æ—¶é—´|
| INCR KEY |	å°† KEY ä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢ä¸€ |
| INCRBY KEY increment |	å°† KEY æ‰€å‚¨å­˜çš„å€¼åŠ ä¸Šç»™å®šçš„å¢é‡å€¼ increment|
| INCRBYFLOAT KEY increment |	å°† KEY æ‰€å‚¨å­˜çš„å€¼åŠ ä¸Šç»™å®šçš„æµ®ç‚¹å¢é‡å€¼ increment|
| DECR KEY |	å°† KEY ä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€|
| DECRBY KEY decrement |	KEY æ‰€å‚¨å­˜çš„å€¼å‡å»ç»™å®šçš„å‡é‡å€¼ decrement|
| APPEND KEY value |	å¦‚æœ KEY å·²ç»å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ APPEND å‘½ä»¤å°†æŒ‡å®šçš„ value è¿½åŠ åˆ°è¯¥ KEY åŸæ¥å€¼çš„æœ«å°¾|
| BITCOUNT KEY START END 	|è®¡ç®—ç»™å®šå­—ç¬¦ä¸²ä¸­ï¼Œè¢«è®¾ç½®ä¸º 1 çš„æ¯”ç‰¹ä½çš„æ•°é‡|
| BITOP OPERATION DESTKEY KEY KEY â€¦ 	|å¯¹äºŒè¿›åˆ¶ä½è¿›è¡Œæ“ä½œ|

###  List ç±»å‹å†…éƒ¨å®ç°

Listçš„å†…éƒ¨å®ç°æ˜¯åŒå‘é“¾è¡¨æˆ–è€…å‹ç¼©åˆ—è¡¨

- å¦‚æœåˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± list-max-ziplist-entries é…ç½®ï¼‰ï¼Œåˆ—è¡¨æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äº 64 å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± list-max-ziplist-value é…ç½®ï¼‰ï¼ŒRedis ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º List ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœåˆ—è¡¨çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨åŒå‘é“¾è¡¨ä½œä¸º List ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›

ä½†æ˜¯åœ¨ Redis 3.2 ç‰ˆæœ¬ä¹‹åï¼ŒList æ•°æ®ç±»å‹åº•å±‚æ•°æ®ç»“æ„å°±åªç”± quicklist å®ç°äº†ï¼Œæ›¿ä»£äº†åŒå‘é“¾è¡¨å’Œå‹ç¼©åˆ—è¡¨ã€‚
#### å‘½ä»¤

| å‘½ä»¤ | æè¿° | 
| - | - |
| LPUSH KEY value1 value2 | å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ã€‚ |
| LPUSHX KEY value | å°†ä¸€ä¸ªå€¼æ’å…¥åˆ°å·²å­˜åœ¨çš„åˆ—è¡¨å¤´éƒ¨ã€‚ |
| RPUSH KEY value1 value2 |	å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨å°¾éƒ¨ã€‚ |
| RPUSHX KEY value | å°†ä¸€ä¸ªå€¼æ’å…¥åˆ°å·²å­˜åœ¨çš„åˆ—è¡¨å°¾éƒ¨ã€‚ |
| LSET KEY index value 	| å°†åˆ—è¡¨ç´¢å¼• index ä½ç½®çš„å€¼è®¾ç½®ä¸º valueã€‚ |
| LINSERT KEY BEFORE AFTER pivot value | å°†å€¼ value æ’å…¥åˆ°åˆ—è¡¨ KEY å½“ä¸­ï¼Œä½äºå€¼ pivot ä¹‹å‰æˆ–ä¹‹åã€‚ |
| LPOP KEY |	è·å–å¹¶ç§»é™¤åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚|
| RPOP KEY 	| è·å–å¹¶ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚|
| BLPOP KEY1 KEY2 timeout |	è·å–å¹¶ç§»é™¤åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°è¶…æ—¶æˆ–æœ‰å…ƒç´ å¯å¼¹å‡ºä¸ºæ­¢ã€‚|
| BRPOP KEY1 KEY2 timeout |	è·å–å¹¶ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°è¶…æ—¶æˆ–æœ‰å…ƒç´ å¯å¼¹å‡ºä¸ºæ­¢ã€‚|
| RPOPLPUSH source destination |	ç§»é™¤ source åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ·»åŠ åˆ°å¦ä¸€ä¸ªåˆ—è¡¨ destination çš„å¼€å¤´å¹¶è¿”å›ã€‚|
| BRPOPLPUSH source destination timeout | 1. BRPOPLPUSH æ˜¯ RPOPLPUSH çš„é˜»å¡ç‰ˆæœ¬ã€‚2. å½“ source æœ‰æ•°æ®æ—¶ï¼ŒBRPOPLPUSH çš„è¡¨ç°ä¸ RPOPLPUSH å®Œå…¨ä¸€æ ·ã€‚3. å½“ source æ˜¯ç©ºæ—¶ï¼Œä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°è¶…æ—¶æˆ–æœ‰å…ƒç´ å¯å¼¹å‡ºä¸ºæ­¢ã€‚|
| LLEN KEY |	è·å–åˆ—è¡¨é•¿åº¦ã€‚|
| LINDEX KEY index |	é€šè¿‡ç´¢å¼•è·å–åˆ—è¡¨ä¸­çš„å…ƒç´ ã€‚|
| LREM KEY count value |	ä»åˆ—è¡¨ä¸­ç§»é™¤ count ä¸ªå€¼ä¸ value ç›¸ç­‰çš„å…ƒç´ ã€‚|
| LTRIM KEY start stop |	å¯¹ä¸€ä¸ªåˆ—è¡¨è¿›è¡Œä¿®å‰ª(trim)ï¼Œåªä¿ç•™åˆ—è¡¨ä¸­çš„ start å’Œ stop ä¹‹é—´çš„å…ƒç´ ã€‚|
| LRANGE KEY start stop |	è·å–åˆ—è¡¨ start å’Œ stop ä¹‹é—´ çš„å…ƒç´ ã€‚|

### Hash ç±»å‹å†…éƒ¨å®ç°

Hash ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å‹ç¼©åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨å®ç°çš„ï¼š

- å¦‚æœå“ˆå¸Œç±»å‹å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± hash-max-ziplist-entries é…ç½®ï¼‰ï¼Œæ‰€æœ‰å€¼å°äº 64 å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± hash-max-ziplist-value é…ç½®ï¼‰çš„è¯ï¼ŒRedis ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º Hash ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœå“ˆå¸Œç±»å‹å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸º Hash ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„

åœ¨ Redis 7.0 ä¸­ï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æ„æ¥å®ç°äº†ã€‚

#### å‘½ä»¤

| å‘½ä»¤ |	æè¿° |
| - | - |
| HSET KEY field value |	å°†å“ˆå¸Œè¡¨ KEY ä¸­çš„å­—æ®µ field çš„å€¼è®¾ä¸º value ã€‚|
| HSETNX KEY field value | åªæœ‰åœ¨å­—æ®µ field ä¸å­˜åœ¨æ—¶ï¼Œè®¾ç½®å“ˆå¸Œè¡¨å­—æ®µçš„å€¼ã€‚ |
| HMSET KEY field1 value1 field2 value2 |	åŒæ—¶å°†å¤šä¸ª field-value (åŸŸ-å€¼)å¯¹è®¾ç½®åˆ°å“ˆå¸Œè¡¨ KEY ä¸­ã€‚|
| HGET KEY field |	è·å–å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼ã€‚|
| HGETALL KEY |	è·å–åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®š KEY çš„æ‰€æœ‰å­—æ®µå’Œå€¼ã€‚|
| HMGET KEY field1 field2 |	è·å–æ‰€æœ‰ç»™å®šå­—æ®µçš„å€¼ã€‚|
| HKEYS KEY |	è·å–æ‰€æœ‰å“ˆå¸Œè¡¨ä¸­çš„å­—æ®µã€‚|
| HVALS KEY |	è·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰å€¼ã€‚|
| HLEN KEY |	è·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡ã€‚|
| HINCRBY KEY field increment  | ä¸ºå“ˆå¸Œè¡¨ KEY ä¸­çš„æŒ‡å®šå­—æ®µçš„æ•´æ•°å€¼åŠ ä¸Šå¢é‡ increment ã€‚|
| HINCRBYFLOAT KEY field increment  |	ä¸ºå“ˆå¸Œè¡¨ KEY ä¸­çš„æŒ‡å®šå­—æ®µçš„æµ®ç‚¹æ•°å€¼åŠ ä¸Šå¢é‡ increment ã€‚|
| HDEL KEY field1 field2  | åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå“ˆå¸Œè¡¨å­—æ®µã€‚|
| HEXISTS KEY field | æŸ¥çœ‹å“ˆå¸Œè¡¨ KEY ä¸­ï¼ŒæŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨ã€‚|
| HSCAN KEY cursor [MATCH pattern] [COUNT count] | è¿­ä»£å“ˆå¸Œè¡¨ä¸­çš„é”®å€¼å¯¹ï¼Œç±»ä¼¼ SCAN å‘½ä»¤ã€‚|

> Set ç±»å‹å†…éƒ¨å®ç°

Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å“ˆå¸Œè¡¨æˆ–æ•´æ•°é›†åˆå®ç°çš„ï¼š

- å¦‚æœé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äº 512 ï¼ˆé»˜è®¤å€¼ï¼Œset-maxintset-entriesé…ç½®ï¼‰ä¸ªï¼ŒRedis ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœé›†åˆä¸­çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼Œåˆ™ Redis ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ã€‚

å½“ä»¥å“ˆå¸Œè¡¨å­˜å‚¨æ—¶, å€¼ä¸ºç©º, keyå°±æ˜¯æ‰€æœ‰çš„setçš„å€¼

#### å‘½ä»¤

| å‘½ä»¤ | æè¿° |
| - | - |
| SADD key member1 member2 | å‘é›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ã€‚ |
| SCARD | key | 	è·å–é›†åˆçš„æˆå‘˜æ•°ã€‚ |
| SDIFF key1 key2 |	è¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†ã€‚|
| SDIFFSTORE destination key1 key2 |	è¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†å¹¶å­˜å‚¨åœ¨ destination ä¸­ã€‚|
| SINTER key1 key2 |	è¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†ã€‚|
| SINTERSTORE destination key1 key2 | è¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åœ¨ destination ä¸­ã€‚|
| SISMEMBER key member |	åˆ¤æ–­ member å…ƒç´ æ˜¯å¦æ˜¯é›†åˆ key çš„æˆå‘˜ã€‚|
| SMEMBERS key |	è¿”å›é›†åˆä¸­çš„æ‰€æœ‰æˆå‘˜ã€‚|
| SMOVE source destination member |	å°† member å…ƒç´ ä» source é›†åˆç§»åŠ¨åˆ° destination é›†åˆã€‚|
| SPOP key |	ç§»é™¤å¹¶è¿”å›é›†åˆä¸­çš„ä¸€ä¸ªéšæœºå…ƒç´ ã€‚|
| SRANDMEMBER key count 	| è¿”å›é›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªéšæœºæ•°ã€‚|
| SREM key member1 member2| 	ç§»é™¤é›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ã€‚|
| SUNION key1 key2 | 	è¿”å›æ‰€æœ‰ç»™å®šé›†åˆçš„å¹¶é›†ã€‚|
| SUNIONSTORE destination key1 key2 | æ‰€æœ‰ç»™å®šé›†åˆçš„å¹¶é›†å­˜å‚¨åœ¨ destination é›†åˆä¸­ã€‚|
| SSCAN key cursor MATCH pattern COUNT count |	è¿­ä»£é›†åˆä¸­çš„å…ƒç´ ã€‚|


> ZSet ç±»å‹å†…éƒ¨å®ç°

Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±å‹ç¼©åˆ—è¡¨æˆ–è·³è¡¨å®ç°çš„ï¼š

- å¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº 128 ä¸ªï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äº 64 å­—èŠ‚æ—¶ï¼ŒRedis ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸º Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨è·³è¡¨ä½œä¸º Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›

åœ¨ Redis 7.0 ä¸­ï¼Œå‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æ„æ¥å®ç°äº†ã€‚

|å‘½ä»¤ |-	æè¿°|
| - | - |
|  ZADD KEY score1 member1 [score2 member2] |	å‘æœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œæˆ–è€…æ›´æ–°å·²å­˜åœ¨æˆå‘˜çš„åˆ†æ•°ã€‚|
|  ZCARD KEY |	è·å–æœ‰åºé›†åˆçš„æˆå‘˜æ•°ã€‚|
|  ZCOUNT KEY min max |	è®¡ç®—åœ¨æœ‰åºé›†åˆä¸­æŒ‡å®šåŒºé—´åˆ†æ•°çš„æˆå‘˜æ•°ã€‚|
|  ZINCRBY KEY increment member |	æœ‰åºé›†åˆä¸­å¯¹æŒ‡å®šæˆå‘˜çš„åˆ†æ•°åŠ ä¸Šå¢é‡ increment ã€‚|
|  ZINTERSTORE destination num KEY [KEY â€¦] |	è®¡ç®—ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰åºé›†çš„äº¤é›†å¹¶å°†ç»“æœé›†å­˜å‚¨åœ¨æ–°çš„æœ‰åºé›†åˆ KEY ä¸­ã€‚|
|  ZLEXCOUNT KEY min max |	åœ¨æœ‰åºé›†åˆä¸­è®¡ç®—æŒ‡å®šå­—å…¸åŒºé—´å†…æˆå‘˜æ•°é‡ã€‚|
|  ZRANGE KEY start stop [WITHSCORES] |	é€šè¿‡ç´¢å¼•åŒºé—´è¿”å›æœ‰åºé›†åˆæˆæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ã€‚|
|  ZRANGEBYLEX KEY min max [LIMIT offset count] |	é€šè¿‡å­—å…¸åŒºé—´è¿”å›æœ‰åºé›†åˆçš„æˆå‘˜ã€‚|
|  ZRANGEBYSCORE KEY min max [WITHSCORES] [LIMIT] |	é€šè¿‡åˆ†æ•°è¿”å›æœ‰åºé›†åˆæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ã€‚|
|  ZRANK KEY member |	è¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜çš„ç´¢å¼•ã€‚|
|  ZREM KEY member [member â€¦] |	ç§»é™¤æœ‰åºé›†åˆä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ã€‚|
|  ZREMRANGEBYLEX KEY min max |	ç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„å­—å…¸åŒºé—´çš„æ‰€æœ‰æˆå‘˜ã€‚|
|  ZREMRANGEBYRANK KEY start stop |	ç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„æ’ååŒºé—´çš„æ‰€æœ‰æˆå‘˜ã€‚|
|  ZREMRANGEBYSCORE KEY min max |	ç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„åˆ†æ•°åŒºé—´çš„æ‰€æœ‰æˆå‘˜ã€‚|
|  ZREVRANGE KEY start stop [WITHSCORES] |	è¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼Œé€šè¿‡ç´¢å¼•ï¼Œåˆ†æ•°ä»é«˜åˆ°åº•ã€‚|
|  ZREVRANGEBYSCORE KEY max min [WITHSCORES] |	è¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æˆå‘˜ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½æ’åºã€‚|
|  ZREVRANK KEY member |	è¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜çš„æ’åï¼Œæœ‰åºé›†æˆå‘˜æŒ‰åˆ†æ•°å€¼é€’å‡(ä»å¤§åˆ°å°)æ’åºã€‚|
|  ZSCORE KEY member |	è¿”å›æœ‰åºé›†ä¸­ï¼Œæˆå‘˜çš„åˆ†æ•°å€¼ã€‚|
|  ZUNIONSTORE destination numKEYs KEY [KEY â€¦] |	è®¡ç®—ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰åºé›†çš„å¹¶é›†ï¼Œå¹¶å­˜å‚¨åœ¨æ–°çš„ KEY ä¸­ã€‚|
|  ZSCAN KEY cursor [MATCH pattern] [COUNT count]  |	è¿­ä»£æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼ˆåŒ…æ‹¬å…ƒç´ æˆå‘˜å’Œå…ƒç´ åˆ†å€¼ï¼‰ã€‚|

## Redisçº¿ç¨‹æ¨¡å‹

Rediså•çº¿ç¨‹æŒ‡çš„æ˜¯åœ¨æ¥å—å®¢æˆ·ç«¯è¯·æ±‚,è§£æè¯·æ±‚,è¿›è¡Œæ•°æ®è¯»å†™,å‘é€ç»™å®¢æˆ·ç«¯è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„

ä½†æ˜¯ï¼ŒRedis ç¨‹åºå¹¶ä¸æ˜¯å•çº¿ç¨‹çš„ï¼ŒRedis åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯ä¼šå¯åŠ¨åå°çº¿ç¨‹ï¼ˆBIOï¼‰çš„

- Redis åœ¨ 2.6 ç‰ˆæœ¬ï¼Œä¼šå¯åŠ¨ 2 ä¸ªåå°çº¿ç¨‹ï¼Œåˆ†åˆ«å¤„ç†å…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜è¿™ä¸¤ä¸ªä»»åŠ¡ï¼›
- Redis åœ¨ 4.0 ç‰ˆæœ¬ä¹‹åï¼Œæ–°å¢äº†ä¸€ä¸ªæ–°çš„åå°çº¿ç¨‹ï¼Œç”¨æ¥å¼‚æ­¥é‡Šæ”¾ Redis å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ lazyfree çº¿ç¨‹ã€‚ä¾‹å¦‚æ‰§è¡Œ unlink key / flushdb async / flushall async ç­‰å‘½ä»¤ï¼Œä¼šæŠŠè¿™äº›åˆ é™¤æ“ä½œäº¤ç»™åå°çº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¥½å¤„æ˜¯ä¸ä¼šå¯¼è‡´ Redis ä¸»çº¿ç¨‹å¡é¡¿ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è¦åˆ é™¤ä¸€ä¸ªå¤§ key çš„æ—¶å€™ï¼Œä¸è¦ä½¿ç”¨ del å‘½ä»¤åˆ é™¤ï¼Œå› ä¸º del æ˜¯åœ¨ä¸»çº¿ç¨‹å¤„ç†çš„ï¼Œè¿™æ ·ä¼šå¯¼è‡´ Redis ä¸»çº¿ç¨‹å¡é¡¿ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥ä½¿ç”¨ unlink å‘½ä»¤æ¥å¼‚æ­¥åˆ é™¤å¤§keyã€‚

ä¹‹æ‰€ä»¥ Redis ä¸ºã€Œå…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜ã€é‡Šæ”¾å†…å­˜ã€è¿™äº›ä»»åŠ¡åˆ›å»ºå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†ï¼Œæ˜¯å› ä¸ºè¿™äº›ä»»åŠ¡çš„æ“ä½œéƒ½æ˜¯å¾ˆè€—æ—¶çš„ï¼Œå¦‚æœæŠŠè¿™äº›ä»»åŠ¡éƒ½æ”¾åœ¨ä¸»çº¿ç¨‹æ¥å¤„ç†ï¼Œé‚£ä¹ˆ Redis ä¸»çº¿ç¨‹å°±å¾ˆå®¹æ˜“å‘ç”Ÿé˜»å¡ï¼Œè¿™æ ·å°±æ— æ³•å¤„ç†åç»­çš„è¯·æ±‚äº†ã€‚

åå°çº¿ç¨‹ç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…æŠŠè€—æ—¶ä»»åŠ¡ä¸¢åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…ï¼ˆBIOï¼‰ä¸åœè½®è¯¢è¿™ä¸ªé˜Ÿåˆ—ï¼Œæ‹¿å‡ºä»»åŠ¡å°±å»æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å³å¯ã€‚

## Redis é‡‡ç”¨å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜è¿™ä¹ˆå¿«ï¼Ÿ

- Redis çš„å¤§éƒ¨åˆ†æ“ä½œéƒ½åœ¨å†…å­˜ä¸­å®Œæˆï¼Œå¹¶ä¸”é‡‡ç”¨äº†é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå› æ­¤ Redis ç“¶é¢ˆå¯èƒ½æ˜¯æœºå™¨çš„å†…å­˜æˆ–è€…ç½‘ç»œå¸¦å®½ï¼Œè€Œå¹¶é CPUï¼Œæ—¢ç„¶ CPU ä¸æ˜¯ç“¶é¢ˆï¼Œé‚£ä¹ˆè‡ªç„¶å°±é‡‡ç”¨å•çº¿ç¨‹çš„è§£å†³æ–¹æ¡ˆäº†ï¼›
- Redis é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹å¯ä»¥é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œçœå»äº†å¤šçº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„æ—¶é—´å’Œæ€§èƒ½ä¸Šçš„å¼€é”€ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå¯¼è‡´æ­»é”é—®é¢˜ã€‚
- Redis é‡‡ç”¨äº† I/O å¤šè·¯å¤ç”¨æœºåˆ¶å¤„ç†å¤§é‡çš„å®¢æˆ·ç«¯ Socket è¯·æ±‚ï¼ŒIO å¤šè·¯å¤ç”¨æœºåˆ¶æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ª IO æµï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ select/epoll æœºåˆ¶ã€‚ç®€å•æ¥è¯´ï¼Œåœ¨ Redis åªè¿è¡Œå•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œè¯¥æœºåˆ¶å…è®¸å†…æ ¸ä¸­ï¼ŒåŒæ—¶å­˜åœ¨å¤šä¸ªç›‘å¬ Socket å’Œå·²è¿æ¥ Socketã€‚å†…æ ¸ä¼šä¸€ç›´ç›‘å¬è¿™äº› Socket ä¸Šçš„è¿æ¥è¯·æ±‚æˆ–æ•°æ®è¯·æ±‚ã€‚ä¸€æ—¦æœ‰è¯·æ±‚åˆ°è¾¾ï¼Œå°±ä¼šäº¤ç»™ Redis çº¿ç¨‹å¤„ç†ï¼Œè¿™å°±å®ç°äº†ä¸€ä¸ª Redis çº¿ç¨‹å¤„ç†å¤šä¸ª IO æµçš„æ•ˆæœã€‚

CPU å¹¶ä¸æ˜¯åˆ¶çº¦ Redis æ€§èƒ½è¡¨ç°çš„ç“¶é¢ˆæ‰€åœ¨ï¼Œæ›´å¤šæƒ…å†µä¸‹æ˜¯å—åˆ°å†…å­˜å¤§å°å’Œç½‘ç»œI/Oçš„é™åˆ¶ï¼Œæ‰€ä»¥ Redis æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä½¿ç”¨å•çº¿ç¨‹å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚æœä½ æƒ³è¦ä½¿ç”¨æœåŠ¡çš„å¤šæ ¸CPUï¼Œå¯ä»¥åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šå¯åŠ¨å¤šä¸ªèŠ‚ç‚¹æˆ–è€…é‡‡ç”¨åˆ†ç‰‡é›†ç¾¤çš„æ–¹å¼ã€‚

é™¤äº†ä¸Šé¢çš„å®˜æ–¹å›ç­”ï¼Œé€‰æ‹©å•çº¿ç¨‹çš„åŸå› ä¹Ÿæœ‰ä¸‹é¢çš„è€ƒè™‘ã€‚

ä½¿ç”¨äº†å•çº¿ç¨‹åï¼Œå¯ç»´æŠ¤æ€§é«˜ï¼Œå¤šçº¿ç¨‹æ¨¡å‹è™½ç„¶åœ¨æŸäº›æ–¹é¢è¡¨ç°ä¼˜å¼‚ï¼Œä½†æ˜¯å®ƒå´å¼•å…¥äº†ç¨‹åºæ‰§è¡Œé¡ºåºçš„ä¸ç¡®å®šæ€§ï¼Œå¸¦æ¥äº†å¹¶å‘è¯»å†™çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œå¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦ã€åŒæ—¶å¯èƒ½å­˜åœ¨çº¿ç¨‹åˆ‡æ¢ã€ç”šè‡³åŠ é”è§£é”ã€æ­»é”é€ æˆçš„æ€§èƒ½æŸè€—ã€‚

åœ¨ Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼Œä¹Ÿé‡‡ç”¨äº†å¤šä¸ª I/O çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œè¿™æ˜¯å› ä¸ºéšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼ŒRedis çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ I/O çš„å¤„ç†ä¸Šã€‚

æ‰€ä»¥ä¸ºäº†æé«˜ç½‘ç»œ I/O çš„å¹¶è¡Œåº¦ï¼ŒRedis 6.0 å¯¹äºç½‘ç»œ I/O é‡‡ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†ã€‚ä½†æ˜¯å¯¹äºå‘½ä»¤çš„æ‰§è¡Œï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ï¼Œæ‰€ä»¥å¤§å®¶ä¸è¦è¯¯è§£ Redis æœ‰å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œå‘½ä»¤ã€‚

## RedisæŒä¹…åŒ–

Redis å¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ

- AOF æ—¥å¿—ï¼šæ¯æ‰§è¡Œä¸€æ¡å†™æ“ä½œå‘½ä»¤ï¼Œå°±æŠŠè¯¥å‘½ä»¤ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼›
- RDB å¿«ç…§ï¼šå°†æŸä¸€æ—¶åˆ»çš„å†…å­˜æ•°æ®ï¼Œä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å†™å…¥ç£ç›˜ï¼›
- æ··åˆæŒä¹…åŒ–æ–¹å¼ï¼šRedis 4.0 æ–°å¢çš„æ–¹å¼ï¼Œé›†æˆäº† AOF å’Œ RBD çš„ä¼˜ç‚¹ï¼›

AOF æ—¥å¿—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

Redis åœ¨æ‰§è¡Œå®Œä¸€æ¡å†™æ“ä½œå‘½ä»¤åï¼Œå°±ä¼šæŠŠè¯¥å‘½ä»¤ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œç„¶å Redis é‡å¯æ—¶ï¼Œä¼šè¯»å–è¯¥æ–‡ä»¶è®°å½•çš„å‘½ä»¤ï¼Œç„¶åé€ä¸€æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®æ¢å¤ã€‚

> ä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå‘½ä»¤ï¼Œå†æŠŠæ•°æ®å†™å…¥æ—¥å¿—å‘¢ï¼Ÿ

- é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€ï¼šå› ä¸ºå¦‚æœå…ˆå°†å†™æ“ä½œå‘½ä»¤è®°å½•åˆ° AOF æ—¥å¿—é‡Œï¼Œå†æ‰§è¡Œè¯¥å‘½ä»¤çš„è¯ï¼Œå¦‚æœå½“å‰çš„å‘½ä»¤è¯­æ³•æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆå¦‚æœä¸è¿›è¡Œå‘½ä»¤è¯­æ³•æ£€æŸ¥ï¼Œè¯¥é”™è¯¯çš„å‘½ä»¤è®°å½•åˆ° AOF æ—¥å¿—é‡Œåï¼ŒRedis åœ¨ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºé”™ã€‚
- ä¸ä¼šé˜»å¡å½“å‰å†™æ“ä½œå‘½ä»¤çš„æ‰§è¡Œï¼šå› ä¸ºå½“å†™æ“ä½œå‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œæ‰ä¼šå°†å‘½ä»¤è®°å½•åˆ° AOF æ—¥å¿—ã€‚

å½“ç„¶ï¼Œè¿™æ ·åšä¹Ÿä¼šå¸¦æ¥é£é™©ï¼š

- æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ï¼š æ‰§è¡Œå†™æ“ä½œå‘½ä»¤å’Œè®°å½•æ—¥å¿—æ˜¯ä¸¤ä¸ªè¿‡ç¨‹ï¼Œé‚£å½“ Redis åœ¨è¿˜æ²¡æ¥å¾—åŠå°†å‘½ä»¤å†™å…¥åˆ°ç¡¬ç›˜æ—¶ï¼ŒæœåŠ¡å™¨å‘ç”Ÿå®•æœºäº†ï¼Œè¿™ä¸ªæ•°æ®å°±ä¼šæœ‰ä¸¢å¤±çš„é£é™©ã€‚
- å¯èƒ½é˜»å¡å…¶ä»–æ“ä½œï¼š ç”±äºå†™æ“ä½œå‘½ä»¤æ‰§è¡ŒæˆåŠŸåæ‰è®°å½•åˆ° AOF æ—¥å¿—ï¼Œæ‰€ä»¥ä¸ä¼šé˜»å¡å½“å‰å‘½ä»¤çš„æ‰§è¡Œï¼Œä½†å› ä¸º AOF æ—¥å¿—ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥å½“ Redis æŠŠæ—¥å¿—æ–‡ä»¶å†™å…¥ç£ç›˜çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šé˜»å¡åç»­çš„æ“ä½œæ— æ³•æ‰§è¡Œã€‚

> AOF å†™å›ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ
- Alwaysï¼Œè¿™ä¸ªå•è¯çš„æ„æ€æ˜¯ã€Œæ€»æ˜¯ã€ï¼Œæ‰€ä»¥å®ƒçš„æ„æ€æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼ŒåŒæ­¥å°† AOF æ—¥å¿—æ•°æ®å†™å›ç¡¬ç›˜ï¼›
- Everysecï¼Œè¿™ä¸ªå•è¯çš„æ„æ€æ˜¯ã€Œæ¯ç§’ã€ï¼Œæ‰€ä»¥å®ƒçš„æ„æ€æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶çš„å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åæ¯éš”ä¸€ç§’å°†ç¼“å†²åŒºé‡Œçš„å†…å®¹å†™å›åˆ°ç¡¬ç›˜ï¼›
- Noï¼Œæ„å‘³ç€ä¸ç”± Redis æ§åˆ¶å†™å›ç¡¬ç›˜çš„æ—¶æœºï¼Œè½¬äº¤ç»™æ“ä½œç³»ç»Ÿæ§åˆ¶å†™å›çš„æ—¶æœºï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶çš„å†…æ ¸ç¼“å†²åŒºï¼Œå†ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç¡¬ç›˜ã€‚

> AOF æ—¥å¿—è¿‡å¤§ï¼Œä¼šè§¦å‘ä»€ä¹ˆæœºåˆ¶ï¼Ÿ

Redis ä¸ºäº†é¿å… AOF æ–‡ä»¶è¶Šå†™è¶Šå¤§ï¼Œæä¾›äº† AOF é‡å†™æœºåˆ¶ï¼Œå½“ AOF æ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼åï¼ŒRedis å°±ä¼šå¯ç”¨ AOF é‡å†™æœºåˆ¶ï¼Œæ¥å‹ç¼© AOF æ–‡ä»¶ã€‚

> RDB å¿«ç…§æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

å› ä¸º AOF æ—¥å¿—è®°å½•çš„æ˜¯æ“ä½œå‘½ä»¤ï¼Œä¸æ˜¯å®é™…çš„æ•°æ®ï¼Œæ‰€ä»¥ç”¨ AOF æ–¹æ³•åšæ•…éšœæ¢å¤æ—¶ï¼Œéœ€è¦å…¨é‡æŠŠæ—¥å¿—éƒ½æ‰§è¡Œä¸€éï¼Œä¸€æ—¦ AOF æ—¥å¿—éå¸¸å¤šï¼ŒåŠ¿å¿…ä¼šé€ æˆ Redis çš„æ¢å¤æ“ä½œç¼“æ…¢ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis å¢åŠ äº† RDB å¿«ç…§ã€‚æ‰€è°“çš„å¿«ç…§ï¼Œå°±æ˜¯è®°å½•æŸä¸€ä¸ªç¬é—´ä¸œè¥¿ï¼Œæ¯”å¦‚å½“æˆ‘ä»¬ç»™é£æ™¯æ‹ç…§æ—¶ï¼Œé‚£ä¸€ä¸ªç¬é—´çš„ç”»é¢å’Œä¿¡æ¯å°±è®°å½•åˆ°äº†ä¸€å¼ ç…§ç‰‡ã€‚

æ‰€ä»¥ï¼ŒRDB å¿«ç…§å°±æ˜¯è®°å½•æŸä¸€ä¸ªç¬é—´çš„å†…å­˜æ•°æ®ï¼Œè®°å½•çš„æ˜¯å®é™…æ•°æ®ï¼Œè€Œ AOF æ–‡ä»¶è®°å½•çš„æ˜¯å‘½ä»¤æ“ä½œçš„æ—¥å¿—ï¼Œè€Œä¸æ˜¯å®é™…çš„æ•°æ®ã€‚

å› æ­¤åœ¨ Redis æ¢å¤æ•°æ®æ—¶ï¼Œ RDB æ¢å¤æ•°æ®çš„æ•ˆç‡ä¼šæ¯” AOF é«˜äº›ï¼Œå› ä¸ºç›´æ¥å°† RDB æ–‡ä»¶è¯»å…¥å†…å­˜å°±å¯ä»¥ï¼Œä¸éœ€è¦åƒ AOF é‚£æ ·è¿˜éœ€è¦é¢å¤–æ‰§è¡Œæ“ä½œå‘½ä»¤çš„æ­¥éª¤æ‰èƒ½æ¢å¤æ•°æ®ã€‚

> RDB åšå¿«ç…§æ—¶ä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿ

Redis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ save å’Œ bgsaveï¼Œä»–ä»¬çš„åŒºåˆ«å°±åœ¨äºæ˜¯å¦åœ¨ã€Œä¸»çº¿ç¨‹ã€é‡Œæ‰§è¡Œï¼š

- æ‰§è¡Œäº† save å‘½ä»¤ï¼Œå°±ä¼šåœ¨ä¸»çº¿ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç”±äºå’Œæ‰§è¡Œæ“ä½œå‘½ä»¤åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å¦‚æœå†™å…¥ RDB æ–‡ä»¶çš„æ—¶é—´å¤ªé•¿ï¼Œä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼›
- æ‰§è¡Œäº† bgsave å‘½ä»¤ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸»çº¿ç¨‹çš„é˜»å¡ï¼›

Redis è¿˜å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶çš„é€‰é¡¹æ¥å®ç°æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ bgsave å‘½ä»¤ï¼Œé»˜è®¤ä¼šæä¾›ä»¥ä¸‹é…ç½®ï¼š

è¿™é‡Œæä¸€ç‚¹ï¼ŒRedis çš„å¿«ç…§æ˜¯å…¨é‡å¿«ç…§ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡æ‰§è¡Œå¿«ç…§ï¼Œéƒ½æ˜¯æŠŠå†…å­˜ä¸­çš„ã€Œæ‰€æœ‰æ•°æ®ã€éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚æ‰€ä»¥æ‰§è¡Œå¿«ç…§æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„æ“ä½œï¼Œå¦‚æœé¢‘ç‡å¤ªé¢‘ç¹ï¼Œå¯èƒ½ä¼šå¯¹ Redis æ€§èƒ½äº§ç”Ÿå½±å“ã€‚å¦‚æœé¢‘ç‡å¤ªä½ï¼ŒæœåŠ¡å™¨æ•…éšœæ—¶ï¼Œä¸¢å¤±çš„æ•°æ®ä¼šæ›´å¤šã€‚

>  ä¸ºä»€ä¹ˆä¼šæœ‰æ··åˆæŒä¹…åŒ–

æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š

    æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚

æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š

    AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›
    å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚

> Redis å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ

è¦æƒ³è®¾è®¡ä¸€ä¸ªé«˜å¯ç”¨çš„ Redis æœåŠ¡ï¼Œä¸€å®šè¦ä» Redis çš„å¤šæœåŠ¡èŠ‚ç‚¹æ¥è€ƒè™‘ï¼Œæ¯”å¦‚ Redis çš„ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€åˆ‡ç‰‡é›†ç¾¤ã€‚

> ä¸»ä»å¤åˆ¶
ä¸»ä»å¤åˆ¶æ˜¯ Redis é«˜å¯ç”¨æœåŠ¡çš„æœ€åŸºç¡€çš„ä¿è¯ï¼Œå®ç°æ–¹æ¡ˆå°±æ˜¯å°†ä»å‰çš„ä¸€å° Redis æœåŠ¡å™¨ï¼ŒåŒæ­¥æ•°æ®åˆ°å¤šå°ä» Redis æœåŠ¡å™¨ä¸Šï¼Œå³ä¸€ä¸»å¤šä»çš„æ¨¡å¼ï¼Œä¸”ä¸»ä»æœåŠ¡å™¨ä¹‹é—´é‡‡ç”¨çš„æ˜¯ã€Œè¯»å†™åˆ†ç¦»ã€çš„æ–¹å¼ã€‚

ä¸»æœåŠ¡å™¨å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œå½“å‘ç”Ÿå†™æ“ä½œæ—¶è‡ªåŠ¨å°†å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨ä¸€èˆ¬æ˜¯åªè¯»ï¼Œå¹¶æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥å†™æ“ä½œå‘½ä»¤ï¼Œç„¶åæ‰§è¡Œè¿™æ¡å‘½ä»¤ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿®æ”¹åªåœ¨ä¸»æœåŠ¡å™¨ä¸Šè¿›è¡Œï¼Œç„¶åå°†æœ€æ–°çš„æ•°æ®åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·å°±ä½¿å¾—ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚

æ³¨æ„ï¼Œä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„å‘½ä»¤å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ã€‚

å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸»ä»æœåŠ¡å™¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»æœåŠ¡å™¨æ”¶åˆ°æ–°çš„å†™å‘½ä»¤åï¼Œä¼šå‘é€ç»™ä»æœåŠ¡å™¨ã€‚ä½†æ˜¯ï¼Œä¸»æœåŠ¡å™¨å¹¶ä¸ä¼šç­‰åˆ°ä»æœåŠ¡å™¨å®é™…æ‰§è¡Œå®Œå‘½ä»¤åï¼Œå†æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ä¸»æœåŠ¡å™¨è‡ªå·±åœ¨æœ¬åœ°æ‰§è¡Œå®Œå‘½ä»¤åï¼Œå°±ä¼šå‘å®¢æˆ·ç«¯è¿”å›ç»“æœäº†ã€‚å¦‚æœä»æœåŠ¡å™¨è¿˜æ²¡æœ‰æ‰§è¡Œä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥çš„å‘½ä»¤ï¼Œä¸»ä»æœåŠ¡å™¨é—´çš„æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚

æ‰€ä»¥ï¼Œæ— æ³•å®ç°å¼ºä¸€è‡´æ€§ä¿è¯ï¼ˆä¸»ä»æ•°æ®æ—¶æ—¶åˆ»åˆ»ä¿æŒä¸€è‡´ï¼‰ï¼Œæ•°æ®ä¸ä¸€è‡´æ˜¯éš¾ä»¥é¿å…çš„ã€‚

> å“¨å…µæ¨¡å¼

åœ¨ä½¿ç”¨ Redis ä¸»ä»æœåŠ¡çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ Redis çš„ä¸»ä»æœåŠ¡å™¨å‡ºç°æ•…éšœå®•æœºæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è¿›è¡Œæ¢å¤ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis å¢åŠ äº†å“¨å…µæ¨¡å¼ï¼ˆRedis Sentinelï¼‰ï¼Œå› ä¸ºå“¨å…µæ¨¡å¼åšåˆ°äº†å¯ä»¥ç›‘æ§ä¸»ä»æœåŠ¡å™¨ï¼Œå¹¶ä¸”æä¾›ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»çš„åŠŸèƒ½ã€‚

> åˆ‡ç‰‡é›†ç¾¤æ¨¡å¼

å½“ Redis ç¼“å­˜æ•°æ®é‡å¤§åˆ°ä¸€å°æœåŠ¡å™¨æ— æ³•ç¼“å­˜æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ Redis åˆ‡ç‰‡é›†ç¾¤ï¼ˆRedis Cluster ï¼‰æ–¹æ¡ˆï¼Œå®ƒå°†æ•°æ®åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä»¥æ­¤æ¥é™ä½ç³»ç»Ÿå¯¹å•ä¸»èŠ‚ç‚¹çš„ä¾èµ–ï¼Œä»è€Œæé«˜ Redis æœåŠ¡çš„è¯»å†™æ€§èƒ½ã€‚

Redis Cluster æ–¹æ¡ˆé‡‡ç”¨å“ˆå¸Œæ§½ï¼ˆHash Slotï¼‰ï¼Œæ¥å¤„ç†æ•°æ®å’ŒèŠ‚ç‚¹ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚åœ¨ Redis Cluster æ–¹æ¡ˆä¸­ï¼Œä¸€ä¸ªåˆ‡ç‰‡é›†ç¾¤å…±æœ‰ 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œè¿™äº›å“ˆå¸Œæ§½ç±»ä¼¼äºæ•°æ®åˆ†åŒºï¼Œæ¯ä¸ªé”®å€¼å¯¹éƒ½ä¼šæ ¹æ®å®ƒçš„ keyï¼Œè¢«æ˜ å°„åˆ°ä¸€ä¸ªå“ˆå¸Œæ§½ä¸­ï¼Œå…·ä½“æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºä¸¤å¤§æ­¥ï¼š

    æ ¹æ®é”®å€¼å¯¹çš„ keyï¼ŒæŒ‰ç…§ CRC16 ç®—æ³•

   è®¡ç®—ä¸€ä¸ª 16 bit çš„å€¼ã€‚
    å†ç”¨ 16bit å€¼å¯¹ 16384 å–æ¨¡ï¼Œå¾—åˆ° 0~16383 èŒƒå›´å†…çš„æ¨¡æ•°ï¼Œæ¯ä¸ªæ¨¡æ•°ä»£è¡¨ä¸€ä¸ªç›¸åº”ç¼–å·çš„å“ˆå¸Œæ§½ã€‚

æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œè¿™äº›å“ˆå¸Œæ§½æ€ä¹ˆè¢«æ˜ å°„åˆ°å…·ä½“çš„ Redis èŠ‚ç‚¹ä¸Šçš„å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

    å¹³å‡åˆ†é…ï¼š åœ¨ä½¿ç”¨ cluster create å‘½ä»¤åˆ›å»º Redis é›†ç¾¤æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨æŠŠæ‰€æœ‰å“ˆå¸Œæ§½å¹³å‡åˆ†å¸ƒåˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚é›†ç¾¤ä¸­æœ‰ 9 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ§½çš„ä¸ªæ•°ä¸º 16384/9 ä¸ªã€‚
    æ‰‹åŠ¨åˆ†é…ï¼š å¯ä»¥ä½¿ç”¨ cluster meet å‘½ä»¤æ‰‹åŠ¨å»ºç«‹èŠ‚ç‚¹é—´çš„è¿æ¥ï¼Œç»„æˆé›†ç¾¤ï¼Œå†ä½¿ç”¨ cluster addslots å‘½ä»¤ï¼ŒæŒ‡å®šæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½ä¸ªæ•°ã€‚

ä¸ºäº†æ–¹ä¾¿ä½ çš„ç†è§£ï¼Œæˆ‘é€šè¿‡ä¸€å¼ å›¾æ¥è§£é‡Šæ•°æ®ã€å“ˆå¸Œæ§½ï¼Œä»¥åŠèŠ‚ç‚¹ä¸‰è€…çš„æ˜ å°„åˆ†å¸ƒå…³ç³»ã€‚

é›†ç¾¤è„‘è£‚å¯¼è‡´æ•°æ®ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ
  ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿ
  æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†ã€‚

> è§£å†³æ–¹æ¡ˆ

## Redis è¿‡æœŸåˆ é™¤ä¸å†…å­˜æ·˜æ±°

Redis æ˜¯å¯ä»¥å¯¹ key è®¾ç½®è¿‡æœŸæ—¶é—´çš„ï¼Œå› æ­¤éœ€è¦æœ‰ç›¸åº”çš„æœºåˆ¶å°†å·²è¿‡æœŸçš„é”®å€¼å¯¹åˆ é™¤ï¼Œè€Œåšè¿™ä¸ªå·¥ä½œçš„å°±æ˜¯è¿‡æœŸé”®å€¼åˆ é™¤ç­–ç•¥ã€‚

æ¯å½“æˆ‘ä»¬å¯¹ä¸€ä¸ª key è®¾ç½®äº†è¿‡æœŸæ—¶é—´æ—¶ï¼ŒRedis ä¼šæŠŠè¯¥ key å¸¦ä¸Šè¿‡æœŸæ—¶é—´å­˜å‚¨åˆ°ä¸€ä¸ªè¿‡æœŸå­—å…¸ï¼ˆexpires dictï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ã€Œè¿‡æœŸå­—å…¸ã€ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰ key çš„è¿‡æœŸæ—¶é—´ã€‚

å½“æˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸ª key æ—¶ï¼ŒRedis é¦–å…ˆæ£€æŸ¥è¯¥ key æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ä¸­ï¼š

    å¦‚æœä¸åœ¨ï¼Œåˆ™æ­£å¸¸è¯»å–é”®å€¼ï¼›
    å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šè·å–è¯¥ key çš„è¿‡æœŸæ—¶é—´ï¼Œç„¶åä¸å½“å‰ç³»ç»Ÿæ—¶é—´è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ¯”ç³»ç»Ÿæ—¶é—´å¤§ï¼Œé‚£å°±æ²¡æœ‰è¿‡æœŸï¼Œå¦åˆ™åˆ¤å®šè¯¥ key å·²è¿‡æœŸã€‚

Redis ä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ã€Œæƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤ã€è¿™ä¸¤ç§ç­–ç•¥é…å’Œä½¿ç”¨ã€‚

> ä»€ä¹ˆæ˜¯æƒ°æ€§åˆ é™¤ç­–ç•¥ï¼Ÿ

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œä¸ä¸»åŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œæ¯æ¬¡ä»æ•°æ®åº“è®¿é—® key æ—¶ï¼Œéƒ½æ£€æµ‹ key æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤è¯¥ keyã€‚

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„ä¼˜ç‚¹ï¼š

    å› ä¸ºæ¯æ¬¡è®¿é—®æ—¶ï¼Œæ‰ä¼šæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸï¼Œæ‰€ä»¥æ­¤ç­–ç•¥åªä¼šä½¿ç”¨å¾ˆå°‘çš„ç³»ç»Ÿèµ„æºï¼Œå› æ­¤ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹ CPU æ—¶é—´æœ€å‹å¥½ã€‚

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„ç¼ºç‚¹ï¼š

    å¦‚æœä¸€ä¸ª key å·²ç»è¿‡æœŸï¼Œè€Œè¿™ä¸ª key åˆä»ç„¶ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªè¿‡æœŸ key ä¸€ç›´æ²¡æœ‰è¢«è®¿é—®ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜å°±ä¸ä¼šé‡Šæ”¾ï¼Œé€ æˆäº†ä¸€å®šçš„å†…å­˜ç©ºé—´æµªè´¹ã€‚æ‰€ä»¥ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹å†…å­˜ä¸å‹å¥½ã€‚

> Redis æŒä¹…åŒ–æ—¶ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†çš„ï¼Ÿ

Redis æŒä¹…åŒ–æ–‡ä»¶æœ‰ä¸¤ç§æ ¼å¼ï¼šRDBï¼ˆRedis Databaseï¼‰å’Œ AOFï¼ˆAppend Only Fileï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹è¿‡æœŸé”®åœ¨è¿™ä¸¤ç§æ ¼å¼ä¸­çš„å‘ˆç°çŠ¶æ€ã€‚

RDB æ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒRDB æ–‡ä»¶ç”Ÿæˆé˜¶æ®µå’ŒåŠ è½½é˜¶æ®µã€‚

    RDB æ–‡ä»¶ç”Ÿæˆé˜¶æ®µï¼šä»å†…å­˜çŠ¶æ€æŒä¹…åŒ–æˆ RDBï¼ˆæ–‡ä»¶ï¼‰çš„æ—¶å€™ï¼Œä¼šå¯¹ key è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œè¿‡æœŸçš„é”®ã€Œä¸ä¼šã€è¢«ä¿å­˜åˆ°æ–°çš„ RDB æ–‡ä»¶ä¸­ï¼Œå› æ­¤ Redis ä¸­çš„è¿‡æœŸé”®ä¸ä¼šå¯¹ç”Ÿæˆæ–° RDB æ–‡ä»¶äº§ç”Ÿä»»ä½•å½±å“ã€‚
    RDB åŠ è½½é˜¶æ®µï¼šRDB åŠ è½½é˜¶æ®µæ—¶ï¼Œè¦çœ‹æœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨è¿˜æ˜¯ä»æœåŠ¡å™¨ï¼Œåˆ†åˆ«å¯¹åº”ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š
        å¦‚æœ Redis æ˜¯ã€Œä¸»æœåŠ¡å™¨ã€è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ã€Œä¸ä¼šã€è¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚æ‰€ä»¥è¿‡æœŸé”®ä¸ä¼šå¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä¸»æœåŠ¡å™¨é€ æˆå½±å“ï¼›
        å¦‚æœ Redis æ˜¯ã€Œä»æœåŠ¡å™¨ã€è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¸è®ºé”®æ˜¯å¦è¿‡æœŸéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ä½†ç”±äºä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œè¿‡æœŸé”®å¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä»æœåŠ¡å™¨ä¹Ÿä¸ä¼šé€ æˆå½±å“ã€‚

AOF æ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒAOF æ–‡ä»¶å†™å…¥é˜¶æ®µå’Œ AOF é‡å†™é˜¶æ®µã€‚

    AOF æ–‡ä»¶å†™å…¥é˜¶æ®µï¼šå½“ Redis ä»¥ AOF æ¨¡å¼æŒä¹…åŒ–æ—¶ï¼Œå¦‚æœæ•°æ®åº“æŸä¸ªè¿‡æœŸé”®è¿˜æ²¡è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¼šä¿ç•™æ­¤è¿‡æœŸé”®ï¼Œå½“æ­¤è¿‡æœŸé”®è¢«åˆ é™¤åï¼ŒRedis ä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤æ¥æ˜¾å¼åœ°åˆ é™¤è¯¥é”®å€¼ã€‚
    AOF é‡å†™é˜¶æ®µï¼šæ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œä¼šå¯¹ Redis ä¸­çš„é”®å€¼å¯¹è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„ AOF æ–‡ä»¶ä¸­ï¼Œå› æ­¤ä¸ä¼šå¯¹ AOF é‡å†™é€ æˆä»»ä½•å½±å“ã€‚

> Redis ä¸»ä»æ¨¡å¼ä¸­ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ

å½“ Redis è¿è¡Œåœ¨ä¸»ä»æ¨¡å¼ä¸‹æ—¶ï¼Œä»åº“ä¸ä¼šè¿›è¡Œè¿‡æœŸæ‰«æï¼Œä»åº“å¯¹è¿‡æœŸçš„å¤„ç†æ˜¯è¢«åŠ¨çš„ã€‚ä¹Ÿå°±æ˜¯å³ä½¿ä»åº“ä¸­çš„ key è¿‡æœŸäº†ï¼Œå¦‚æœæœ‰å®¢æˆ·ç«¯è®¿é—®ä»åº“æ—¶ï¼Œä¾ç„¶å¯ä»¥å¾—åˆ° key å¯¹åº”çš„å€¼ï¼Œåƒæœªè¿‡æœŸçš„é”®å€¼å¯¹ä¸€æ ·è¿”å›ã€‚

ä»åº“çš„è¿‡æœŸé”®å¤„ç†ä¾é ä¸»æœåŠ¡å™¨æ§åˆ¶ï¼Œä¸»åº“åœ¨ key åˆ°æœŸæ—¶ï¼Œä¼šåœ¨ AOF æ–‡ä»¶é‡Œå¢åŠ ä¸€æ¡ del æŒ‡ä»¤ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰çš„ä»åº“ï¼Œä»åº“é€šè¿‡æ‰§è¡Œè¿™æ¡ del æŒ‡ä»¤æ¥åˆ é™¤è¿‡æœŸçš„ keyã€‚


### Redisçš„RDBæŒä¹…åŒ–è¿‡ç¨‹

#### RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥

Redisæ˜¯å†…å­˜å‹æ•°æ®åº“, è¿™å³æ„å‘³ç€è‹¥æœåŠ¡å™¨æ–­ç”µæˆ–å…³é—­, å†…å­˜ä¸­åŠ è½½çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šä¸¢å¤±, æ‰€ä»¥Redisæœ‰RDBæŒä¹…åŒ–è¿‡ç¨‹,å³å¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å›ºå®šæ ¼å¼ä¿å­˜åœ¨ç£ç›˜é‡Œ,è¿™æ ·å³ä½¿æœåŠ¡å™¨æ–­ç”µ...åœ¨é‡å¯æœåŠ¡å™¨çš„æ—¶å€™ä¹Ÿå¯ä»¥åŠ è½½RDBæ–‡ä»¶æ¥æ¢å¤æ•°æ®,ä½†RDBä¸æ˜¯ä¸‡èƒ½çš„,ä¹Ÿå°±æ˜¯è‹¥RDBæ–‡ä»¶ç”Ÿæˆä¸€å¤©åæ–­äº†ç”µ,é‚£ä¹ˆåœ¨è¿™ä¸€å¤©å†…äº§ç”Ÿçš„æ•°æ®æ˜¯æ²¡åŠæ³•æ¢å¤çš„...å½“ç„¶è¿™æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†

æˆ‘ä»¬å…ˆæ¥è¯´ä¸€è¯´RDBæŒä¹…åŒ–çš„è¿‡ç¨‹

ç”ŸæˆRDBæ–‡ä»¶æ˜¯ç”¨`SAVE`æˆ–`BGSAVE`æ¥ç”Ÿæˆ,SAVEå‘½ä»¤ä¼šé˜»å¡Redisçš„ä¸»è¿›ç¨‹ä¹Ÿå°±æ˜¯è¯´è‹¥å†…å­˜ä¸­çš„æ•°æ®ç‰¹åˆ«å¤š,ä¼šå¯¼è‡´RedisæœåŠ¡ç›´æ¥å¡åœ, å¯¼è‡´RedisæœåŠ¡å™¨æ— æ³•å¤„ç†åˆ«çš„è¯·æ±‚.BGSAVEæ˜¯åœ¨åå°èµ·ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†ä¿å­˜æ•°æ®.

å¦‚ä½•åŠ è½½RDBæ–‡ä»¶å‘¢?

Redisæ²¡æœ‰åŠ è½½RDBæ–‡ä»¶çš„å‘½ä»¤, åœ¨RedisæœåŠ¡å¯åŠ¨çš„æ—¶å€™ä¼šæ£€æŸ¥åœ¨configæ–‡ä»¶ä¸­é…ç½®æ–‡ä»¶ä¸‹æœ‰æ²¡æœ‰æ–‡ä»¶,è‹¥æœ‰åˆ™è‡ªåŠ¨åŠ è½½RDBæ–‡ä»¶, æ²¡æœ‰åˆ™ä¸åŠ è½½.

å¦å¤–, å› ä¸ºAOFæ–‡ä»¶æ˜¯æŒä¹…åŒ–æ¯”RDBé¢‘ç¹,æ‰€ä»¥è‹¥AOFæ–‡ä»¶å’ŒRDBæ–‡ä»¶åŒæ—¶å­˜åœ¨,åˆ™ä¼˜å…ˆåŠ è½½AOFæ–‡ä»¶.åªæœ‰åœ¨AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨RDBæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚

è¿™æ„å‘³ç€è‹¥å¼€å¯äº†AOF,ä½†AOFæ–‡ä»¶ä¸ºç©º,åˆ™åŠ è½½çš„æ•°æ®å°±ä¸ºç©º

BGSAVEå‘½ä»¤çš„ä¿å­˜å·¥ä½œç”±ä¸»è¿›ç¨‹forkçš„å­è¿›ç¨‹æ‰§è¡Œ,æ‰€ä»¥åœ¨æ‰§è¡Œäº†BGSAVEçš„æƒ…å†µä¸‹RedisæœåŠ¡å™¨è¿˜èƒ½å¤Ÿæ¥å—å®¢æˆ·ç«¯çš„å‘½ä»¤, ä½†æ˜¯åœ¨BGSAVEå‘½ä»¤æ‰§è¡ŒæœŸé—´,æœåŠ¡å™¨å¤„ç†`BGSAVE`, `SAVE`, `BGREWRITEAOF`ä¸‰ä¸ªå‘½ä»¤å’Œå¹³æ—¶æœ‰æ‰€ä¸åŒ

é¦–å…ˆBGSAVEæ‰§è¡ŒæœŸé—´,å®¢æˆ·ç«¯å‘é€SAVEå‘½ä»¤ä¼šè¢«æœåŠ¡å™¨ç›´æ¥æ‹’ç», æœåŠ¡å™¨ç¦æ­¢SAVEå’ŒBGSAVEçš„ç›®çš„æ˜¯é¿å…çˆ¶å­è¿›ç¨‹åŒæ—¶æ‰§è¡Œ`rdbSave`é˜²æ­¢æœ‰ç«äº‰æ¡ä»¶, å…¶æ¬¡BGSAVEå‘½ä»¤æ‰§è¡ŒæœŸé—´å®¢æˆ·ç«¯å‘é€BGSAVEå‘½ä»¤ä¼šè¢«æœåŠ¡å™¨ç›´æ¥æ‹’ç», å› ä¸ºåŒæ—¶æ‰§è¡Œä¸¤ä¸ªBGSAVEä¹Ÿä¼šäº§ç”Ÿç«äº‰æ¡ä»¶, æœ€å`BGREWRITEAOF`å’Œ`BGSAVE`ä¸¤ä¸ªå‘½ä»¤ä¸èƒ½åŒæ—¶æ‰§è¡Œ, å¦‚æœBGSAVEåŒæ—¶æ‰§è¡Œ, é‚£ä¹ˆå®¢æˆ·ç«¯å‘é€çš„BGREWRITEAOFå‘½ä»¤ä¼šè¢«å»¶è¿Ÿåˆ°BGSAVEå‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰§è¡Œã€‚å¦‚ æœ BGREWRITEAOFå‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘é€çš„BGSAVEå‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ã€‚

ä¸ºä»€ä¹ˆBGREWRITEAOFå’ŒBGSAVEä¸¤ä¸ªå‘½ä»¤ä¸èƒ½åŒæ—¶è¿›è¡Œ?

> å› ä¸ºBGREWRITEAOFå’ŒBGSAVEä¸¤ä¸ªå‘½ä»¤çš„å®é™…å·¥ä½œéƒ½ç”±å­è¿›ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå‘½ä»¤åœ¨æ“ä½œæ–¹é¢å¹¶æ²¡æœ‰ä»€ä¹ˆå†²çªçš„åœ°æ–¹ï¼Œä¸èƒ½åŒæ—¶æ‰§è¡Œå®ƒä»¬åªæ˜¯ä¸€ä¸ªæ€§èƒ½æ–¹é¢çš„è€ƒè™‘â€”â€”å¹¶å‘å‡ºä¸¤ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå­è¿›ç¨‹éƒ½åŒæ—¶æ‰§è¡Œå¤§é‡çš„ç£ç›˜å†™å…¥æ“ä½œï¼Œè¿™æ€ä¹ˆæƒ³éƒ½ä¸ä¼šæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

RDBæ–‡ä»¶è½½å…¥æ—¶æœåŠ¡å™¨ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è½½å…¥å®Œæˆä¸ºæ­¢.

#### è‡ªåŠ¨é—´éš”æ€§ä¿å­˜

å› ä¸ºBGSAVEå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥ä¿å­˜æ•°æ®,æ‰€ä»¥å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶çš„saveé€‰é¡¹è®¾ç½®å¤šä¸ªä¿å­˜æ¡ä»¶,åªè¦æœ‰å…¶ä¸­ä»»æ„ä¸€ä¸ªæ»¡è¶³,åå°å°±å¯ä»¥è‡ªåŠ¨æ‰§è¡ŒBGSAVE, å¦‚æœæˆ‘ä»¬å‘æœåŠ¡å™¨æä¾›`save 900 1`, åˆ™è‹¥æœåŠ¡å™¨åœ¨900ç§’å†…å¯¹æ•°æ®åº“æœ‰è‡³å°‘ä¸€æ¬¡ä¿®æ”¹,åˆ™BGSAVEè‡ªåŠ¨æ‰§è¡Œ

ä¿å­˜æ¡ä»¶: ç”¨æˆ·å¯ä»¥è‡ªå·±åˆ¶å®šé…ç½®æ–‡ä»¶,è‹¥ä¸é…ç½®åˆ™é»˜è®¤æ¡ä»¶æ˜¯
```
save 900 1
save 300 10
save 60 10000
```
æ¥ç€æœåŠ¡å™¨ä¼šæ ¹æ®saveé€‰é¡¹å»ä¿å­˜æ¡ä»¶,è®¾ç½®æœåŠ¡å™¨çŠ¶æ€redisServerç»“æ„çš„saveparamså±æ€§:, saveparamså±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„,æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªsaveparamç»“æ„,saveparamç»“æ„æ˜¯æ‰€è®¾ç½®çš„ä¿å­˜æ¡ä»¶.
```c
struct saveparam {
    //ç§’æ•°
    time_t seconds;
    //ä¿®æ”¹æ•°
    int changes;
};
```
é™¤äº†saveparamsæ•°ç»„å¤–,æœåŠ¡å™¨çŠ¶æ€è¿˜ç»´æŒç€ä¸€ä¸ªdirtyè®¡æ•°å™¨å’Œlastsaveå±æ€§:
1. dirtyè®¡æ•°å™¨è®°å½•è·ç¦»ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡ŒSAVEå‘½ä»¤æˆ–è€…BGSAVEå‘½ä»¤ä¹‹åï¼ŒæœåŠ¡å™¨å¯¹æ•°æ®åº“çŠ¶æ€ï¼ˆæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“ï¼‰è¿›è¡Œäº†å¤šå°‘æ¬¡ä¿®æ”¹ï¼ˆåŒ…æ‹¬å†™å…¥ã€åˆ é™¤ã€æ›´æ–°ç­‰æ“ä½œï¼‰ã€‚
2. lastsaveå±æ€§æ˜¯ä¸€ä¸ªUNIXæ—¶é—´æˆ³,è®°å½•äº†ä¸Šä¸€æ¬¡æœåŠ¡å™¨çš„SAVEå‘½ä»¤æˆ–BGSAVEå‘½ä»¤çš„æ—¶é—´

å½“æœåŠ¡å™¨æˆåŠŸæ‰§è¡Œä¸€ä¸ªæ•°æ®åº“ä¿®æ”¹å‘½ä»¤ä¹‹åï¼Œç¨‹åºå°±ä¼šå¯¹dirtyè®¡æ•°å™¨è¿›è¡Œæ›´æ–°ï¼šå‘½ä»¤ä¿®æ”¹äº†å¤šå°‘æ¬¡æ•°æ®åº“ï¼Œdirtyè®¡æ•°å™¨çš„å€¼å°±å¢åŠ å¤šå°‘ã€‚

> æ£€æŸ¥ä¿å­˜æ¡ä»¶æ˜¯å¦æ»¡è¶³

RedisæœåŠ¡å™¨å‘¨æœŸæ€§æ“ä½œå‡½æ•°serverCroné»˜è®¤æ¯éš”100æ¯«ç§’å°±æ‰§è¡Œä¸€æ¬¡, å®ƒçš„å·¥ä½œä¹‹ä¸€å°±æ˜¯æ£€æŸ¥saveé€‰é¡¹æ‰€è®¾ç½®çš„ä¿å­˜æ¡ä»¶æ˜¯å¦å·²ç»æ»¡è¶³,å¦‚æœæ»¡è¶³çš„è¯å°±æ‰§è¡ŒBGSAVEå‘½ä»¤


#### RDBæ–‡ä»¶çš„ç»“æ„
    
    
RDBçš„æ–‡ä»¶ç»“æ„
```
REDIS db_version databases EOF check_sum
```

æ³¨æ„:ä¸ºäº†åŒºåˆ†å˜é‡å¸¸é‡æ•°æ®,ä½¿ç”¨å…¨å¤§å†™å•è¯æ ‡ç¤ºå¸¸é‡,ç”¨å…¨å°å†™å­—æ¯æ ‡è¯†å˜é‡å’Œæ•°æ®

RDBæ–‡ä»¶çš„æœ€å¼€å¤´æ˜¯REDISéƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†çš„é•¿åº¦ä¸º5å­—èŠ‚ï¼Œä¿å­˜ç€â€œREDISâ€äº”ä¸ªå­—ç¬¦ã€‚é€šè¿‡è¿™äº”ä¸ªå­—ç¬¦ï¼Œç¨‹åºå¯ä»¥åœ¨è½½å…¥æ–‡ä»¶æ—¶ï¼Œå¿«é€Ÿæ£€æŸ¥æ‰€è½½å…¥çš„æ–‡ä»¶æ˜¯å¦RDBæ–‡ä»¶ã€‚åˆå› ä¸ºRedisä¿å­˜çš„æ˜¯äºŒè¿›åˆ¶æ•°æ®,ä¸æ˜¯Cå­—ç¬¦ä¸²æ‰€ä»¥å¼€å¤´çš„REDISå…¶å®å°±æ˜¯REDISäº”ä¸ªå­—ç¬¦æ²¡æœ‰'\0'ç»“å°¾...

db_versionæ˜¯é•¿åº¦ä¸º4å­—èŠ‚,å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•´æ•°,è¿™ä¸ªæ•´æ•°è®°å½•äº†RDBæ–‡ä»¶çš„ç‰ˆæœ¬,æ¯”å¦‚"0006"ä»£è¡¨æ˜¯ç¬¬å…­ç‰ˆ,è¿™é‡Œåªä»‹ç»RDBçš„ç¬¬å…­ç‰ˆæ–‡ä»¶

databaseséƒ¨åˆ†åŒ…å«ç€0æˆ–å¤šä¸ªæ•°æ®åº“ä»¥åŠå…¶ä¸­çš„æ•°æ®.å¦‚æœæ•°æ®åº“çš„æ•°æ®åº“çŠ¶æ€ä¸ºç©ºåˆ™è¿™éƒ¨ä½ä¸ºç©º.å¦åˆ™å°±ä¿å­˜æ•°æ®

EOFå¸¸é‡ä¸º1å­—èŠ‚,è¿™ä¸ªå¸¸é‡æ ‡å¿—ç€RDBæ–‡ä»¶æ­£æ–‡å†…å®¹çš„ç»“æŸ,å½“è¯»å…¥ç¨‹åºé‡åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™,å®ƒçŸ¥é“æ‰€æœ‰æ•°æ®åº“çš„é”®å€¼å¯¹éƒ½å½•å…¥å®Œæ¯•.

check_sumæ˜¯ä¸€ä¸ª8å­—èŠ‚é•¿çš„æ— ç¬¦å·æ•´æ•°,ä¿å­˜ç€ä¸€ä¸ªæ ¡éªŒå’Œ,å®ƒæ˜¯REDISã€db_versionã€databasesã€EOFå››ä¸ªéƒ¨åˆ†çš„å†…å®¹è¿›è¡Œè®¡ç®—å¾—å‡ºçš„ã€‚æœåŠ¡å™¨åœ¨è½½å…¥RDBæ–‡ä»¶æ—¶ï¼Œä¼šå°†è½½å…¥æ•°æ®æ‰€è®¡ç®—å‡ºçš„æ ¡éªŒå’Œä¸check_sumæ‰€è®°å½•çš„æ ¡éªŒå’Œè¿›è¡Œå¯¹æ¯”ï¼Œä»¥æ­¤æ¥æ£€æŸ¥RDBæ–‡ä»¶æ˜¯å¦æœ‰å‡ºé”™æˆ–è€…æŸåçš„æƒ…å†µå‡ºç°ã€‚

##### databaseséƒ¨åˆ†

ä¸€ä¸ªRDBæ–‡ä»¶çš„databaseséƒ¨åˆ†å¯ä»¥ä¿å­˜ä»»æ„å¤šä¸ªéç©ºæ•°æ®åº“ã€‚

æ¯ ä¸ª é ç©º æ•° æ® åº“ åœ¨ RDB æ–‡ ä»¶ ä¸­ éƒ½ å¯ ä»¥ ä¿ å­˜ ä¸º SELECTDB ã€db_numberã€key_value_pairsä¸‰ä¸ªéƒ¨åˆ†.

- SELECTDBå¸¸é‡çš„é•¿åº¦ä¸º1å­—èŠ‚ï¼Œå½“è¯»å…¥ç¨‹åºé‡åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œå®ƒçŸ¥é“æ¥ä¸‹æ¥è¦è¯»å…¥çš„å°†æ˜¯ä¸€ä¸ªæ•°æ®åº“å·ç ã€‚
- db_numberä¿å­˜ç€ä¸€ä¸ªæ•°æ®åº“å·ç ï¼Œæ ¹æ®å·ç çš„å¤§å°ä¸åŒï¼Œè¿™ä¸ªéƒ¨åˆ†çš„é•¿åº¦å¯ä»¥æ˜¯1å­—èŠ‚ã€2å­—èŠ‚æˆ–è€…5å­—èŠ‚ã€‚å½“ç¨‹åºè¯»å…¥db_numberéƒ¨åˆ†ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šè°ƒç”¨SELECTå‘½ä»¤ï¼Œæ ¹æ®è¯»å…¥çš„æ•°æ®åº“å·ç è¿›è¡Œæ•°
æ®åº“åˆ‡æ¢ï¼Œä½¿å¾—ä¹‹åè¯»å…¥çš„é”®å€¼å¯¹å¯ä»¥è½½å…¥åˆ°æ­£ç¡®çš„æ•°æ®åº“ä¸­ã€‚
- key_value_pairséƒ¨åˆ†ä¿å­˜äº†æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹æ•°æ®ï¼Œå¦‚æœé”®å€¼å¯¹å¸¦æœ‰è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆè¿‡æœŸæ—¶é—´ä¹Ÿä¼šå’Œé”®å€¼å¯¹ä¿å­˜åœ¨ä¸€èµ·ã€‚æ ¹æ®é”®å€¼å¯¹çš„æ•°é‡ã€ç±»å‹ã€å†…å®¹ä»¥åŠæ˜¯å¦æœ‰è¿‡æœŸæ—¶é—´ç­‰æ¡ä»¶çš„ä¸åŒï¼Œkey_value_pairséƒ¨åˆ†çš„é•¿åº¦ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚

##### key_value_pairséƒ¨åˆ†

RDBæ–‡ä»¶ä¸­çš„æ¯ä¸ªkey_value_pairséƒ¨åˆ†éƒ½ä¿å­˜äº†ä¸€ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®å€¼å¯¹ï¼Œå¦‚æœé”®å€¼å¯¹å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„è¯ï¼Œé‚£ä¹ˆé”®å€¼å¯¹çš„è¿‡æœŸæ—¶é—´ä¹Ÿä¼šè¢«ä¿å­˜åœ¨å†…ã€‚

ä¸å¸¦è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹åœ¨RDBæ–‡ä»¶ä¸­ç”±TYPEã€keyã€valueä¸‰éƒ¨åˆ†ç»„æˆ

TYPEè®°å½•äº†valueçš„ç±»å‹, é•¿åº¦ä¸º1å­—èŠ‚, å€¼å¯ä»¥æ˜¯ä»¥ä¸‹å¸¸é‡çš„å…¶ä¸­ä¸€ä¸ª
- REDIS_RDB_TYPE_STRING
- REDIS_RDB_TYPE_LIST
- REDIS_RDB_TYPE_SET
- REDIS_RDB_TYPE_ZSET
- REDIS_RDB_TYPE_HASH
- REDIS_RDB_TYPE_LIST_ZIPLIST
- REDIS_RDB_TYPE_SET_INTSET
- REDIS_RDB_TYPE_ZSET_ZIPLIST
- REDIS_RDB_TYPE_HASH_ZIPLIST

å¸¦æœ‰è¿‡æœŸçš„éƒ¨åˆ†æœ‰æ–°å¢çš„EXPIRETIME_MSå’Œms, åˆ†åˆ«æ˜¯ä»¥æ¯«ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´å’ŒUNIXæ—¶é—´æˆ³è®°å½•çš„è¿‡æœŸæ—¶é—´

values éƒ¨åˆ†åˆ™æ˜¯

å…¶ä»–çš„å€¼ç±»å‹éƒ¨åˆ†ä¸èµ˜è¿°äº†

### AOFæ–‡ä»¶ç»“æ„

é™¤äº†RDBæŒä¹…åŒ–åŠŸèƒ½å¤–,Redisè¿˜æä¾›AOFæŒä¹…åŒ–.AOFæŒä¹…åŒ–æ˜¯é€šè¿‡ä¿å­˜RedisæœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€çš„


è¢«å†™å…¥AOFæ–‡ä»¶çš„æ‰€æœ‰å‘½ä»¤éƒ½æ˜¯ä»¥Redisçš„å‘½ä»¤è¯·æ±‚åè®®æ ¼å¼ä¿å­˜çš„ï¼Œå› ä¸ºRedisçš„å‘½ä»¤è¯·æ±‚åè®®æ˜¯çº¯æ–‡æœ¬æ ¼å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰“å¼€ä¸€ä¸ªAOFæ–‡ä»¶ï¼Œè§‚å¯Ÿé‡Œé¢çš„å†…å®¹ã€‚

æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡è½½å…¥å’Œæ‰§è¡ŒAOFæ–‡ä»¶ä¸­ä¿å­˜çš„å‘½ä»¤æ¥è¿˜åŸæœåŠ¡å™¨å…³é—­ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€

#### AOFæŒä¹…åŒ–çš„å®ç°

AOFæŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ä¸‰ä¸ªæ­¥éª¤ã€‚

è¿½åŠ :å½“AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶,æœåŠ¡å™¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤å,ä¼šä»¥åè®®æ ¼å¼å‘½ä»¤å°†è¢«å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„aof_bufç¼“å†²åŒºæœ«å°¾.  

AOFæ–‡ä»¶çš„å†™å…¥

RedisæœåŠ¡å™¨è¿›ç¨‹å…¶å®å°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯,è¿™ä¸ªå¾ªç¯ä¸­çš„æ–‡ä»¶äº‹ä»¶è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚,ä»¥åŠå‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤,è€Œæ—¶é—´äº‹ä»¶åˆ™è´Ÿè´£æ‰§è¡ŒåƒserverCronå‡½æ•°è¿™æ ·éœ€è¦å®šæ—¶è¿è¡Œçš„å‡½æ•°ã€‚å› ä¸ºæœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶å¯èƒ½ä¼šæ‰§è¡Œå†™å‘½ä»¤,ä½¿å¾—ä¸€äº›å†…å®¹è¢«è¿½åŠ åˆ°aof_bufç¼“å†²åŒºä¸­,æ‰€ä»¥æœåŠ¡å™¨åœ¨æ¯æ¬¡å¾ªç¯ç»“æŸæ—¶ä¼šè°ƒç”¨flushAppendOnlyFileå‡½æ•°,è€ƒè™‘æ˜¯å¦åˆ·æ–°aof_bufçš„å†…å®¹.

flushAppendOnlyFileå‡½æ•°çš„è¡Œä¸ºç”±æœåŠ¡å™¨é…ç½®çš„appendfsyncé€‰é¡¹çš„å€¼æ¥å†³å®š.
appendfsyncé€‰é¡¹æœ‰always  everysec   noæ„æ€åˆ†åˆ«ä¸º,æ€»æ˜¯,æ¯ç§’,ç”±æ“ä½œç³»ç»Ÿå†³å®š...


æ–‡ä»¶å†™å…¥å’ŒåŒæ­¥ä¸ºäº†æé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡,ç°ä»£è®¡ç®—æœºä¸­ä¸ºäº†æé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡,å½“ç”¨æˆ·è°ƒç”¨writeå‡½æ•°ï¼Œå°†ä¸€äº›æ•°æ®å†™å…¥åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºé‡Œé¢ï¼Œç­‰åˆ°ç¼“å†²åŒºçš„ç©ºé—´è¢«å¡«æ»¡ã€æˆ–è€…è¶…è¿‡äº†æŒ‡å®šçš„æ—¶é™ä¹‹åï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ã€‚è¿™ç§åšæ³•è™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†ä¹Ÿä¸ºå†™å…¥æ•°æ®å¸¦æ¥äº†å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå¦‚æœè®¡ç®—æœºå‘ç”Ÿåœæœºï¼Œé‚£ä¹ˆä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œé¢çš„å†™å…¥æ•°æ®å°†ä¼šä¸¢å¤±ã€‚ä¸ºæ­¤ï¼Œç³»ç»Ÿæä¾›äº†fsyncå’Œfdatasyncä¸¤ä¸ªåŒæ­¥å‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥å¼ºåˆ¶è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œä»è€Œç¡®ä¿å†™å…¥æ•°æ®çš„å®‰å…¨æ€§ã€‚


AOFçš„è½½å…¥ä¸æ•°æ®è¿˜åŸ

AOFæ–‡ä»¶åŒ…å«äº†é‡å»ºæ•°æ®åº“æ‰€éœ€çš„æ‰€æœ‰å†™å‘½ä»¤,æ‰€ä»¥æœåŠ¡å™¨åªéœ€è¦è¯»å…¥å¹¶é‡æ–°æ‰§è¡Œä¸€éAOFæ–‡ä»¶é‡Œé¢ä¿å­˜çš„å†™å‘½ä»¤å°±å¥½äº†.

Redisè¯»å–AOFæ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š
1ï¼‰åˆ›å»ºä¸€ä¸ªä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯ï¼ˆfake clientï¼‰ï¼šå› ä¸ºRedisçš„å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè€Œè½½å…¥AOFæ–‡ä»¶æ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤ç›´æ¥æ¥æºäºAOFæ–‡ä»¶è€Œä¸æ˜¯ç½‘ç»œè¿æ¥ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä½¿ç”¨äº†ä¸€ä¸ªæ²¡æœ‰ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯æ¥æ‰§è¡ŒAOFæ–‡ä»¶ä¿å­˜çš„å†™å‘½ä»¤ï¼Œä¼ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœå’Œå¸¦ç½‘ç»œè¿æ¥çš„å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœå®Œå…¨ä¸€æ ·ã€‚
2ï¼‰ä»AOFæ–‡ä»¶ä¸­åˆ†æå¹¶è¯»å–å‡ºä¸€æ¡å†™å‘½ä»¤ã€‚
3ï¼‰ä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¢«è¯»å‡ºçš„å†™å‘½ä»¤ã€‚
4ï¼‰ä¸€ç›´æ‰§è¡Œæ­¥éª¤2å’Œæ­¥éª¤3ï¼Œç›´åˆ°AOFæ–‡ä»¶ä¸­çš„æ‰€æœ‰å†™å‘½ä»¤éƒ½è¢«å¤„ç†å®Œæ¯•ä¸ºæ­¢ã€‚
å½“å®Œæˆä»¥ä¸Šæ­¥éª¤ä¹‹åï¼ŒAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å°±ä¼šè¢«å®Œæ•´åœ°è¿˜åŸå‡ºæ¥

AOFé‡å†™

å› ä¸ºAOFæŒä¹…åŒ–æ˜¯é€šè¿‡ä¿å­˜è¢«æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€çš„ï¼Œæ‰€ä»¥éšç€æœåŠ¡å™¨è¿è¡Œæ—¶é—´çš„æµé€ï¼ŒAOFæ–‡ä»¶ä¸­çš„å†…å®¹ä¼šè¶Šæ¥è¶Šå¤šï¼Œæ–‡ä»¶çš„ä½“ç§¯ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¦‚æœä¸åŠ ä»¥æ§åˆ¶çš„è¯ï¼Œä½“ç§¯è¿‡å¤§çš„AOFæ–‡ä»¶å¾ˆå¯èƒ½å¯¹RedisæœåŠ¡å™¨ã€ç”šè‡³æ•´ä¸ªå®¿ä¸»è®¡ç®—æœºé€ æˆå½±å“ï¼Œå¹¶ä¸”AOFæ–‡ä»¶çš„ä½“ç§¯è¶Šå¤§ï¼Œä½¿ç”¨AOFæ–‡ä»¶æ¥è¿›è¡Œæ•°æ®è¿˜åŸæ‰€éœ€çš„æ—¶é—´å°±è¶Šå¤šã€‚


ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯è†¨èƒ€çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFæ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰åŠŸèƒ½ã€‚é€šè¿‡è¯¥åŠŸèƒ½ï¼ŒRedisæœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒï¼Œä½†æ–°AOFæ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥æ–°AOFæ–‡ä»¶çš„ä½“ç§¯é€šå¸¸ä¼šæ¯”æ—§AOFæ–‡ä»¶çš„ä½“ç§¯è¦å°å¾—å¤š

åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»AOFæ–‡ä»¶é‡å†™çš„å®ç°åŸç†ï¼Œä»¥åŠBGREWEITEAOFå‘½ä»¤çš„å®ç°åŸç†ã€‚


è™½ç„¶Rediså°†ç”Ÿæˆæ–°AOFæ–‡ä»¶æ›¿æ¢æ—§AOFæ–‡ä»¶çš„åŠŸèƒ½å‘½åä¸ºâ€œAOFæ–‡ä»¶é‡å†™â€ï¼Œä½†å®é™…ä¸Šï¼ŒAOFæ–‡ä»¶é‡å†™å¹¶ä¸éœ€è¦å¯¹ç°æœ‰çš„AOFæ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å–ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€æ¥å®ç°çš„ã€‚

å³å°±æ˜¯é€šè¿‡æ‰«ææœåŠ¡å™¨æœ‰çš„æ‰€æœ‰é”®å€¼å»é‡å»ºAOFæ–‡ä»¶

### å‘å¸ƒä¸è®¢é˜…

Rediså‘å¸ƒè®¢é˜…åŠŸèƒ½æ˜¯ç”±PUBLISH,SUBSCRIBE,PSUBSCRIBEç­‰å‘½ä»¤ç»„æˆ.

é€šè¿‡æ‰§è¡ŒSUBSCRIBEå‘½ä»¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ï¼Œä»è€Œæˆä¸ºè¿™äº›é¢‘é“çš„è®¢é˜…è€…ï¼ˆsubscriberï¼‰ï¼šæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘è¢«è®¢é˜…çš„é¢‘é“å‘é€æ¶ˆæ¯ï¼ˆmessageï¼‰æ—¶ï¼Œé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€‚

é™¤äº†è®¢é˜…é¢‘é“ä¹‹å¤–ï¼Œå®¢æˆ·ç«¯è¿˜å¯ä»¥é€šè¿‡æ‰§è¡ŒPSUBSCRIBEå‘½ä»¤è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ï¼Œä»è€Œæˆä¸ºè¿™äº›æ¨¡å¼çš„è®¢é˜…è€…ï¼šæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘æŸä¸ªé¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¸ä»…ä¼šè¢«å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œå®ƒè¿˜ä¼šè¢«å‘é€ç»™æ‰€æœ‰ä¸è¿™ä¸ªé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…ã€‚

é¢‘é“çš„è®¢é˜…ä¸é€€è®¢

å½“ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡ŒSUBSCRIBEå‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›é¢‘é“çš„æ—¶å€™ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯ä¸è¢«è®¢é˜…é¢‘é“ä¹‹é—´å°±å»ºç«‹èµ·äº†ä¸€ç§è®¢é˜…å…³ç³»ã€‚Rediså°†æ‰€æœ‰çš„è®¢é˜…å…³ç³»éƒ½å‘é‚£ä¸ªåˆ°äº†RedisServerç±»ä¸‹çš„pubsub_channelså­—å…¸é‡Œé¢,è¿™ä¸ªå­—å…¸çš„é”®æ˜¯æŸä¸ªè¢«è®¢é˜…çš„é¢‘é“,å€¼æ˜¯ä¸€ä¸ªé“¾è¡¨,é“¾è¡¨é‡Œé¢è®°å½•çš„æ˜¯è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯.

é€€è®¢çš„è¯å…¶å®å°±æ˜¯éå†é“¾è¡¨åˆ é™¤æ“ä½œ,å¦‚æœå®¢æˆ·ç«¯ä¸ºç©º,åˆ™é¢‘é“é”®ä¸€å¹¶åˆ é™¤æ‰.

æ¨¡å¼çš„è®¢é˜…ä¸é€€è®¢

æœåŠ¡å™¨ä¹Ÿå°†æ‰€æœ‰æ¨¡å¼çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„pubsub_patternså±æ€§é‡Œé¢,pubsub_patternså±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ç€ä¸€ä¸ªpubsub Patternç»“æ„ï¼Œè¿™ä¸ªç»“æ„çš„patternå±æ€§è®°å½•äº†è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œè€Œclientå±æ€§åˆ™è®°å½•äº†è®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯

é€€è®¢æ¨¡å¼é¢‘é“çš„é€€è®¢å·®ä¸å¤š

å‘å¸ƒæ¶ˆæ¯

å½“ä¸€ä¸ªrediså®¢æˆ·ç«¯æ‰§è¡ŒPUBLISH,å°†æ¶ˆæ¯messageå‘é€ç»™é¢‘é“channelæ—¶,æœåŠ¡å™¨éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªåŠ¨ä½œ,å°†æ¶ˆæ¯messageå‘é€ç»™channelé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€….å¦‚æœæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼å’Œé¢‘é“åŒ¹é…é‚£ä¹ˆå°†æ¶ˆæ¯messageå‘é€ç»™patternæ¨¡å¼çš„è®¢é˜…è€….

å‘é€ç»™æ¨¡å¼çš„è®¢é˜…è€…å°±æ˜¯éå†æ‰€æœ‰æ¨¡å¼,æ‰¾å‡ºå®¢æˆ·ç«¯å‘é€...

æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯

PUBSUBå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹é¢‘é“æˆ–è€…æ¨¡å¼çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚æŸä¸ªé¢‘é“ç›®å‰æœ‰å¤šå°‘è®¢é˜…è€…ï¼Œåˆæˆ–è€…æŸä¸ªæ¨¡å¼ç›®å‰æœ‰å¤šå°‘è®¢é˜…è€…ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚

PUBSUB CHANNELS[pattern]å­å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ï¼Œå…¶ä¸­patternå‚æ•°æ˜¯å¯é€‰çš„ï¼š
Â·å¦‚æœä¸ç»™å®špatternå‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„æ‰€æœ‰é¢‘é“ã€‚
Â·å¦‚æœç»™å®špatternå‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ä¸­é‚£äº›ä¸patternæ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“ã€‚

PUBSUB NUMSUB[channel-1 channel-2...channel-n]å­å‘½ä»¤æ¥å—ä»»æ„å¤šä¸ªé¢‘é“ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œå¹¶è¿”å›è¿™äº›é¢‘é“çš„è®¢é˜…è€…æ•°é‡ã€‚

PUBSUB NUMPATå­å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡ã€‚

### äº‹åŠ¡

Redisé€šè¿‡multi,exec,watchç­‰å‘½ä»¤å®ç°äº‹åŠ¡(transaction),äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…,ç„¶åä¸€æ¬¡æ€§é¡ºåºæ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„è¿‡ç¨‹.å¹¶ä¸”åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´æœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡è€Œæ”¹å»æ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œå®ƒä¼šå°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åæ‰å»å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ã€‚

ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°ç»“æŸé€šå¸¸ä¼šç»å†ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š
1ï¼‰äº‹åŠ¡å¼€å§‹ã€‚
2ï¼‰å‘½ä»¤å…¥é˜Ÿã€‚
3ï¼‰äº‹åŠ¡æ‰§è¡Œã€‚

åŒ…æ‹¬çš„å‘½ä»¤æœ‰`MULTI`,`DISCARD`,`EXEC`,`WATCH`

`multi`äº‹åŠ¡å¼€å§‹,è¿™ä¸€åˆ‡æ¢æ˜¯é€šè¿‡åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„flagså±æ€§ä¸­æ‰“å¼€REDIS_MULTIæ ‡è¯†æ¥å®Œæˆçš„`client.flags |= REDIS_MULTI`.

å½“ä¸€ä¸ªå®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¼šç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œ, ä¸åŒçš„æ˜¯è‹¥å¤„äºäº‹åŠ¡çŠ¶æ€,åˆ™æ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„ä¸åŒå‘½ä»¤æ‰§è¡Œä¸åŒçš„æ“ä½œ.å¦‚æœå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¸ºEXECã€DISCARDã€WATCHã€MULTIå››ä¸ªå‘½ä»¤çš„å…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚

ä¸ æ­¤ ç›¸ å ï¼Œ å¦‚ æœ å®¢ æˆ· ç«¯ å‘ é€ çš„ å‘½ ä»¤ æ˜¯ EXEC ã€ DISCARD ã€WATCHã€MULTIå››ä¸ªå‘½ä»¤ä»¥å¤–çš„å…¶ä»–å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¹¶ä¸ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè€Œæ˜¯å°†è¿™ä¸ªå‘½ä»¤æ”¾å…¥ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åå‘å®¢æˆ·ç«¯è¿”å›QUEUEDå›å¤

äº‹åŠ¡é˜Ÿåˆ—

æ¯ä¸ªRediså®¢æˆ·ç«¯éƒ½æœ‰è‡ªå·±çš„äº‹åŠ¡çŠ¶æ€ï¼Œè¿™ä¸ªäº‹åŠ¡çŠ¶æ€ä¿å­˜åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„mstateå±æ€§é‡Œé¢, äº‹åŠ¡çŠ¶æ€å±æ€§åŒ…å«ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œä»¥åŠä¸€ä¸ªå·²å…¥é˜Ÿå‘½ä»¤çš„è®¡æ•°å™¨ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯äº‹åŠ¡é˜Ÿåˆ—çš„é•¿åº¦ï¼‰ï¼šäº‹åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªmultiCmdç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªmultiCmdç»“æ„éƒ½ä¿å­˜äº†ä¸€ä¸ªå·²å…¥é˜Ÿå‘½ä»¤çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‡å‘å‘½ä»¤å®ç°å‡½æ•°çš„æŒ‡é’ˆã€å‘½ä»¤çš„å‚æ•°ï¼Œä»¥åŠå‚æ•°çš„æ•°é‡.

æ‰§è¡Œäº‹åŠ¡

å½“ä¸€ä¸ªå¤„äºäº‹åŠ¡çŠ¶æ€çš„å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€EXECå‘½ä»¤æ—¶,ï¼Œè¿™ä¸ªEXECå‘½ä»¤å°†ç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚æœåŠ¡å™¨ä¼šéå†è¿™ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­ä¿å­˜çš„æ‰€æœ‰å‘½ä»¤ï¼Œæœ€åå°†æ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœå…¨éƒ¨è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

WATCHå‘½ä»¤çš„å®ç°

WATCHå‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ï¼Œå®ƒå¯ä»¥åœ¨EXECå‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨EXECå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒæœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤ã€‚

è‹¥åœ¨WATCHç›‘è§†å…¶é—´çš„äº‹åŠ¡,æœ‰å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹äº†æŸä¸ªè¢«WATCHç›‘è§†çš„é”®,åˆ™äº‹åŠ¡ä¼šè¢«æœåŠ¡å™¨ç«¯æ‹’ç»æ‰§è¡Œ,WATCHçš„åŸç†æ˜¯,æ¯ä¸ªRedisæ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ªwatched_keyså­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„é”®æ˜¯æŸä¸ªè¢«WATCHå‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­è®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯

é€šè¿‡watched_keyså­—å…¸ï¼ŒæœåŠ¡å™¨å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“å“ªäº›æ•°æ®åº“é”®æ­£åœ¨è¢«ç›‘è§†ï¼Œä»¥åŠå“ªäº›å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†è¿™äº›æ•°æ®åº“é”®

æ¯”å¦‚Â·å®¢æˆ·ç«¯c1å’Œc2æ­£åœ¨ç›‘è§†é”®"name"ã€‚ Â·å®¢æˆ·ç«¯c3æ­£åœ¨ç›‘è§†é”®"age"ã€‚ Â·å®¢æˆ·ç«¯c2å’Œc4æ­£åœ¨ç›‘è§†é”®"address"ã€‚

æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤ï¼Œæ¯”å¦‚SETã€LPUSHã€SADDã€ZREM ã€ DEL ã€ FLUSHDB ç­‰ ç­‰ ï¼Œ åœ¨ æ‰§ è¡Œ ä¹‹ å éƒ½ ä¼š è°ƒ ç”¨multi.c/touchWatchKeyå‡½æ•°å¯¹watched_keyså­—å…¸è¿›è¡Œæ£€æŸ¥ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†åˆšåˆšè¢«å‘½ä»¤ä¿®æ”¹è¿‡çš„æ•°æ®åº“é”®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œé‚£ ä¹ˆ touchWatchKey å‡½ æ•° ä¼š å°† ç›‘ è§† è¢« ä¿® æ”¹ é”® çš„ å®¢ æˆ· ç«¯ çš„REDIS_DIRTY_CASæ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºè¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´åã€‚

å½“æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„EXECå‘½ä»¤æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯å¦æ‰“å¼€äº†REDIS_DIRTY_CASæ ‡è¯†æ¥å†³å®šæ˜¯å¦æ‰§è¡Œäº‹åŠ¡ï¼š
- å¦‚æœå®¢æˆ·ç«¯çš„REDIS_DIRTY_CASæ ‡è¯†å·²ç»è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜å®¢æˆ·ç«¯æ‰€ç›‘è§†çš„é”®å½“ä¸­ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªé”®å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡å·²ç»ä¸å†å®‰å…¨ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡ã€‚
- å¦‚æœå®¢æˆ·ç«¯çš„REDIS_DIRTY_CASæ ‡è¯†æ²¡æœ‰è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜å®¢æˆ·ç«¯ç›‘è§†çš„æ‰€æœ‰é”®éƒ½æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼ˆæˆ–è€…å®¢æˆ·ç«¯æ²¡æœ‰ç›‘è§†ä»»ä½•é”®ï¼‰ï¼Œäº‹åŠ¡ä»ç„¶æ˜¯å®‰å…¨çš„ï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œå®¢æˆ·ç«¯æäº¤çš„è¿™ä¸ªäº‹åŠ¡ã€‚

äº‹åŠ¡çš„ACIDæ€§è´¨

åœ¨ä¼ ç»Ÿçš„å…³ç³»å¼æ•°æ®åº“ä¸­ï¼Œå¸¸å¸¸ç”¨ACIDæ€§è´¨æ¥æ£€éªŒäº‹åŠ¡åŠŸèƒ½çš„å¯é æ€§å’Œå®‰å…¨æ€§ã€‚åœ¨ Redis ä¸­ ï¼Œ äº‹ åŠ¡ æ€» æ˜¯ å…· æœ‰ åŸ å­ æ€§ ï¼ˆ Atomicity ï¼‰ ã€ ä¸€ è‡´ æ€§ï¼ˆConsistencyï¼‰å’Œéš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼Œå¹¶ä¸”å½“Redisè¿è¡Œåœ¨æŸç§ç‰¹å®šçš„æŒä¹…åŒ–æ¨¡å¼ä¸‹æ—¶ï¼Œäº‹åŠ¡ä¹Ÿå…·æœ‰è€ä¹…æ€§

äº‹åŠ¡å…·æœ‰åŸå­æ€§æŒ‡çš„æ˜¯ï¼Œæ•°æ®åº“å°†äº‹åŠ¡ä¸­çš„å¤šä¸ªæ“ä½œå½“ä½œä¸€ä¸ªæ•´ä½“æ¥æ‰§è¡Œï¼ŒæœåŠ¡å™¨è¦ä¹ˆå°±æ‰§è¡Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå°±ä¸€ä¸ªæ“ä½œä¹Ÿä¸æ‰§è¡Œã€‚å¯¹äºRedisçš„äº‹åŠ¡åŠŸèƒ½æ¥è¯´ï¼Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤è¦ä¹ˆå°±å…¨éƒ¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå°±ä¸€ä¸ªéƒ½ä¸æ‰§è¡Œï¼Œå› æ­¤ï¼ŒRedisçš„äº‹åŠ¡æ˜¯å…·æœ‰åŸå­æ€§çš„

Redisçš„äº‹åŠ¡å’Œä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“äº‹åŠ¡çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼ŒRedisä¸æ”¯æŒäº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆrollbackï¼‰ï¼Œå³ä½¿äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æŸä¸ªå‘½ä»¤åœ¨æ‰§è¡ŒæœŸé—´å‡ºç°äº†é”™è¯¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°å°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ä¸ºæ­¢ã€‚

Redisçš„ä½œè€…åœ¨äº‹åŠ¡åŠŸèƒ½çš„æ–‡æ¡£ä¸­è§£é‡Šè¯´ï¼Œä¸æ”¯æŒäº‹åŠ¡å›æ»šæ˜¯å› ä¸ºè¿™ç§å¤æ‚çš„åŠŸèƒ½å’ŒRedisè¿½æ±‚ç®€å•é«˜æ•ˆçš„è®¾è®¡ä¸»æ—¨ä¸ç›¸ç¬¦ï¼Œå¹¶ä¸”ä»–è®¤ä¸ºï¼ŒRedisäº‹åŠ¡çš„æ‰§è¡Œæ—¶é”™è¯¯é€šå¸¸éƒ½æ˜¯ç¼–ç¨‹é”™è¯¯äº§ç”Ÿçš„ï¼Œè¿™ç§é”™è¯¯é€šå¸¸åªä¼šå‡ºç°åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œè€Œå¾ˆå°‘ä¼šåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°ï¼Œæ‰€ä»¥ä»–è®¤ä¸ºæ²¡æœ‰å¿…è¦ä¸ºRediså¼€å‘äº‹åŠ¡å›æ»šåŠŸèƒ½ã€‚


äº‹åŠ¡å…·æœ‰ä¸€è‡´æ€§æŒ‡çš„æ˜¯ï¼Œå¦‚æœæ•°æ®åº“åœ¨æ‰§è¡Œäº‹åŠ¡ä¹‹å‰æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥ä»ç„¶æ˜¯ä¸€è‡´çš„ã€‚â€œä¸€è‡´â€æŒ‡çš„æ˜¯æ•°æ®ç¬¦åˆæ•°æ®åº“æœ¬èº«çš„å®šä¹‰å’Œè¦æ±‚ï¼Œæ²¡æœ‰åŒ…å«éæ³•æˆ–è€…æ— æ•ˆçš„é”™è¯¯æ•°æ®ã€‚Redisé€šè¿‡è°¨æ…çš„é”™è¯¯æ£€æµ‹å’Œç®€å•çš„è®¾è®¡æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Œä»¥ä¸‹ä¸‰ä¸ªå°èŠ‚å°†åˆ†åˆ«ä»‹ç»ä¸‰ä¸ªRedisäº‹åŠ¡å¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼Œå¹¶è¯´æ˜Redisæ˜¯å¦‚ä½•å¦¥å–„åœ°å¤„ç†è¿™äº›é”™è¯¯ï¼Œä»è€Œç¡®ä¿äº‹åŠ¡çš„ä¸€è‡´æ€§çš„ã€‚

1.å…¥é˜Ÿé”™è¯¯: å¦‚æœå‘½ä»¤åœ¨å…¥é˜Ÿæ—¶å‘ç”Ÿäº†é”™è¯¯,æ¯”å¦‚å‘½ä»¤ä¸å­˜åœ¨,æˆ–è€…å‘½ä»¤æ ¼å¼ä¸å¯¹,é‚£ä¹ˆRediså°†æ‹’ç»æ‰§è¡Œè¿™ä¸ªå‘½ä»¤.

2.æ‰§è¡Œé”™è¯¯: æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„é”™è¯¯éƒ½æ˜¯ä¸€äº›ä¸èƒ½åœ¨å…¥é˜Ÿæ—¶è¢«æœåŠ¡å™¨å‘ç°çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯åªä¼šåœ¨å‘½ä»¤å®é™…æ‰§è¡Œæ—¶è¢«è§¦å‘, å¹¶ä¸”æ‰§è¡Œé”™å,ç»§ç»­æ‰§è¡Œä¸‹é¢å‰©ä½™çš„é˜Ÿåˆ—å€¼

3.æœåŠ¡å™¨åœæœº: 

å¦‚æœRedisæœåŠ¡å™¨åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­åœæœºï¼Œé‚£ä¹ˆæ ¹æ®æœåŠ¡å™¨æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼ï¼Œå¯èƒ½æœ‰ä»¥ä¸‹æƒ…å†µå‡ºç°ï¼šå¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œå› æ­¤æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ã€‚

å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨RDBæ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡ä¸­é€”åœæœºä¸ä¼šå¯¼è‡´ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®ç°æœ‰çš„RDBæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œä»è€Œå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯ä¾›ä½¿ç”¨çš„RDBæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œè€Œç©ºç™½æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ã€‚

Â·å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨AOFæ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡ä¸­é€”åœæœºä¸ä¼šå¯¼è‡´ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®ç°æœ‰çš„AOFæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œä»è€Œå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯ä¾›ä½¿ç”¨çš„AOFæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œè€Œç©ºç™½æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œæ— è®ºRedisæœåŠ¡å™¨è¿è¡Œåœ¨å“ªç§æŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œäº‹åŠ¡æ‰§è¡Œä¸­é€”å‘ç”Ÿçš„åœæœºéƒ½ä¸ä¼šå½±å“æ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚

éš”ç¦»æ€§

äº‹åŠ¡çš„éš”ç¦»æ€§æŒ‡çš„æ˜¯ï¼Œå³ä½¿æ•°æ®åº“ä¸­æœ‰å¤šä¸ªäº‹åŠ¡å¹¶å‘åœ°æ‰§è¡Œï¼Œå„ä¸ªäº‹åŠ¡ä¹‹é—´ä¹Ÿä¸ä¼šäº’ç›¸å½±å“ï¼Œå¹¶ä¸”åœ¨å¹¶å‘çŠ¶æ€ä¸‹æ‰§è¡Œçš„äº‹åŠ¡å’Œä¸²è¡Œæ‰§è¡Œçš„äº‹åŠ¡äº§ç”Ÿçš„ç»“æœå®Œå…¨ç›¸åŒã€‚

å› ä¸ºRedisä½¿ç”¨å•çº¿ç¨‹çš„æ–¹å¼æ¥æ‰§è¡Œäº‹åŠ¡ï¼ˆä»¥åŠäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ï¼‰ï¼Œå¹¶ä¸”æœåŠ¡å™¨ä¿è¯ï¼Œåœ¨æ‰§è¡Œäº‹åŠ¡æœŸé—´ä¸ä¼šå¯¹äº‹åŠ¡è¿›è¡Œä¸­æ–­ï¼Œå› æ­¤ï¼ŒRedisçš„äº‹åŠ¡æ€»æ˜¯ä»¥ä¸²è¡Œçš„æ–¹å¼è¿è¡Œçš„ï¼Œå¹¶ä¸”äº‹åŠ¡ä¹Ÿæ€»æ˜¯å…·æœ‰éš”ç¦»æ€§çš„ã€‚

è€ä¹…æ€§

äº‹åŠ¡çš„è€ä¹…æ€§æŒ‡çš„æ˜¯ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªäº‹åŠ¡æ‰€å¾—çš„ç»“æœå·²ç»è¢«ä¿å­˜åˆ°æ°¸ä¹…æ€§å­˜å‚¨ä»‹è´¨ï¼ˆæ¯”å¦‚ç¡¬ç›˜ï¼‰é‡Œé¢äº†ï¼Œå³ä½¿æœåŠ¡å™¨åœ¨äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹ååœæœºï¼Œæ‰§è¡Œäº‹åŠ¡æ‰€å¾—çš„ç»“æœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

å› ä¸ºRedisçš„äº‹åŠ¡ä¸è¿‡æ˜¯ç®€å•åœ°ç”¨é˜Ÿåˆ—åŒ…è£¹èµ·äº†ä¸€ç»„Rediså‘½ä»¤ï¼ŒRediså¹¶æ²¡æœ‰ä¸ºäº‹åŠ¡æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œæ‰€ä»¥Redisäº‹åŠ¡çš„è€ä¹…æ€§ç”±Redisæ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼å†³å®š


### å¤åˆ¶

åœ¨Redisçš„ä¸»ä»å¤åˆ¶ä¸­,ç”¨æˆ·ä½¿ç”¨`slaveof`å‘½ä»¤æˆ–è€…è®¾ç½®slaveofé€‰é¡¹,å¯ä»¥è®©ä¸€ä¸ªæœåŠ¡å™¨å»å¤åˆ¶å¦ä¸€ä¸ªæœåŠ¡å™¨,è¢«å¤åˆ¶çš„æœåŠ¡å™¨å«ä¸»æœåŠ¡å™¨,å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œå¤åˆ¶çš„æœåŠ¡å™¨å«ä»æœåŠ¡å™¨

è¿›è¡Œå¤åˆ¶ä¸­çš„æœåŠ¡å™¨åŒæ–¹ä¿å­˜ç›¸åŒçš„æ•°æ®,æ¦‚å¿µä¸Šå°†è¿™ç§ç°è±¡å«æ•°æ®åº“çŠ¶æ€ä¸€è‡´.

è¿™é‡Œå…ˆä»‹ç»2.8ç‰ˆæœ¬ä»¥å‰ä½¿ç”¨çš„æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°åŸç†,å¹¶è¯´æ˜æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½åœ¨å¤„ç†æ–­çº¿åé‡æ–°è¿æ¥çš„ä»æœåŠ¡å™¨æ—¶ï¼Œä¼šé‡ä¸Šæ€æ ·çš„ä½æ•ˆæƒ…å†µã€‚æ¥ç€ï¼Œæœ¬ç« å°†ä»‹ç»Redisä»2.8ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨çš„æ–°ç‰ˆå¤åˆ¶åŠŸèƒ½æ˜¯å¦‚ä½•é€šè¿‡éƒ¨åˆ†é‡åŒæ­¥æ¥è§£å†³æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„ä½æ•ˆé—®é¢˜çš„ï¼Œå¹¶è¯´æ˜éƒ¨åˆ†é‡åŒæ­¥çš„å®ç°åŸç†ã€‚åœ¨æ­¤ä¹‹åï¼Œæœ¬ç« å°†åˆ—ä¸¾SLAVEOFå‘½ä»¤çš„å…·ä½“å®ç°æ­¥éª¤ï¼Œå¹¶åœ¨æœ¬ç« æœ€åï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¿ƒè·³æ£€æµ‹æœºåˆ¶çš„å®ç°åŸç†ï¼Œå¹¶å¯¹åŸºäºå¿ƒè·³æ£€æµ‹å®ç°çš„å‡ ä¸ªåŠŸèƒ½è¿›è¡Œä»‹ç»ã€‚

æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„å®ç°

Redisçš„å¤åˆ¶åˆ†ä¸ºåŒæ­¥å’Œå‘½ä»¤ä¼ æ’­ä¸¤ä¸ªæ“ä½œ:
1. åŒæ­¥çŠ¶æ€ç”¨ä½œå°†ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€.
2. å‘½ä»¤ä¼ æ’­æ“ä½œåˆ™ç”¨äºä¸»ä»æœåŠ¡å™¨çŠ¶æ€ä¸ä¸€è‡´,è®©ä¸»ä»æœåŠ¡å™¨çŠ¶æ€å›åˆ°ä¸€è‡´çš„çŠ¶æ€.

åŒæ­¥

å½“å®¢æˆ·ç«¯å‘ä»æœåŠ¡å™¨å‘é€salveofå‘½ä»¤æ—¶,è¦æ±‚ä»æœåŠ¡å™¨å¤åˆ¶ä¸»æœåŠ¡å™¨,ä»æœåŠ¡å™¨é¦–å…ˆéœ€è¦æ‰§è¡ŒåŒæ­¥æ“ä½œ,ä¹Ÿå°±æ˜¯å°†ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€.ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨çš„åŒæ­¥æ“ä½œéœ€è¦é€šè¿‡å‘ä¸»æœåŠ¡å™¨å‘é€SYNCå‘½ä»¤æ¥å®Œæˆ,ä»¥ä¸‹æ˜¯å‘é€SYNCå‘½ä»¤çš„æ­¥éª¤:
1. ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€SYNCå‘½ä»¤ã€‚
2. æ”¶åˆ°SYNCå‘½ä»¤çš„ä¸»æœåŠ¡å™¨æ‰§è¡ŒBGSAVEå‘½ä»¤åœ¨åå°ç”Ÿæˆä¸€ä¸ªRDBæ–‡ä»¶,å¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºè®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤.
3. å½“ä¸»æœåŠ¡å™¨BGSAVEå‘½ä»¤æ‰§è¡Œå®Œæˆ,ä¸»æœåŠ¡å™¨å°†BGSAVEç”Ÿæˆçš„RDBæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨,ä»æœåŠ¡å™¨æ¥æ”¶å¹¶è½½å…¥è¿™ä¸ªRDBæ–‡ä»¶,å°†è‡ªå·±çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨æ‰§è¡ŒBGSAVEå‘½ä»¤æ—¶çš„æ•°æ®åº“çŠ¶æ€
4. ä¸»æœåŠ¡å™¨å°†è®°å½•åœ¨ç¼“å†²åŒºé‡Œçš„æ‰€æœ‰å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨,ä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å†™å‘½ä»¤,å°†è‡ªå·±çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨æ‰€å¤„çš„çŠ¶æ€.

å‘½ä»¤ä¼ æ’­

åœ¨åŒæ­¥æ“ä½œå®Œæˆå,ä¸»ä»æœåŠ¡å™¨çŠ¶æ€å°†è¾¾æˆä¸€è‡´,ä½†å¦‚æœä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯å‘é€å†™å‘½ä»¤æ—¶,ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€å¯èƒ½è¢«ä¿®æ”¹,å¹¶å¯¼è‡´ä¸»ä»æœåŠ¡å™¨çŠ¶æ€ä¸å†ä¸€è‡´,ä¸ºäº†è®©ä¸»ä»æœåŠ¡å™¨å†æ¬¡å›åˆ°ä¸€è‡´çŠ¶æ€ï¼Œä¸»æœåŠ¡å™¨éœ€è¦å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ä¼ æ’­æ“ä½œï¼šä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤ï¼Œä¹Ÿå³æ˜¯é€ æˆä¸»ä»æœåŠ¡å™¨ä¸ä¸€è‡´çš„é‚£æ¡å†™å‘½ä»¤ï¼Œå‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œï¼Œå½“ä»æœåŠ¡å™¨æ‰§è¡Œäº†ç›¸åŒçš„å†™å‘½ä»¤ä¹‹åï¼Œä¸»ä»æœåŠ¡å™¨å°†å†æ¬¡å›åˆ°ä¸€è‡´çŠ¶æ€ã€‚

æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½çš„ç¼ºé™·:Redisä¸­ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨çš„å¤åˆ¶å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š
- åˆæ¬¡å¤åˆ¶ï¼šä»æœåŠ¡å™¨ä»¥å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…ä»æœåŠ¡å™¨å½“å‰è¦å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å’Œä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨ä¸åŒã€‚
- æ–­çº¿åé‡å¤åˆ¶ï¼šå¤„äºå‘½ä»¤ä¼ æ’­é˜¶æ®µçš„ä¸»ä»æœåŠ¡å™¨å› ä¸ºç½‘ç»œåŸå› è€Œä¸­æ–­äº†å¤åˆ¶ï¼Œä½†ä»æœåŠ¡å™¨é€šè¿‡è‡ªåŠ¨é‡è¿æ¥é‡æ–°è¿ä¸Šäº†ä¸»æœåŠ¡å™¨ï¼Œå¹¶ç»§ç»­å¤åˆ¶ä¸»æœåŠ¡å™¨ã€‚

å¯¹äºåˆæ¬¡å¤åˆ¶æ¥è¯´ï¼Œæ—§ç‰ˆå¤åˆ¶åŠŸèƒ½èƒ½å¤Ÿå¾ˆå¥½åœ°å®Œæˆä»»åŠ¡ï¼Œä½†å¯¹äºæ–­çº¿åé‡å¤åˆ¶æ¥è¯´ï¼Œæ—§ç‰ˆå¤åˆ¶åŠŸèƒ½è™½ç„¶ä¹Ÿèƒ½è®©ä¸»ä»æœåŠ¡å™¨é‡æ–°å›åˆ°ä¸€è‡´çŠ¶æ€ï¼Œä½†æ•ˆç‡å´éå¸¸ä½,éœ€è¦ä¸»æœåŠ¡å™¨å†æ¬¡å‘ç”ŸRDBæ–‡ä»¶.

æ–°ç‰ˆRediså¤åˆ¶åŠŸèƒ½çš„å®ç°:

ä¸ºäº†è§£å†³æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½åœ¨å¤„ç†æ–­çº¿é‡å¤åˆ¶æƒ…å†µæ—¶çš„ä½æ•ˆé—®é¢˜ï¼ŒRedisä»2.8ç‰ˆæœ¬å¼€å§‹ï¼Œä½¿ç”¨PSYNCå‘½ä»¤ä»£æ›¿SYNCå‘½ä»¤æ¥æ‰§è¡Œå¤åˆ¶æ—¶çš„åŒæ­¥æ“ä½œã€‚

PSYNCå‘½ä»¤æœ‰å®Œæ•´é‡åŒæ­¥å’Œéƒ¨åˆ†é‡åŒæ­¥ä¸¤ç§æ¨¡å¼:
- å…¶ä¸­å®Œæ•´é‡åŒæ­¥ç”¨äºå¤„ç†åˆæ¬¡å¤åˆ¶æƒ…å†µ:å®Œæ•´é‡åŒæ­¥çš„æ‰§è¡Œæ­¥éª¤å’ŒSYNCå‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤åŸºæœ¬ä¸€æ ·,éƒ½æ˜¯é€šè¿‡è®©ä¸»æœåŠ¡å™¨åˆ›å»ºå¹¶å‘é€RDBæ–‡ä»¶ï¼Œä»¥åŠå‘ä»æœåŠ¡å™¨å‘é€ä¿å­˜åœ¨ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤æ¥è¿›è¡ŒåŒæ­¥ã€‚
- éƒ¨åˆ†é‡åŒæ­¥åˆ™ç”¨äºå¤„ç†æ–­çº¿åå¤åˆ¶çš„æƒ…å†µ,å½“ä»æœåŠ¡å™¨åœ¨æ–­çº¿åé‡æ–°è¿æ¥ä¸»æœåŠ¡å™¨æ—¶,å¦‚æœæ¡ä»¶å…è®¸,ä¸»æœåŠ¡å™¨å¯ä»¥å°†ä¸»ä»æœåŠ¡å™¨è¿æ¥æ–­å¼€æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨åªè¦æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œå°±å¯ä»¥å°†æ•°æ®åº“æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„çŠ¶æ€ã€‚PSYNCå‘½ä»¤çš„éƒ¨åˆ†é‡åŒæ­¥æ¨¡å¼è§£å†³äº†æ—§ç‰ˆå¤åˆ¶åŠŸèƒ½åœ¨å¤„ç†æ–­çº¿åé‡å¤åˆ¶æ—¶å‡ºç°çš„ä½æ•ˆæƒ…å†µ.

éƒ¨åˆ†é‡åŒæ­¥çš„å®ç°

éƒ¨åˆ†é‡åŒæ­¥åŠŸèƒ½ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š
- ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼ˆreplication offsetï¼‰å’Œä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ã€‚
- ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼ˆreplication backlogï¼‰ã€‚
- æœåŠ¡å™¨çš„è¿è¡ŒIDï¼ˆrun IDï¼‰ã€‚

å¤åˆ¶åç§»é‡

æ‰§è¡Œå¤åˆ¶çš„åŒæ–¹â€”â€”ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¼šåˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼š
- ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨ä¼ æ’­Nä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸ŠNã€‚
- ä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„Nä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸ŠNã€‚

é€šè¿‡å¯¹æ¯”ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼Œç¨‹åºå¯ä»¥å¾ˆå®¹æ˜“åœ°çŸ¥é“ä¸»ä»æœåŠ¡å™¨æ˜¯å¦å¤„äºä¸€è‡´çŠ¶æ€ï¼šÂ·å¦‚æœä¸»ä»æœåŠ¡å™¨å¤„äºä¸€è‡´çŠ¶æ€ï¼Œé‚£ä¹ˆä¸»ä»æœåŠ¡å™¨ä¸¤è€…çš„åç§»é‡æ€»æ˜¯ç›¸åŒçš„ã€‚ç›¸åï¼Œå¦‚æœä¸»ä»æœåŠ¡å™¨ä¸¤è€…çš„åç§»é‡å¹¶ä¸ç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¹¶æœªå¤„äºä¸€è‡´çŠ¶æ€ã€‚

å¤åˆ¶ç§¯å‹ç¼“å†²åŒº

å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦ï¼ˆfixed-sizeï¼‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º1MBã€‚ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢ä¼šä¿å­˜ç€ä¸€éƒ¨åˆ†æœ€è¿‘ä¼ æ’­çš„å†™å‘½ä»¤ï¼Œå¹¶ä¸”å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡

å½“ä»æœåŠ¡å™¨é‡æ–°è¿ä¸Šä¸»æœåŠ¡å™¨æ—¶ï¼Œä»æœåŠ¡å™¨ä¼šé€šè¿‡PSYNCå‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡offsetå‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå¤åˆ¶åç§»é‡æ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œä½•ç§åŒæ­¥æ“ä½œï¼š
- å¦‚æœoffsetåç§»é‡ä¹‹åçš„æ•°æ®ï¼ˆä¹Ÿå³æ˜¯åç§»é‡offset+1å¼€å§‹çš„æ•°æ®ï¼‰ä»ç„¶å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œã€‚
- ç›¸åï¼Œå¦‚æœoffsetåç§»é‡ä¹‹åçš„æ•°æ®å·²ç»ä¸å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚

æœåŠ¡å™¨è¿è¡ŒID

é™¤äº†å¤åˆ¶åç§»é‡å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¹‹å¤–ï¼Œå®ç°éƒ¨åˆ†é‡åŒæ­¥è¿˜éœ€è¦ç”¨åˆ°æœåŠ¡å™¨è¿è¡ŒIDï¼ˆrun IDï¼‰ï¼š
æ¯ä¸ªRedisæœåŠ¡å™¨ï¼Œä¸è®ºä¸»æœåŠ¡å™¨è¿˜æ˜¯ä»æœåŠ¡ï¼Œéƒ½ä¼šæœ‰è‡ªå·±çš„è¿è¡ŒID

å½“ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡å¤åˆ¶æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±çš„è¿è¡ŒIDä¼ é€ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨åˆ™ä¼šå°†è¿™ä¸ªè¿è¡ŒIDä¿å­˜èµ·æ¥ã€‚

å½“ä»æœåŠ¡å™¨æ–­çº¿å¹¶é‡æ–°è¿ä¸Šä¸€ä¸ªä¸»æœåŠ¡å™¨æ—¶ï¼Œä»æœåŠ¡å™¨å°†å‘å½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨å‘é€ä¹‹å‰ä¿å­˜çš„è¿è¡ŒIDï¼šå¦‚æœä»æœåŠ¡å™¨ä¿å­˜çš„è¿è¡ŒIDå’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡ŒIDç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„å°±æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥ç»§ç»­å°è¯•æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œã€‚ç›¸ååœ°ï¼Œå¦‚æœä»æœåŠ¡å™¨ä¿å­˜çš„è¿è¡ŒIDå’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡ŒIDå¹¶ä¸ç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å¹¶ä¸æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚

PSYNCå‘½ä»¤çš„å®ç°

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ¬ç« åœ¨ä»‹ç»PSYNCå‘½ä»¤æ—¶ä¸€ç›´æ²¡æœ‰è¯´æ˜PSYNCå‘½ä»¤çš„å‚æ•°ä»¥åŠè¿”å›å€¼ï¼Œå› ä¸ºé‚£æ—¶æˆ‘ä»¬è¿˜æœªäº†è§£æœåŠ¡å™¨è¿è¡ŒIDã€å¤åˆ¶åç§»é‡ã€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºè¿™äº›ä¸œè¥¿ï¼Œåœ¨å­¦ä¹ äº†éƒ¨åˆ†é‡åŒæ­¥çš„å®ç°åŸç†ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ¥äº†è§£PSYNCå‘½ä»¤çš„å®Œæ•´ç»†èŠ‚äº†ã€‚

PSYNCå‘½ä»¤çš„è°ƒç”¨æ–¹æ³•æœ‰ä¸¤ç§ï¼š
å¦‚æœä»æœåŠ¡å™¨ä»¥å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…ä¹‹å‰æ‰§è¡Œè¿‡SLAVEOF no oneå‘½ä»¤ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€PSYNC ? -1å‘½ä»¤ï¼Œä¸»åŠ¨è¯·æ±‚ä¸»æœåŠ¡å™¨è¿›è¡Œå®Œæ•´é‡åŒæ­¥ï¼ˆå› ä¸ºè¿™æ—¶ä¸å¯èƒ½æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥ï¼‰
ç›¸ååœ°ï¼Œå¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€`PSYNC <runid> ${offset}`å‘½ä»¤ï¼šå…¶ä¸­runidæ˜¯ä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨çš„è¿è¡ŒIDï¼Œè€Œoffsetåˆ™æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡ï¼Œæ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤çš„ä¸»æœåŠ¡å™¨ä¼šé€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°æ¥åˆ¤æ–­åº”è¯¥å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå“ªç§åŒæ­¥æ“ä½œã€‚

æ ¹æ®æƒ…å†µï¼Œæ¥æ”¶åˆ°PSYNCå‘½ä»¤çš„ä¸»æœåŠ¡å™¨ä¼šå‘ä»æœåŠ¡å™¨è¿”å›ä»¥ä¸‹ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§ï¼š
å¦‚æœä¸»æœåŠ¡å™¨è¿”å›`+FULLRESYNC <runid> ${offset}`å›å¤ï¼Œé‚£ä¹ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨å°†ä¸ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œï¼šå…¶ä¸­runidæ˜¯è¿™ä¸ªä¸»æœåŠ¡å™¨çš„è¿è¡ŒIDï¼Œä»æœåŠ¡å™¨ä¼šå°†è¿™ä¸ªIDä¿å­˜èµ·æ¥ï¼Œåœ¨ä¸‹ä¸€æ¬¡å‘é€PSYNCå‘½ä»¤æ—¶ä½¿ç”¨ï¼›è€Œoffsetåˆ™æ˜¯ä¸»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡ï¼Œä»æœåŠ¡å™¨ä¼šå°†è¿™ä¸ªå€¼ä½œä¸ºè‡ªå·±çš„åˆå§‹åŒ–åç§»é‡ã€‚

å¦‚æœä¸»æœåŠ¡å™¨è¿”å›+CONTINUEå›å¤ï¼Œé‚£ä¹ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨å°†ä¸ä»æœåŠ¡å™¨æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼Œä»æœåŠ¡å™¨åªè¦ç­‰ç€ä¸»æœåŠ¡å™¨å°†è‡ªå·±ç¼ºå°‘çš„é‚£éƒ¨åˆ†æ•°æ®å‘é€è¿‡æ¥å°±å¯ä»¥äº†ã€‚

å¦‚æœä¸»æœåŠ¡å™¨è¿”å›-ERRå›å¤ï¼Œé‚£ä¹ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨çš„ç‰ˆæœ¬ä½äºRedis 2.8ï¼Œå®ƒè¯†åˆ«ä¸äº†PSYNCå‘½ä»¤ï¼Œä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€SYNCå‘½ä»¤ï¼Œå¹¶ä¸ä¸»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´åŒæ­¥æ“ä½œã€‚

å¤åˆ¶çš„å®ç°

é€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€SLAVEOFå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€ä¸ªä»æœåŠ¡å™¨å»å¤åˆ¶ä¸€ä¸ªä¸»æœåŠ¡å™¨

æ­¥éª¤1ï¼šè®¾ç½®ä¸»æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£

å½“å®¢æˆ·ç«¯å‘ä»æœåŠ¡å™¨å‘é€ä»¥ä¸‹å‘½ä»¤æ—¶ï¼š`slaveof 127.0.0.1 6379`, ä»æœåŠ¡å™¨é¦–å…ˆè¦åšçš„å°±æ˜¯å°†å®¢æˆ·ç«¯ç»™å®šçš„æœåŠ¡å™¨IPåœ°å€127.0.0.1ä»¥åŠç«¯å£6379ä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„masterhostå±æ€§å’Œmasterportå±æ€§é‡Œé¢.

SLAVEOFå‘½ä»¤æ˜¯ä¸€ä¸ªå¼‚æ­¥å‘½ä»¤ï¼Œåœ¨å®Œæˆmasterhostå±æ€§å’Œmasterportå±æ€§çš„è®¾ç½®å·¥ä½œä¹‹åï¼Œä»æœåŠ¡å™¨å°†å‘å‘é€SLAVEOFå‘½ä»¤çš„å®¢æˆ·ç«¯è¿”å›OKï¼Œè¡¨ç¤ºå¤åˆ¶æŒ‡ä»¤å·²ç»è¢«æ¥æ”¶ï¼Œè€Œå®é™…çš„å¤åˆ¶å·¥ä½œå°†åœ¨OKè¿”å›ä¹‹åæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œã€‚

æ­¥éª¤2ï¼šå»ºç«‹å¥—æ¥å­—è¿æ¥

åœ¨SLAVEOFå‘½ä»¤æ‰§è¡Œä¹‹åï¼Œä»æœåŠ¡å™¨å°†æ ¹æ®å‘½ä»¤æ‰€è®¾ç½®çš„IPåœ°å€å’Œç«¯å£ï¼Œåˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥ã€‚

å¦‚æœä»æœåŠ¡å™¨åˆ›å»ºçš„å¥—æ¥å­—èƒ½æˆåŠŸè¿æ¥ï¼ˆconnectï¼‰åˆ°ä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨å°†ä¸ºè¿™ä¸ªå¥—æ¥å­—å…³è”ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç†å¤åˆ¶å·¥ä½œçš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨å°†è´Ÿè´£æ‰§è¡Œåç»­çš„å¤åˆ¶å·¥ä½œï¼Œæ¯”å¦‚æ¥æ”¶RDBæ–‡ä»¶ï¼Œä»¥åŠæ¥æ”¶ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„å†™å‘½ä»¤ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚
è€Œä¸»æœåŠ¡å™¨åœ¨æ¥å—ï¼ˆacceptï¼‰ä»æœåŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥ä¹‹åï¼Œå°†ä¸ºè¯¥å¥—æ¥å­—åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†ä»æœåŠ¡å™¨çœ‹ä½œæ˜¯ä¸€ä¸ªè¿æ¥åˆ°ä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ¥å¯¹å¾…ï¼Œè¿™æ—¶ä»æœåŠ¡å™¨å°†åŒæ—¶å…·æœ‰æœåŠ¡å™¨ï¼ˆserverï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆclientï¼‰ä¸¤ä¸ªèº«ä»½ï¼šä»æœåŠ¡å™¨å¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œè€Œä¸»æœåŠ¡å™¨åˆ™ä¼šå‘ä»æœåŠ¡å™¨è¿”å›å‘½ä»¤å›å¤

å› ä¸ºå¤åˆ¶å·¥ä½œæ¥ä¸‹æ¥çš„å‡ ä¸ªæ­¥éª¤éƒ½ä¼šä»¥ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚çš„å½¢å¼æ¥è¿›è¡Œï¼Œæ‰€ä»¥ç†è§£â€œä»æœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯â€è¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚

æ­¥éª¤3ï¼šå‘é€PINGå‘½ä»¤

ä»æœåŠ¡å™¨æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ä¹‹åï¼Œåšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€ä¸ªPINGå‘½ä»¤

è™½ç„¶ä¸»ä»æœåŠ¡å™¨æˆåŠŸå»ºç«‹èµ·äº†å¥—æ¥å­—è¿æ¥ï¼Œä½†åŒæ–¹å¹¶æœªä½¿ç”¨è¯¥å¥—æ¥å­—è¿›è¡Œè¿‡ä»»ä½•é€šä¿¡ï¼Œé€šè¿‡å‘é€PINGå‘½ä»¤å¯ä»¥æ£€æŸ¥å¥—æ¥å­—çš„è¯»å†™çŠ¶æ€æ˜¯å¦æ­£å¸¸ã€‚

å› ä¸ºå¤åˆ¶å·¥ä½œæ¥ä¸‹æ¥çš„å‡ ä¸ªæ­¥éª¤éƒ½å¿…é¡»åœ¨ä¸»æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å¤„ç†å‘½ä»¤è¯·æ±‚çš„çŠ¶æ€ä¸‹æ‰èƒ½è¿›è¡Œï¼Œé€šè¿‡å‘é€PINGå‘½ä»¤å¯ä»¥æ£€æŸ¥ä¸»æœåŠ¡å™¨èƒ½å¦æ­£å¸¸å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚

ä»æœåŠ¡å™¨åœ¨å‘é€PINGå‘½ä»¤ä¹‹åå°†é‡åˆ°ä»¥ä¸‹ä¸‰ç§æƒ…å†µçš„å…¶ä¸­ä¸€ç§ï¼š

1. å¦‚æœä¸»æœåŠ¡å™¨å‘ä»æœåŠ¡å™¨è¿”å›äº†ä¸€ä¸ªå‘½ä»¤å›å¤ï¼Œä½†ä»æœåŠ¡å™¨å´ä¸èƒ½åœ¨è§„å®šçš„æ—¶é™ï¼ˆtimeoutï¼‰å†…è¯»å–å‡ºå‘½ä»¤å›å¤çš„å†…å®¹ï¼Œé‚£ä¹ˆè¡¨ç¤ºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥çŠ¶æ€ä¸ä½³ï¼Œä¸èƒ½ç»§ç»­æ‰§è¡Œå¤åˆ¶å·¥ä½œçš„åç»­æ­¥éª¤ã€‚å½“å‡ºç°è¿™ç§æƒ…å†µæ—¶ï¼Œä»æœåŠ¡å™¨æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—ã€‚
2. å¦‚æœä¸»æœåŠ¡å™¨å‘ä»æœåŠ¡å™¨è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨æš‚æ—¶æ²¡åŠæ³•å¤„ç†ä»æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚ï¼Œä¸èƒ½ç»§ç»­æ‰§è¡Œå¤åˆ¶å·¥ä½œçš„åç»­æ­¥éª¤ã€‚å½“å‡ºç°è¿™ç§æƒ…å†µæ—¶ï¼Œä»æœåŠ¡å™¨æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœä¸»æœåŠ¡å™¨æ­£åœ¨å¤„ç†ä¸€ä¸ªè¶…æ—¶è¿è¡Œçš„è„šæœ¬ï¼Œé‚£ä¹ˆå½“ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€PINGå‘½ä»¤æ—¶ï¼Œä»æœåŠ¡å™¨å°†æ”¶åˆ°ä¸»æœåŠ¡å™¨è¿”å›çš„BUSY Redisis busy running a script.You can only call SCRIPTKILL or SHUTDOWN NOSAVE.é”™è¯¯ã€‚
3. å¦‚æœä»æœåŠ¡å™¨è¯»å–åˆ°"PONG"å›å¤ï¼Œé‚£ä¹ˆè¡¨ç¤ºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥çŠ¶æ€æ­£å¸¸ï¼Œå¹¶ä¸”ä¸»æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å¤„ç†ä»æœåŠ¡å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»æœåŠ¡å™¨å¯ä»¥ç»§ç»­æ‰§è¡Œå¤åˆ¶å·¥ä½œçš„ä¸‹ä¸ªæ­¥éª¤ã€‚

æ­¥éª¤4ï¼šèº«ä»½éªŒè¯

ä»æœåŠ¡å™¨åœ¨æ”¶åˆ°ä¸»æœåŠ¡å™¨è¿”å›çš„"PONG"å›å¤ä¹‹åï¼Œä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯å†³å®šæ˜¯å¦è¿›è¡Œèº«ä»½éªŒè¯ï¼š

å¦‚æœä»æœåŠ¡å™¨è®¾ç½®äº†masterauthé€‰é¡¹ï¼Œé‚£ä¹ˆè¿›è¡Œèº«ä»½éªŒè¯ã€‚

å¦‚æœä»æœåŠ¡å™¨æ²¡æœ‰è®¾ç½®masterauthé€‰é¡¹ï¼Œé‚£ä¹ˆä¸è¿›è¡Œèº«ä»½éªŒè¯ã€‚

åœ¨éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯çš„æƒ…å†µä¸‹ï¼Œä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€æ¡AUTHå‘½ä»¤ï¼Œå‘½ä»¤çš„å‚æ•°ä¸ºä»æœåŠ¡å™¨masterauthé€‰é¡¹çš„å€¼ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä»æœåŠ¡å™¨masterauthé€‰é¡¹çš„å€¼ä¸º10086ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤AUTH 10086ï¼Œå¦‚å›¾15-18æ‰€ç¤ºã€‚

æ­¥éª¤5ï¼šå‘é€ç«¯å£ä¿¡æ¯

åœ¨ èº« ä»½ éªŒ è¯ æ­¥ éª¤ ä¹‹ å ï¼Œ ä» æœ åŠ¡ å™¨ å°† æ‰§ è¡Œ å‘½ ä»¤ REPLCONF listening-port <port-number>ï¼Œå‘ä¸»æœåŠ¡å™¨å‘é€ä»æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£å·ã€‚

æ­¥éª¤6ï¼šåŒæ­¥

åœ¨è¿™ä¸€æ­¥ï¼Œä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€PSYNCå‘½ä»¤ï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œï¼Œå¹¶å°†è‡ªå·±çš„æ•°æ®åº“æ›´æ–°è‡³ä¸»æœåŠ¡å™¨æ•°æ®åº“å½“å‰æ‰€å¤„çš„çŠ¶æ€ã€‚

æ­¥éª¤7ï¼šå‘½ä»¤ä¼ æ’­

å½“å®Œæˆäº†åŒæ­¥ä¹‹åï¼Œä¸»ä»æœåŠ¡å™¨å°±ä¼šè¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œè¿™æ—¶ä¸»æœåŠ¡å™¨åªè¦ä¸€ç›´å°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨åªè¦ä¸€ç›´æ¥æ”¶å¹¶æ‰§è¡Œä¸»æœåŠ¡å™¨å‘æ¥çš„å†™å‘½ä»¤ï¼Œå°±å¯ä»¥ä¿è¯ä¸»ä»æœåŠ¡å™¨ä¸€ç›´ä¿æŒä¸€è‡´äº†ã€‚

å¿ƒè·³æ£€æµ‹

åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä»æœåŠ¡å™¨é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼š

å…¶ä¸­replication_offsetæ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡ã€‚

å‘é€REPLCONF ACKå‘½ä»¤å¯¹äºä¸»ä»æœåŠ¡å™¨æœ‰ä¸‰ä¸ªä½œç”¨ï¼š

- æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ã€‚
- è¾…åŠ©å®ç°min-slavesé€‰é¡¹ã€‚
- æ£€æµ‹å‘½ä»¤ä¸¢å¤±ã€‚
ä»¥ä¸‹å°†åˆ†åˆ«ä»‹ç»è¿™ä¸‰ä¸ªä½œç”¨ã€‚

æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€:ä¸»ä»æœåŠ¡å™¨å¯ä»¥é€šè¿‡å‘é€å’Œæ¥æ”¶REPLCONF ACKå‘½ä»¤æ¥æ£€æŸ¥ä¸¤è€…ä¹‹é—´çš„ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼šå¦‚æœä¸»æœåŠ¡å™¨è¶…è¿‡ä¸€ç§’é’Ÿæ²¡æœ‰æ”¶åˆ°ä»æœåŠ¡å™¨å‘æ¥çš„REPLCONF ACKå‘½ä»¤ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°±çŸ¥é“ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°é—®é¢˜äº†ã€‚

é€šè¿‡å‘ä¸»æœåŠ¡å™¨å‘é€INFO replicationå‘½ä»¤ï¼Œåœ¨åˆ—å‡ºçš„ä»æœåŠ¡å™¨åˆ—è¡¨çš„lagä¸€æ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›¸åº”ä»æœåŠ¡å™¨æœ€åä¸€æ¬¡å‘ä¸»æœåŠ¡å™¨å‘é€REPLCONF ACKå‘½ä»¤è·ç¦»ç°åœ¨è¿‡äº†å¤šå°‘ç§’.åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œlagçš„å€¼åº”è¯¥åœ¨0ç§’æˆ–è€…1ä¹‹é—´è·³åŠ¨ï¼Œå¦‚æœè¶…è¿‡1ç§’çš„è¯ï¼Œé‚£ä¹ˆè¯´æ˜ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°äº†æ•…éšœã€‚

è¾…åŠ©å®ç°min-slavesé…ç½®é€‰é¡¹

Redisçš„min-slaves-to-writeå’Œmin-slaves-max-lagä¸¤ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢ä¸»æœåŠ¡å™¨åœ¨ä¸å®‰å…¨çš„æƒ…å†µä¸‹æ‰§è¡Œå†™å‘½ä»¤ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬å‘ä¸»æœåŠ¡å™¨æä¾›ä»¥ä¸‹è®¾ç½®ï¼š

é‚£ä¹ˆåœ¨ä»æœåŠ¡å™¨çš„æ•°é‡å°‘äº3ä¸ªï¼Œæˆ–è€…ä¸‰ä¸ªä»æœåŠ¡å™¨çš„å»¶è¿Ÿï¼ˆlagï¼‰å€¼éƒ½å¤§äºæˆ–ç­‰äº10ç§’æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤ï¼Œè¿™é‡Œçš„å»¶è¿Ÿå€¼å°±æ˜¯ä¸Šé¢æåˆ°çš„INFO replicationå‘½ä»¤çš„lagå€¼ã€‚

æ£€æµ‹å‘½ä»¤ä¸¢å¤±

å¦‚æœå› ä¸ºç½‘ç»œæ•…éšœï¼Œä¸»æœåŠ¡å™¨ä¼ æ’­ç»™ä»æœåŠ¡å™¨çš„å†™å‘½ä»¤åœ¨åŠè·¯ä¸¢å¤±ï¼Œé‚£ä¹ˆå½“ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€REPLCONF ACKå‘½ä»¤æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†å‘è§‰ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡å°‘äºè‡ªå·±çš„å¤åˆ¶åç§»é‡ï¼Œç„¶åä¸»æœåŠ¡å™¨å°±ä¼šæ ¹æ®ä»æœåŠ¡å™¨æäº¤çš„å¤åˆ¶åç§»é‡ï¼Œåœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢æ‰¾åˆ°ä»æœåŠ¡å™¨ç¼ºå°‘çš„æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®é‡æ–°å‘é€ç»™ä»æœåŠ¡å™¨ã€‚

### å“¨å…µ

Sentinel(å“¨å…µ)ç³»ç»Ÿæ˜¯Redisé«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆ,ç”±ä¸€ä¸ªæˆ–å¤šä¸ªSentinelå®ä¾‹ç»„æˆçš„Sentineliç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªæœåŠ¡å™¨,ä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨,å¹¶åœ¨è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨ä¸‹çº¿æ—¶,è‡ªåŠ¨å°†è¿™ä¸ªä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æŸä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨,ç„¶åç”±æ–°çš„ä¸»æœåŠ¡å™¨ä»£æ›¿å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨å¤„ç†è¯·æ±‚.

å½“server1çš„ä¸‹çº¿æ—¶é•¿è¶…è¿‡ç”¨æˆ·è®¾å®šçš„ä¸‹çº¿æ—¶é•¿ä¸Šé™æ—¶,Sentinelç³»ç»Ÿå°±ä¼šå¯¹server1æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œ.

å¦å¤–ï¼ŒSentinelè¿˜ä¼šç»§ç»­ç›‘è§†å·²ä¸‹çº¿çš„server1ï¼Œå¹¶åœ¨å®ƒé‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ã€‚

å½“ä¸€ä¸ªSentinelå¯åŠ¨æ—¶ï¼Œå®ƒéœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1ï¼‰åˆå§‹åŒ–æœåŠ¡å™¨ã€‚
2ï¼‰å°†æ™®é€šRedisæœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆSentinelä¸“ç”¨ä»£ç ã€‚
3ï¼‰åˆå§‹åŒ–SentinelçŠ¶æ€ã€‚
4ï¼‰æ ¹æ®ç»™å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–Sentinelçš„ç›‘è§†ä¸»æœåŠ¡å™¨åˆ—è¡¨ã€‚
5ï¼‰åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ã€‚

åˆå§‹åŒ–æœåŠ¡å™¨

Sentinelçš„æœ¬è´¨å°±æ˜¯è¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„RedisæœåŠ¡å™¨,æ‰€ä»¥ç¬¬ä¸€æ­¥å…¶å®æ˜¯å…ˆåˆå§‹åŒ–ä¸€ä¸ªæ™®é€šredisæœåŠ¡å™¨,ä¸è¿‡ï¼Œå› ä¸ºSentinelæ‰§è¡Œçš„å·¥ä½œå’Œæ™®é€šRedisæœåŠ¡å™¨æ‰§è¡Œçš„å·¥ä½œä¸åŒï¼Œæ‰€ä»¥Sentinelçš„åˆå§‹åŒ–è¿‡ç¨‹å’Œæ™®é€šRedisæœåŠ¡å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹å¹¶ä¸å®Œå…¨ç›¸åŒã€‚

ä¾‹å¦‚ï¼Œæ™®é€šæœåŠ¡å™¨åœ¨åˆå§‹åŒ–æ—¶ä¼šé€šè¿‡è½½å…¥RDBæ–‡ä»¶æˆ–è€…AOFæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ï¼Œä½†æ˜¯å› ä¸ºSentinelå¹¶ä¸ä½¿ç”¨æ•°æ®åº“ï¼Œæ‰€ä»¥åˆå§‹åŒ–Sentinelæ—¶å°±ä¸ä¼šè½½å…¥RDBæ–‡ä»¶æˆ–è€…AOFæ–‡ä»¶, sentinelå†…éƒ¨æ˜¯å¯ä»¥ä½¿ç”¨å‘å¸ƒè®¢é˜…åŠŸèƒ½çš„.

ä½¿ç”¨Sentinelä¸“ç”¨ä»£ç 

å¯åŠ¨Sentinelçš„ç¬¬äºŒä¸ªæ­¥éª¤å°±æ˜¯å°†ä¸€éƒ¨åˆ†æ™®é€šRedisæœåŠ¡å™¨ä½¿ç”¨çš„ä»£ ç  æ›¿ æ¢ æˆ Sentinel ä¸“ ç”¨ ä»£ ç  ã€‚ æ¯” å¦‚ è¯´ ï¼Œ æ™® é€š Redis æœ åŠ¡ å™¨ ä½¿ ç”¨redis.h/REDIS_SERVERPORTå¸¸é‡çš„å€¼ä½œä¸ºæœåŠ¡å™¨ç«¯å£

åˆå§‹åŒ–SentinelçŠ¶æ€

åœ¨åº”ç”¨äº†Sentinelçš„ä¸“ç”¨ä»£ç ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼ŒæœåŠ¡å™¨ä¼šåˆå§‹åŒ–ä¸€ä¸ªsentinel.c/sentinelStateç»“æ„ï¼ˆåé¢ç®€ç§°â€œSentinelçŠ¶æ€â€ï¼‰ï¼Œè¿™ä¸ªç»“æ„ä¿å­˜äº†æœåŠ¡å™¨ä¸­æ‰€æœ‰å’ŒSentinelåŠŸèƒ½æœ‰å…³çš„çŠ¶æ€

```c
struct sentinelState {
    //å½“å‰çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»
    uint64_t current_epoch;
    //ä¿å­˜äº†æ‰€æœ‰è¢«è¿™ä¸ªsentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨
    //å­—å…¸çš„é”®æ˜¯ä¸»æœåŠ¡å™¨çš„åå­—
    //å­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªæŒ‡å‘sentinelRedisInstanceç»“æ„çš„æŒ‡é’ˆ
    dict *masters;
    //æ˜¯å¦è¿›å…¥äº†TILTæ¨¡å¼ï¼Ÿ
    int tilt;
    //ç›®å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬çš„æ•°é‡
    int running_scripts;
    //è¿›å…¥TILTæ¨¡å¼çš„æ—¶é—´
    mstime_t tilt_start_time;
    //æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¤„ç†å™¨çš„æ—¶é—´
    mstime_t previous_time;
    //ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼ŒåŒ…å«äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç”¨æˆ·è„šæœ¬
    list *scripts_queue;
} sentinel;
```
å­—å…¸çš„é”®æ˜¯è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„åå­—, è€Œ å­— å…¸ çš„ å€¼ åˆ™ æ˜¯ è¢« ç›‘ è§† ä¸» æœ åŠ¡ å™¨ å¯¹ åº” çš„sentinel.c/sentinelRedisInstanceç»“æ„ã€‚

```c
typedef struct sentinelRedisInstance {
    //æ ‡è¯†å€¼ï¼Œè®°å½•äº†å®ä¾‹çš„ç±»å‹ï¼Œä»¥åŠè¯¥å®ä¾‹çš„å½“å‰çŠ¶æ€
    int flags;
    //å®ä¾‹çš„åå­—
    //ä¸»æœåŠ¡å™¨çš„åå­—ç”±ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®
    //ä»æœåŠ¡å™¨ä»¥åŠSentinelçš„åå­—ç”±Sentinelè‡ªåŠ¨è®¾ç½®
    //æ ¼å¼ä¸ºip:portï¼Œä¾‹å¦‚"127.0.0.1:26379"
    char *name;
    //å®ä¾‹çš„è¿è¡ŒID
    char *runid;
    //é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»
    uint64_t config_epoch;
    //å®ä¾‹çš„åœ°å€
    sentinelAddr *addr;
    // SENTINEL down-after-millisecondsé€‰é¡¹è®¾å®šçš„å€¼
    //å®ä¾‹æ— å“åº”å¤šå°‘æ¯«ç§’ä¹‹åæ‰ä¼šè¢«åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ï¼ˆsubjectively downï¼‰
    mstime_t down_after_period;
    // SENTINEL monitor <master-name> <IP> <port> <quorum>é€‰é¡¹ä¸­çš„quorumå‚æ•°
    //åˆ¤æ–­è¿™ä¸ªå®ä¾‹ä¸ºå®¢è§‚ä¸‹çº¿ï¼ˆobjectively downï¼‰æ‰€éœ€çš„æ”¯æŒæŠ•ç¥¨æ•°é‡
    int quorum;
    // SENTINEL parallel-syncs <master-name> <number>é€‰é¡¹çš„å€¼
    //åœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œæ—¶ï¼Œå¯ä»¥åŒæ—¶å¯¹æ–°çš„ä¸»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥çš„ä»æœåŠ¡å™¨æ•°é‡
    int parallel_syncs;
    // SENTINEL failover-timeout <master-name> <ms>é€‰é¡¹çš„å€¼
    //åˆ·æ–°æ•…éšœè¿ç§»çŠ¶æ€çš„æœ€å¤§æ—¶é™
    mstime_t failover_timeout;
    // ...
} sentinelRedisInstance;

// sentinelRedisInstance.addr å± æ€§ æ˜¯ ä¸€ ä¸ª æŒ‡ å‘sentinel.c/sentinelAddrç»“æ„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªç»“æ„ä¿å­˜ç€å®ä¾‹çš„IPåœ°å€å’Œç«¯å£å·
typedef struct sentinelAddr {
    char *ip;
    int port;
} sentinelAddr;
```
åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥

åˆå§‹åŒ–Sentinelçš„æœ€åä¸€æ­¥æ˜¯åˆ›å»ºè¿å‘è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ï¼ŒSentinelå°†æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œå®ƒå¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶ä»å‘½ä»¤å›å¤ä¸­è·å–ç›¸å…³çš„ä¿¡æ¯ã€‚

å¯¹äºæ¯ä¸ªè¢«Sentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨æ¥è¯´ï¼ŒSentinelä¼šåˆ›å»ºä¸¤ä¸ªè¿å‘ä¸»æœåŠ¡å™¨çš„å¼‚æ­¥ç½‘ç»œè¿æ¥ï¼š
- ä¸€ä¸ªæ˜¯å‘½ä»¤è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥ä¸“é—¨ç”¨äºå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶æ¥æ”¶å‘½ä»¤å›å¤ã€‚
- å¦ä¸€ä¸ªæ˜¯è®¢é˜…è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥ä¸“é—¨ç”¨äºè®¢é˜…ä¸»æœåŠ¡å™¨çš„__sentinel__:helloé¢‘é“ã€‚

ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªè¿æ¥ï¼Ÿ

åœ¨Redisç›®å‰çš„å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ä¸­ï¼Œè¢«å‘é€çš„ä¿¡æ¯éƒ½ä¸ä¼šä¿å­˜åœ¨RedisæœåŠ¡å™¨é‡Œé¢ï¼Œå¦‚æœåœ¨ä¿¡æ¯å‘é€æ—¶ï¼Œæƒ³è¦æ¥æ”¶ä¿¡æ¯çš„å®¢æˆ·ç«¯ä¸åœ¨çº¿æˆ–è€…æ–­çº¿ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯å°±ä¼šä¸¢å¤±è¿™æ¡ä¿¡æ¯ã€‚å› æ­¤ï¼Œä¸ºäº†ä¸ä¸¢å¤±__sentinel__:helloé¢‘é“çš„ä»»ä½•ä¿¡æ¯ï¼ŒSentinelå¿…é¡»ä¸“é—¨ç”¨ä¸€ä¸ªè®¢é˜…è¿æ¥æ¥æ¥æ”¶è¯¥é¢‘é“çš„ä¿¡æ¯ã€‚å¦ä¸€æ–¹é¢ï¼Œé™¤äº†è®¢é˜…é¢‘é“ä¹‹å¤–ï¼ŒSentinelè¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œä»¥æ­¤æ¥ä¸ä¸»æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥Sentinelè¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨åˆ›å»ºå‘½ä»¤è¿æ¥ã€‚
å› ä¸ºSentineléœ€è¦ä¸å¤šä¸ªå®ä¾‹åˆ›å»ºå¤šä¸ªç½‘ç»œè¿æ¥ï¼Œæ‰€ä»¥Sentinelä½¿ç”¨çš„æ˜¯å¼‚æ­¥è¿æ¥

è·å–ä¸»æœåŠ¡å™¨ä¿¡æ¯

å“¨å…µä¼šé»˜è®¤ä»¥10ç§’ä¸€æ¬¡çš„é¢‘ç‡é€šè¿‡å‘½ä»¤å‘è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å‘é€INFOå‘½ä»¤,å¹¶é€šè¿‡åˆ†æINFOå‘½ä»¤çš„å›å¤æ¥è·å–ä¸»æœåŠ¡å™¨çš„å½“å‰æ¶ˆæ¯.

é€šè¿‡åˆ†æä¸»æœåŠ¡å™¨è¿”å›çš„INFOå‘½ä»¤å›å¤ï¼ŒSentinelå¯ä»¥è·å–ä»¥ä¸‹ä¸¤æ–¹é¢çš„ä¿¡æ¯ï¼š

ä¸€æ–¹é¢æ˜¯å…³äºä¸»æœåŠ¡å™¨æœ¬èº«çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬run_idåŸŸè®°å½•çš„æœåŠ¡å™¨è¿è¡ŒIDï¼Œä»¥åŠroleåŸŸè®°å½•çš„æœåŠ¡å™¨è§’è‰²ï¼›
å¦ä¸€æ–¹é¢æ˜¯å…³äºä¸»æœåŠ¡å™¨å±ä¸‹æ‰€æœ‰ä»æœåŠ¡å™¨çš„ä¿¡æ¯.è‡³äºä¸»æœåŠ¡å™¨è¿”å›çš„ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œåˆ™ä¼šè¢«ç”¨äºæ›´æ–°ä¸»æœåŠ¡å™¨å®ä¾‹ç»“æ„çš„slaveså­—å…¸ï¼Œè¿™ä¸ªå­—å…¸è®°å½•äº†ä¸»æœåŠ¡å™¨å±ä¸‹ä»æœåŠ¡å™¨çš„åå•.

è·å–ä»æœåŠ¡å™¨ä¿¡æ¯

å½“Sentinelå‘ç°ä¸»æœåŠ¡å™¨æœ‰æ–°çš„ä»æœåŠ¡å™¨å‡ºç°æ—¶ï¼ŒSentinelé™¤äº†ä¼šä¸ºè¿™ä¸ªæ–°çš„ä»æœåŠ¡å™¨åˆ›å»ºç›¸åº”çš„å®ä¾‹ç»“æ„ä¹‹å¤–ï¼ŒSentinelè¿˜ä¼šåˆ›å»ºè¿æ¥åˆ°ä»æœåŠ¡å™¨çš„å‘½ä»¤è¿æ¥å’Œè®¢é˜…è¿æ¥ã€‚

åœ¨åˆ›å»ºå‘½ä»¤è¿æ¥ä¹‹åï¼ŒSentinelåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡é€šè¿‡å‘½ä»¤è¿æ¥å‘ä»æœåŠ¡å™¨å‘é€INFOå‘½ä»¤.

æ ¹æ®INFOå‘½ä»¤çš„å›å¤ï¼ŒSentinelä¼šæå–å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š
Â·ä»æœåŠ¡å™¨çš„è¿è¡ŒID run_idã€‚
Â·ä»æœåŠ¡å™¨çš„è§’è‰²roleã€‚
Â· ä¸» æœ åŠ¡ å™¨ çš„ IP åœ° å€ master_host ï¼Œ ä»¥ åŠ ä¸» æœ åŠ¡ å™¨ çš„ ç«¯ å£ å·
master_portã€‚
Â·ä¸»ä»æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€master_link_statusã€‚
Â·ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§slave_priorityã€‚
Â·ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡slave_repl_offsetã€‚æ ¹æ®è¿™äº›ä¿¡æ¯ï¼ŒSentinelä¼šå¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°.

å‘ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä¿¡æ¯

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinelä¼šä»¥æ¯ä¸¤ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘æ‰€æœ‰è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä»¥ä¸‹æ ¼å¼çš„å‘½ä»¤
```
PUBLISH __sentinel__:hello "<s_ip>,<s_port>,<s_runid>,<s_epoch>,<m_name>,<m_ip>,<m_port>,<m_epoch>"
```
è¿™æ¡å‘½ä»¤å‘æœåŠ¡å™¨çš„__sentinel__:helloé¢‘é“å‘é€äº†ä¸€æ¡ä¿¡æ¯ï¼Œä¿¡æ¯çš„å†…å®¹ç”±å¤šä¸ªå‚æ•°ç»„æˆï¼š

Â·å…¶ä¸­ä»¥s_å¼€å¤´çš„å‚æ•°è®°å½•çš„æ˜¯Sentinelæœ¬èº«çš„ä¿¡æ¯Â·è€Œm_å¼€å¤´çš„å‚æ•°è®°å½•çš„åˆ™æ˜¯ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯

æ¥æ”¶æ¥è‡ªä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨çš„é¢‘é“ä¿¡æ¯

å½“Sentinelä¸ä¸€ä¸ªä¸»æœåŠ¡å™¨æˆ–è€…ä»æœåŠ¡å™¨å»ºç«‹èµ·è®¢é˜…è¿æ¥ä¹‹åï¼ŒSentinelå°±ä¼šé€šè¿‡è®¢é˜…è¿æ¥ï¼Œå‘æœåŠ¡å™¨å‘é€ä»¥ä¸‹å‘½ä»¤
```
SUBSCRIBE __sentinel__:hello
```

Sentinelå¯¹__sentinel__:helloé¢‘é“çš„è®¢é˜…ä¼šä¸€ç›´æŒç»­åˆ°Sentinelä¸æœåŠ¡å™¨çš„è¿æ¥æ–­å¼€ä¸ºæ­¢ã€‚
è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸ªä¸Sentinelè¿æ¥çš„æœåŠ¡å™¨ï¼ŒSentinelæ—¢é€šè¿‡å‘½ä»¤è¿æ¥å‘æœåŠ¡å™¨çš„__sentinel__:helloé¢‘é“å‘é€ä¿¡æ¯ï¼Œåˆé€šè¿‡è®¢é˜…è¿æ¥ä»æœåŠ¡å™¨çš„__sentinel__:helloé¢‘é“æ¥æ”¶ä¿¡æ¯

å¯¹äºç›‘è§†åŒä¸€ä¸ªæœåŠ¡å™¨çš„å¤šä¸ªSentinelæ¥è¯´ï¼Œä¸€ä¸ªSentinelå‘é€çš„ ä¿¡ æ¯ ä¼š è¢« å…¶ ä»– Sentinel æ¥ æ”¶ åˆ° ï¼Œ è¿™ äº› ä¿¡ æ¯ ä¼š è¢« ç”¨ äº æ›´ æ–° å…¶ ä»–Sentinelå¯¹å‘é€ä¿¡æ¯Sentinelçš„è®¤çŸ¥ï¼Œä¹Ÿä¼šè¢«ç”¨äºæ›´æ–°å…¶ä»–Sentinelå¯¹è¢«ç›‘è§†æœåŠ¡å™¨çš„è®¤çŸ¥ã€‚

å½“ ä¸€ ä¸ª Sentinel ä» __sentinel__:hello é¢‘ é“ æ”¶ åˆ° ä¸€ æ¡ ä¿¡ æ¯ æ—¶ ï¼ŒSentinelä¼šå¯¹è¿™æ¡ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œæå–å‡ºä¿¡æ¯ä¸­çš„Sentinel IPåœ°å€ã€Sentinelç«¯å£å·ã€Sentinelè¿è¡ŒIDç­‰å…«ä¸ªå‚æ•°ï¼Œå¹¶è¿›è¡Œä»¥ä¸‹æ£€æŸ¥:å¦‚æœä¿¡æ¯ä¸­è®°å½•çš„Sentinelè¿è¡ŒIDå’Œæ¥æ”¶ä¿¡æ¯çš„Sentinelçš„è¿è¡ŒIDç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜è¿™æ¡ä¿¡æ¯æ˜¯Sentinelè‡ªå·±å‘é€çš„ï¼ŒSentinelå°†ä¸¢å¼ƒè¿™æ¡ä¿¡æ¯ï¼Œä¸åšè¿›ä¸€æ­¥å¤„ç†.ç›¸ å åœ° ï¼Œ å¦‚ æœ ä¿¡ æ¯ ä¸­ è®° å½• Sentinel è¿ è¡Œ ID å’Œ æ¥ æ”¶ ä¿¡ æ¯ çš„Sentinelçš„è¿è¡ŒIDä¸ç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜è¿™æ¡ä¿¡æ¯æ˜¯ç›‘è§†åŒä¸€ä¸ªæœåŠ¡å™¨çš„å…¶ä»–Sentinelå‘æ¥çš„ï¼Œæ¥æ”¶ä¿¡æ¯çš„Sentinelå°†æ ¹æ®ä¿¡æ¯ä¸­çš„å„ä¸ªå‚æ•°ï¼Œå¯¹ç›¸åº”ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°ã€‚

æ›´æ–°sentinelså­—å…¸

Sentinelä¸ºä¸»æœåŠ¡å™¨åˆ›å»ºçš„å®ä¾‹ç»“æ„ä¸­çš„sentinelså­—å…¸ä¿å­˜äº†é™¤Sentinelæœ¬èº«ä¹‹å¤–ï¼Œæ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ªä¸»æœåŠ¡å™¨çš„å…¶ä»–Sentinelçš„èµ„æ–™

å› ä¸ºä¸€ä¸ªSentinelå¯ä»¥é€šè¿‡åˆ†ææ¥æ”¶åˆ°çš„é¢‘é“ä¿¡æ¯æ¥è·çŸ¥å…¶ä»–Sentinelçš„å­˜åœ¨ï¼Œå¹¶é€šè¿‡å‘é€é¢‘é“ä¿¡æ¯æ¥è®©å…¶ä»–SentinelçŸ¥é“è‡ªå·±çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨ä½¿ç”¨Sentinelçš„æ—¶å€™å¹¶ä¸éœ€è¦æä¾›å„ä¸ªSentinelçš„åœ°å€ä¿¡æ¯ï¼Œç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ªSentinelå¯ä»¥è‡ªåŠ¨å‘ç°å¯¹æ–¹ã€‚

åˆ›å»ºè¿å‘å…¶ä»–Sentinelçš„å‘½ä»¤è¿æ¥

å½“Sentinelé€šè¿‡é¢‘é“ä¿¡æ¯å‘ç°ä¸€ä¸ªæ–°çš„Sentinelæ—¶ï¼Œå®ƒä¸ä»…ä¼šä¸ºæ–°Sentinelåœ¨sentinelså­—å…¸ä¸­åˆ›å»ºç›¸åº”çš„å®ä¾‹ç»“æ„ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªè¿å‘æ–°Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œ è€Œ æ–° Sentinel ä¹Ÿ åŒ æ · ä¼š åˆ› å»º è¿ å‘ è¿™ ä¸ª
Sentinelçš„å‘½ä»¤è¿æ¥ï¼Œæœ€ç»ˆç›‘è§†åŒä¸€ä¸»æœåŠ¡å™¨çš„å¤šä¸ªSentinelå°†å½¢æˆç›¸ äº’ è¿ æ¥ çš„ ç½‘ ç»œ ï¼š Sentinel A æœ‰ è¿ å‘ Sentinel B çš„ å‘½ ä»¤ è¿ æ¥ ï¼Œ è€ŒSentinel Bä¹Ÿæœ‰è¿å‘Sentinel Açš„å‘½ä»¤è¿æ¥ã€‚

ä½¿ç”¨å‘½ä»¤è¿æ¥ç›¸è¿çš„å„ä¸ªSentinelå¯ä»¥é€šè¿‡å‘å…¶ä»–Sentinelå‘é€å‘½ä»¤è¯·æ±‚æ¥è¿›è¡Œä¿¡æ¯äº¤æ¢ï¼Œæœ¬ç« æ¥ä¸‹æ¥å°†å¯¹Sentinelå®ç°ä¸»è§‚ä¸‹çº¿æ£€æµ‹å’Œå®¢è§‚ä¸‹çº¿æ£€æµ‹çš„åŸç†è¿›è¡Œä»‹ç»ï¼Œè¿™ä¸¤ç§æ£€æµ‹éƒ½ä¼šä½¿ç”¨Sentinelä¹‹é—´çš„å‘½ä»¤è¿æ¥æ¥è¿›è¡Œé€šä¿¡ã€‚

Sentinelä¹‹é—´ä¸ä¼šåˆ›å»ºè®¢é˜…è¿æ¥

æ£€æµ‹ä¸»è§‚ä¸‹çº¿çŠ¶æ€

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinelä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å®ƒåˆ›å»ºäº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆåŒ…æ‹¬ä¸»æœåŠ¡å™¨ã€ä»æœåŠ¡å™¨ã€å…¶ä»–Sentinelåœ¨å†…ï¼‰å‘é€PINGå‘½ä»¤ï¼Œå¹¶é€šè¿‡å®ä¾‹è¿”å›çš„PINGå‘½ä»¤å›å¤æ¥åˆ¤æ–­å®ä¾‹æ˜¯å¦åœ¨çº¿ã€‚

å¦‚æœé…ç½®æ–‡ä»¶æŒ‡å®šSentinel1çš„down-after-millisecondsé€‰é¡¹çš„å€¼ä¸º50000æ¯«ç§’ï¼Œé‚£ä¹ˆå½“ä¸»æœåŠ¡å™¨masterè¿ç»­50000æ¯«ç§’éƒ½å‘Sentinel1è¿”å›æ— æ•ˆå›å¤æ—¶ï¼ŒSentinel1å°±ä¼šå°†masteræ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œå¹¶åœ¨masteræ‰€å¯¹åº”çš„å®ä¾‹ç»“æ„çš„flagså±æ€§ä¸­æ‰“å¼€SRI_S_DOWNæ ‡è¯†

ä¸»è§‚ä¸‹çº¿æ—¶é•¿é€‰é¡¹çš„ä½œç”¨èŒƒå›´

ç”¨æˆ·è®¾ç½®çš„down-after-millisecondsé€‰é¡¹çš„å€¼ï¼Œä¸ä»…ä¼šè¢«Sentinelç”¨æ¥åˆ¤æ–­ä¸»æœåŠ¡å™¨çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€ï¼Œè¿˜ä¼šè¢«ç”¨äºåˆ¤æ–­ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä»¥åŠæ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ªä¸»æœåŠ¡å™¨çš„å…¶ä»–Sentinelçš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœç”¨æˆ·å‘Sentinelè®¾ç½®äº†ä»¥ä¸‹é…ç½®ï¼š

```
sentinel monitor master 127.0.0.1 6379 2
sentinel down-after-milliseconds master 50000
```

é‚£ä¹ˆ50000æ¯«ç§’ä¸ä»…ä¼šæˆä¸ºSentinelåˆ¤æ–­masterè¿›å…¥ä¸»è§‚ä¸‹çº¿çš„æ ‡å‡†ï¼Œè¿˜ä¼šæˆä¸ºSentinelåˆ¤æ–­masterå±ä¸‹æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä»¥åŠæ‰€æœ‰åŒæ ·ç›‘è§†masterçš„å…¶ä»–Sentinelè¿›å…¥ä¸»è§‚ä¸‹çº¿çš„æ ‡å‡†ã€‚

å¤šä¸ªSentinelè®¾ç½®çš„ä¸»è§‚ä¸‹çº¿æ—¶é•¿å¯èƒ½ä¸åŒ

down-after-millisecondsé€‰é¡¹å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå¯¹äºç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ªSentinelæ¥è¯´ï¼Œè¿™äº›Sentinelæ‰€è®¾ç½®çš„down-after-millisecondsé€‰é¡¹çš„å€¼ä¹Ÿå¯èƒ½ä¸åŒï¼Œå› æ­¤ï¼Œå½“ä¸€ä¸ªSentinelå°†ä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿æ—¶ï¼Œå…¶ä»–Sentinelå¯èƒ½ä»ç„¶ä¼šè®¤ä¸ºä¸»æœåŠ¡å™¨å¤„äºåœ¨çº¿çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœSentinel1è½½å…¥äº†ä»¥ä¸‹é…ç½®ï¼š
```
sentinel monitor master 127.0.0.1 6379 2
sentinel down-after-milliseconds master 50000
```
è€ŒSentinel2åˆ™è½½å…¥äº†ä»¥ä¸‹é…ç½®ï¼š
```
sentinel monitor master 127.0.0.1 6379 2
sentinel down-after-milliseconds master 10000
```
é‚£ä¹ˆå½“masterçš„æ–­çº¿æ—¶é•¿è¶…è¿‡10000æ¯«ç§’ä¹‹åï¼ŒSentinel2ä¼šå°†masteråˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œè€ŒSentinel1å´è®¤ä¸ºmasterä»ç„¶åœ¨ çº¿ ã€‚ åª æœ‰ å½“ master çš„ æ–­ çº¿ æ—¶ é•¿ è¶… è¿‡ 50000 æ¯« ç§’ ä¹‹ å ï¼Œ
Sentinel1å’ŒSentinel2æ‰ä¼šéƒ½è®¤ä¸ºmasterè¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚

æ£€æŸ¥å®¢è§‚ä¸‹çº¿çŠ¶æ€

å½“Sentinelå°†ä¸€ä¸ªä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ä¹‹åï¼Œä¸ºäº†ç¡®è®¤è¿™ä¸ªä¸»æœåŠ¡å™¨æ˜¯å¦çœŸçš„ä¸‹çº¿äº†ï¼Œå®ƒä¼šå‘åŒæ ·ç›‘è§†è¿™ä¸€ä¸»æœåŠ¡å™¨çš„å…¶ä»–Sentinelè¿›è¡Œè¯¢é—®ï¼Œçœ‹å®ƒä»¬æ˜¯å¦ä¹Ÿè®¤ä¸ºä¸»æœåŠ¡å™¨å·²ç»è¿›å…¥äº†ä¸‹çº¿çŠ¶æ€ï¼ˆå¯ä»¥æ˜¯ä¸»è§‚ä¸‹çº¿æˆ–è€…å®¢è§‚ä¸‹çº¿ï¼‰ã€‚å½“Sentinelä»å…¶ä»–Sentinelé‚£é‡Œæ¥æ”¶åˆ°è¶³å¤Ÿæ•°é‡çš„å·²ä¸‹çº¿åˆ¤æ–­ä¹‹åï¼ŒSentinelå°±ä¼šå°†ä»æœåŠ¡å™¨åˆ¤å®šä¸ºå®¢è§‚ä¸‹çº¿ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚

å‘é€SENTINEL is-master-down-by-addrå‘½ä»¤
```
SENTINEL is-master-down-by-addr <ip> <port> <current_epoch> <runid>
```

æ¥æ”¶SENTINEL is-master-down-by-addrå‘½ä»¤

å½“ä¸€ä¸ªSentinelï¼ˆç›®æ ‡Sentinelï¼‰æ¥æ”¶åˆ°å¦ä¸€ä¸ªSentinelï¼ˆæºSentinel ï¼‰ å‘ æ¥ çš„ SENTINEL is-master-down-by å‘½ ä»¤ æ—¶ ï¼Œ ç›® æ ‡Sentinelä¼šåˆ†æå¹¶å–å‡ºå‘½ä»¤è¯·æ±‚ä¸­åŒ…å«çš„å„ä¸ªå‚æ•°ï¼Œå¹¶æ ¹æ®å…¶ä¸­çš„ä¸»æœåŠ¡å™¨IPå’Œç«¯å£å·ï¼Œæ£€æŸ¥ä¸»æœåŠ¡å™¨æ˜¯å¦å·²ä¸‹çº¿ï¼Œç„¶åå‘æºSentinelè¿”å› ä¸€ æ¡ åŒ… å« ä¸‰ ä¸ª å‚ æ•° çš„ Multi Bulk å› å¤ ä½œ ä¸º SENTINEL is-master-down-byå‘½ä»¤çš„å›å¤ï¼š

æ ¹æ®å…¶ä»–Sentinelå‘å›çš„SENTINEL is-master-down-by-addrå‘½ä»¤å›å¤ï¼ŒSentinelå°†ç»Ÿè®¡å…¶ä»–SentinelåŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿çš„æ•°é‡ï¼Œå½“è¿™ä¸€æ•°é‡è¾¾åˆ°é…ç½®æŒ‡å®šçš„åˆ¤æ–­å®¢è§‚ä¸‹çº¿æ‰€éœ€çš„æ•°é‡æ—¶ï¼ŒSentinelä¼šå°†ä¸»æœåŠ¡å™¨å®ä¾‹ç»“æ„flagså±æ€§çš„SRI_O_DOWNæ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºä¸»æœåŠ¡å™¨å·²ç»è¿›å…¥å®¢è§‚ä¸‹çº¿çŠ¶æ€.

å®¢è§‚ä¸‹çº¿çŠ¶æ€çš„åˆ¤æ–­æ¡ä»¶

å½“è®¤ä¸ºä¸»æœåŠ¡å™¨å·²ç»è¿›å…¥ä¸‹çº¿çŠ¶æ€çš„Sentinelçš„æ•°é‡ï¼Œè¶…è¿‡Sentinelé…ç½®ä¸­è®¾ç½®çš„quorumå‚æ•°çš„å€¼ï¼Œé‚£ä¹ˆè¯¥Sentinelå°±ä¼šè®¤ä¸ºä¸»æœåŠ¡å™¨å·²ç»è¿›å…¥å®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœSentinelåœ¨å¯åŠ¨æ—¶è½½å…¥äº†ä»¥ä¸‹é…ç½®
```
sentinel monitor master 127.0.0.1 6379 2
```
é‚£ä¹ˆåŒ…æ‹¬å½“å‰Sentinelåœ¨å†…ï¼Œåªè¦æ€»å…±æœ‰ä¸¤ä¸ªSentinelè®¤ä¸ºä¸»æœåŠ¡å™¨å·²ç»è¿›å…¥ä¸‹çº¿çŠ¶æ€ï¼Œé‚£ä¹ˆå½“å‰Sentinelå°±å°†ä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºå®¢è§‚ä¸‹çº¿


ä¸åŒSentinelåˆ¤æ–­å®¢è§‚ä¸‹çº¿çš„æ¡ä»¶å¯èƒ½ä¸åŒ

åŒæ ·ä»¥å¤šçš„ä¸ºä¸»

é€‰ä¸¾é¢†å¤´Sentinel

å½“ä¸€ä¸ªä¸»æœåŠ¡å™¨è¢«åˆ¤æ–­ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼Œç›‘è§†è¿™ä¸ªä¸‹çº¿ä¸»æœåŠ¡å™¨çš„å„ ä¸ª Sentinel ä¼š è¿› è¡Œ å å•† ï¼Œ é€‰ ä¸¾ å‡º ä¸€ ä¸ª é¢† å¤´ Sentinel ï¼Œ å¹¶ ç”± é¢† å¤´Sentinelå¯¹ä¸‹çº¿ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚

ä»¥ä¸‹æ˜¯Redisé€‰ä¸¾é¢†å¤´Sentinelçš„è§„åˆ™å’Œæ–¹æ³•ï¼š

æ‰€æœ‰åœ¨çº¿çš„Sentineléƒ½æœ‰è¢«é€‰ä¸ºé¢†å¤´Sentinelçš„èµ„æ ¼ï¼Œæ¢å¥è¯è¯´ï¼Œç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ªåœ¨çº¿Sentinelä¸­çš„ä»»æ„ä¸€ä¸ªéƒ½æœ‰å¯èƒ½æˆä¸ºé¢†å¤´Sentinelã€‚

Â· æ¯ æ¬¡ è¿› è¡Œ é¢† å¤´ Sentinel é€‰ ä¸¾ ä¹‹ å ï¼Œ ä¸ è®º é€‰ ä¸¾ æ˜¯ å¦ æˆ åŠŸ ï¼Œ æ‰€ æœ‰Sentinelçš„é…ç½®çºªå…ƒï¼ˆconfiguration epochï¼‰çš„å€¼éƒ½ä¼šè‡ªå¢ä¸€æ¬¡ã€‚é…ç½®çºªå…ƒå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ã€‚
Â·åœ¨ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œé¢ï¼Œæ‰€æœ‰Sentineléƒ½æœ‰ä¸€æ¬¡å°†æŸä¸ªSentinelè®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´Sentinelçš„æœºä¼šï¼Œå¹¶ä¸”å±€éƒ¨é¢†å¤´ä¸€æ—¦è®¾ç½®ï¼Œåœ¨è¿™ä¸ªé…ç½®çºªå…ƒé‡Œé¢å°±ä¸èƒ½å†æ›´æ”¹ã€‚
Â· æ¯ ä¸ª å‘ ç° ä¸» æœ åŠ¡ å™¨ è¿› å…¥ å®¢ è§‚ ä¸‹ çº¿ çš„ Sentinel éƒ½ ä¼š è¦ æ±‚ å…¶ ä»–Sentinelå°†è‡ªå·±è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´Sentinelã€‚
Â· å½“ ä¸€ ä¸ª Sentinel ï¼ˆ æº Sentinel ï¼‰ å‘ å¦ ä¸€ ä¸ª Sentinel ï¼ˆ ç›® æ ‡Sentinelï¼‰å‘é€SENTINEL is-master-down-by-addrå‘½ä»¤ï¼Œå¹¶ä¸”å‘½ä»¤ä¸­çš„runidå‚æ•°ä¸æ˜¯*ç¬¦å·è€Œæ˜¯æºSentinelçš„è¿è¡ŒIDæ—¶ï¼Œè¿™è¡¨ç¤ºæºSentinelè¦æ±‚ç›®æ ‡Sentinelå°†å‰è€…è®¾ç½®ä¸ºåè€…çš„å±€éƒ¨é¢†å¤´Sentinelã€‚
Â·Sentinelè®¾ç½®å±€éƒ¨é¢†å¤´Sentinelçš„è§„åˆ™æ˜¯å…ˆåˆ°å…ˆå¾—ï¼šæœ€å…ˆå‘ç›®æ ‡Sentinelå‘é€è®¾ç½®è¦æ±‚çš„æºSentinelå°†æˆä¸ºç›®æ ‡Sentinelçš„å±€éƒ¨é¢†å¤´Sentinelï¼Œè€Œä¹‹åæ¥æ”¶åˆ°çš„æ‰€æœ‰è®¾ç½®è¦æ±‚éƒ½ä¼šè¢«ç›®æ ‡Sentinelæ‹’ç»ã€‚
Â·ç›®æ ‡Sentinelåœ¨æ¥æ”¶åˆ°SENTINEL is-master-down-by-addrå‘½ä»¤ä¹‹åï¼Œå°†å‘æºSentinelè¿”å›ä¸€æ¡å‘½ä»¤å›å¤ï¼Œå›å¤ä¸­çš„leader_runidå‚ æ•° å’Œ leader_epoch å‚ æ•° åˆ† åˆ« è®° å½• äº† ç›® æ ‡ Sentinel çš„ å±€ éƒ¨ é¢† å¤´Sentinelçš„è¿è¡ŒIDå’Œé…ç½®çºªå…ƒã€‚
Â·æºSentinelåœ¨æ¥æ”¶åˆ°ç›®æ ‡Sentinelè¿”å›çš„å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šæ£€æŸ¥å›å¤ä¸­leader_epochå‚æ•°çš„å€¼å’Œè‡ªå·±çš„é…ç½®çºªå…ƒæ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆæºSentinelç»§ç»­å–å‡ºå›å¤ä¸­çš„leader_runidå‚æ•°ï¼Œå¦‚æœleader_runidå‚æ•°çš„å€¼å’ŒæºSentinelçš„è¿è¡ŒIDä¸€è‡´ï¼Œé‚£ä¹ˆè¡¨ç¤ºç›®æ ‡Sentinelå°†æºSentinelè®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´Sentinelã€‚
Â·å¦‚æœæœ‰æŸä¸ªSentinelè¢«åŠæ•°ä»¥ä¸Šçš„Sentinelè®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´Sentinelï¼Œé‚£ä¹ˆè¿™ä¸ªSentinelæˆä¸ºé¢†å¤´Sentinelã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªç”± 10 ä¸ª Sentinel ç»„ æˆ çš„ Sentinel ç³» ç»Ÿ é‡Œ é¢ ï¼Œ åª è¦ æœ‰ å¤§ äºç­‰ äº10/2+1=6ä¸ªSentinelå°†æŸä¸ªSentinelè®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´Sentinelï¼Œé‚£ä¹ˆè¢«è®¾ç½®çš„é‚£ä¸ªSentinelå°±ä¼šæˆä¸ºé¢†å¤´Sentinelã€‚
Â·å› ä¸ºé¢†å¤´Sentinelçš„äº§ç”Ÿéœ€è¦åŠæ•°ä»¥ä¸ŠSentinelçš„æ”¯æŒï¼Œå¹¶ä¸”æ¯ä¸ªSentinelåœ¨æ¯ä¸ªé…ç½®çºªå…ƒé‡Œé¢åªèƒ½è®¾ç½®ä¸€æ¬¡å±€éƒ¨é¢†å¤´Sentinelï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œé¢ï¼Œåªä¼šå‡ºç°ä¸€ä¸ªé¢†å¤´Sentinelã€‚
Â·å¦‚æœåœ¨ç»™å®šæ—¶é™å†…ï¼Œæ²¡æœ‰ä¸€ä¸ªSentinelè¢«é€‰ä¸¾ä¸ºé¢†å¤´Sentinelï¼Œé‚£ä¹ˆå„ä¸ªSentinelå°†åœ¨ä¸€æ®µæ—¶é—´ä¹‹åå†æ¬¡è¿›è¡Œé€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºé¢†å¤´Sentinelä¸ºæ­¢ã€‚

æ•…éšœè½¬ç§»

åœ¨é€‰ä¸¾äº§ç”Ÿå‡ºé¢†å¤´Sentinelä¹‹åï¼Œé¢†å¤´Sentinelå°†å¯¹å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œï¼Œè¯¥æ“ä½œåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š
1ï¼‰åœ¨å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»æœåŠ¡å™¨ã€‚
2ï¼‰è®©å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ã€‚
3ï¼‰å°†å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨è®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œå½“è¿™ä¸ªæ—§çš„ä¸»æœåŠ¡å™¨é‡æ–°ä¸Šçº¿æ—¶ï¼Œå®ƒå°±ä¼šæˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ã€‚

é€‰å‡ºæ–°çš„ä¸»æœåŠ¡å™¨

æ•…éšœè½¬ç§»æ“ä½œç¬¬ä¸€æ­¥è¦åšçš„å°±æ˜¯åœ¨å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¸­ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªçŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´çš„ä»æœåŠ¡å™¨ï¼Œç„¶åå‘è¿™ä¸ªä»æœåŠ¡å™¨å‘é€SLAVEOF no oneå‘½ä»¤ï¼Œå°†è¿™ä¸ªä»æœåŠ¡å™¨è½¬æ¢ä¸ºä¸»æœåŠ¡å™¨ã€‚

æ–°çš„ä¸»æœåŠ¡å™¨æ˜¯æ€æ ·æŒ‘é€‰å‡ºæ¥çš„

é¢†å¤´Sentinelä¼šå°†å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¿å­˜åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œé¢ï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹è§„åˆ™ï¼Œä¸€é¡¹ä¸€é¡¹åœ°å¯¹åˆ—è¡¨è¿›è¡Œè¿‡æ»¤ï¼š

1ï¼‰åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰å¤„äºä¸‹çº¿æˆ–è€…æ–­çº¿çŠ¶æ€çš„ä»æœåŠ¡å™¨ï¼Œè¿™å¯ä»¥ä¿è¯åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨éƒ½æ˜¯æ­£å¸¸åœ¨çº¿çš„ã€‚
2ï¼‰åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰æœ€è¿‘äº”ç§’å†…æ²¡æœ‰å›å¤è¿‡é¢†å¤´Sentinelçš„INFOå‘½ä»¤çš„ä»æœåŠ¡å™¨ï¼Œè¿™å¯ä»¥ä¿è¯åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨éƒ½æ˜¯æœ€è¿‘æˆåŠŸè¿›è¡Œè¿‡é€šä¿¡çš„ã€‚
3ï¼‰åˆ é™¤æ‰€æœ‰ä¸å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨è¿æ¥æ–­å¼€è¶…è¿‡down-after-milliseconds*10æ¯«ç§’çš„ä»æœåŠ¡å™¨ï¼šdown-after-millisecondsé€‰é¡¹æŒ‡å®šäº†åˆ¤æ–­ä¸»æœåŠ¡å™¨ä¸‹çº¿æ‰€éœ€çš„æ—¶é—´ï¼Œè€Œåˆ é™¤æ–­å¼€æ—¶é•¿è¶…è¿‡down-after-milliseconds*10æ¯«ç§’çš„ä»æœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥ä¿è¯åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨éƒ½æ²¡æœ‰è¿‡æ—©åœ°ä¸ä¸»æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œæ¢å¥è¯è¯´ï¼Œåˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨ä¿å­˜çš„æ•°æ®éƒ½æ˜¯æ¯”è¾ƒæ–°çš„ã€‚

ä¹‹åï¼Œé¢†å¤´Sentinelå°†æ ¹æ®ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§ï¼Œå¯¹åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ä»æœåŠ¡å™¨ã€‚

å¦‚æœæœ‰å¤šä¸ªå…·æœ‰ç›¸åŒæœ€é«˜ä¼˜å…ˆçº§çš„ä»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆé¢†å¤´Sentinelå°†æŒ‰ç…§ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼Œå¯¹å…·æœ‰ç›¸åŒæœ€é«˜ä¼˜å…ˆçº§çš„æ‰€æœ‰ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­åç§»é‡æœ€å¤§çš„ä»æœåŠ¡å™¨ï¼ˆå¤åˆ¶åç§»é‡æœ€å¤§çš„ä»æœåŠ¡å™¨å°±æ˜¯ä¿å­˜ç€æœ€æ–°æ•°æ®çš„ä»æœåŠ¡å™¨ï¼‰ã€‚
æœ€åï¼Œå¦‚æœæœ‰å¤šä¸ªä¼˜å…ˆçº§æœ€é«˜ã€å¤åˆ¶åç§»é‡æœ€å¤§çš„ä»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆé¢†å¤´Sentinelå°†æŒ‰ç…§è¿è¡ŒIDå¯¹è¿™äº›ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­è¿è¡ŒIDæœ€å°çš„ä»æœåŠ¡å™¨ã€‚

ä¿®æ”¹ä»æœåŠ¡å™¨çš„å¤åˆ¶ç›®æ ‡

å½“æ–°çš„ä¸»æœåŠ¡å™¨å‡ºç°ä¹‹åï¼Œé¢†å¤´Sentinelä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯ï¼Œè®©å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨å»å¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼Œè¿™ä¸€åŠ¨ä½œå¯ä»¥é€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€SLAVEOFå‘½ä»¤æ¥å®ç°.

å°†æ—§çš„ä¸»æœåŠ¡å™¨å˜ä¸ºä»æœåŠ¡å™¨

æ•…éšœè½¬ç§»æ“ä½œæœ€åè¦åšçš„æ˜¯ï¼Œå°†å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨è®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨å› ä¸ºæ—§çš„ä¸»æœåŠ¡å™¨å·²ç»ä¸‹çº¿ï¼Œæ‰€ä»¥è¿™ç§è®¾ç½®æ˜¯ä¿å­˜åœ¨server1å¯¹åº”çš„å®ä¾‹ç»“æ„é‡Œé¢çš„ï¼Œå½“server1é‡æ–°ä¸Šçº¿æ—¶ï¼ŒSentinelå°±ä¼šå‘å®ƒå‘é€SLAVEOFå‘½ä»¤ï¼Œè®©å®ƒæˆä¸ºserver2çš„ä»æœåŠ¡å™¨ã€‚

### é›†ç¾¤

Redisé›†ç¾¤æ˜¯Redisæä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé›†ç¾¤é€šè¿‡åˆ†ç‰‡ï¼ˆshardingï¼‰æ¥è¿›è¡Œæ•°æ®å…±äº«ï¼Œå¹¶æä¾›å¤åˆ¶å’Œæ•…éšœè½¬ç§»åŠŸèƒ½ã€‚

æœ¬èŠ‚å°†å¯¹é›†ç¾¤çš„èŠ‚ç‚¹ã€æ§½æŒ‡æ´¾ã€å‘½ä»¤æ‰§è¡Œã€é‡æ–°åˆ†ç‰‡ã€è½¬å‘ã€æ•…éšœè½¬ç§»ã€æ¶ˆæ¯ç­‰å„ä¸ªæ–¹é¢è¿›è¡Œä»‹ç»ã€‚

èŠ‚ç‚¹

ä¸€ä¸ªRedisé›†ç¾¤é€šå¸¸ç”±å¤šä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ç»„æˆï¼Œåœ¨åˆšå¼€å§‹çš„æ—¶å€™ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå®ƒä»¬éƒ½å¤„äºä¸€ä¸ªåªåŒ…å«è‡ªå·±çš„é›†ç¾¤å½“ä¸­ï¼Œè¦ç»„å»ºä¸€ä¸ªçœŸæ­£å¯å·¥ä½œçš„é›†ç¾¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†å„ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªåŒ…å«å¤šä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ã€‚

è¿æ¥å„ä¸ªèŠ‚ç‚¹çš„å·¥ä½œå¯ä»¥ä½¿ç”¨`CLUSER MEET <ip> <port>`å‘½ä»¤æ¥å®Œæˆ

è·Ÿä¸€ä¸ªèŠ‚ç‚¹å‘ç”ŸCLUSER MEETå‘½ä»¤å¯ä»¥è®©nodeèŠ‚ç‚¹ä¸ipå’Œportæ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ¡æ‰‹,å½“æ¡æ‰‹æˆåŠŸånodeèŠ‚ç‚¹å°±ä¼šå°†ipå’Œportæ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°nodeèŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ä¸­.

å¯åŠ¨èŠ‚ç‚¹

ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„RedisæœåŠ¡å™¨ï¼ŒRedisæœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ä¼šæ ¹æ®cluster-enabledé…ç½®é€‰é¡¹æ˜¯å¦ä¸ºyesæ¥å†³å®šæ˜¯å¦å¼€å¯æœåŠ¡å™¨çš„é›†ç¾¤æ¨¡å¼

èŠ‚ç‚¹ä¼šç»§ç»­ä½¿ç”¨æ‰€æœ‰åœ¨å•æœºæ¨¡å¼ä¸­ä½¿ç”¨çš„æœåŠ¡å™¨ç»„ä»¶, æ¯”å¦‚è¯´ä¼šç»§ç»­ä½¿ç”¨æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†å‘½ä»¤è¯·æ±‚å’Œè¿”å›å‘½ä»¤è¯·æ±‚...

é›†ç¾¤æ•°æ®ç»“æ„

clusterNodeç»“æ„ä¿å­˜äº†ä¸€ä¸ªèŠ‚ç‚¹çš„å½“å‰çŠ¶æ€,æ¯”å¦‚èŠ‚ç‚¹åˆ›å»ºçš„æ—¶é—´,èŠ‚ç‚¹çš„åå­—,èŠ‚ç‚¹å½“å‰çš„é…ç½®çºªå…ƒ,èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£å·ç­‰,æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨clusterNodeç»“æ„æ¥è®°å½•è‡ªå·±çš„çŠ¶æ€,å¹¶ä¸ºé›†ç¾¤ä¸­çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹éƒ½åˆ›å»ºä¸€ä¸ªç›¸åº”çš„clusterNodeç»“æ„,ä»¥æ­¤æ¥è®°å½•å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€.
```c
struct clusterNode {
    //åˆ›å»ºèŠ‚ç‚¹çš„æ—¶é—´
    mstime_t ctime;
    //èŠ‚ç‚¹çš„åå­—ï¼Œç”±40ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ç»„æˆ
    //ä¾‹å¦‚68eef66df23420a5862208ef5b1a7005b806f2ff
    char name[REDIS_CLUSTER_NAMELEN];
    //èŠ‚ç‚¹æ ‡è¯†
    //ä½¿ç”¨å„ç§ä¸åŒçš„æ ‡è¯†å€¼è®°å½•èŠ‚ç‚¹çš„è§’è‰²ï¼ˆæ¯”å¦‚ä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹ï¼‰ï¼Œ
    //ä»¥åŠèŠ‚ç‚¹ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼ˆæ¯”å¦‚åœ¨çº¿æˆ–è€…ä¸‹çº¿ï¼‰ã€‚
    int flags;
    //èŠ‚ç‚¹å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»
    uint64_t configEpoch;
    //èŠ‚ç‚¹çš„IPåœ°å€
    char ip[REDIS_IP_STR_LEN];
    //èŠ‚ç‚¹çš„ç«¯å£å·
    int port;
    //ä¿å­˜è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯
    clusterLink *link;
    // ...
};
```
linkå±æ€§å¯¹åº”çš„æ˜¯clusterLinkç»“æ„,è¯¥ç»“æ„ä¿å­˜çš„å…¶å®æ˜¯è¿æ¥èŠ‚ç‚¹æ‰€éœ€è¦çš„æœ‰å…³ä¿¡æ¯,æ¯”å¦‚socketæè¿°ç¬¦,è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒº:
```c
typedef struct clusterLink {
    //è¿æ¥çš„åˆ›å»ºæ—¶é—´
    mstime_t ctime;
    // TCPå¥—æ¥å­—æè¿°ç¬¦
    int fd;
    //è¾“å‡ºç¼“å†²åŒºï¼Œä¿å­˜ç€ç­‰å¾…å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼ˆmessageï¼‰ã€‚
    sds sndbuf;
    //è¾“å…¥ç¼“å†²åŒºï¼Œä¿å­˜ç€ä»å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚
    sds rcvbuf;
    //ä¸è¿™ä¸ªè¿æ¥ç›¸å…³è”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¸ºNULL
    struct clusterNode *node;
} clusterLink;
```
redisClientå’ŒclusterLinkç»“æ„éƒ½æœ‰è‡ªå·±çš„socketæè¿°ç¬¦,è¾“å…¥è¾“å‡ºç¼“å†²åŒº,åŒºåˆ«åœ¨äº,redisClientçš„socketæ˜¯è¿æ¥å®¢æˆ·ç«¯çš„,clusterLinkçš„socketæ˜¯è¿æ¥é›†ç¾¤èŠ‚ç‚¹çš„.

æœ€åï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ªclusterStateç»“æ„ï¼Œè¿™ä¸ªç»“æ„è®°å½•äº†åœ¨å½“å‰èŠ‚ç‚¹çš„è§†è§’ä¸‹ï¼Œé›†ç¾¤ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œä¾‹å¦‚é›†ç¾¤æ˜¯åœ¨çº¿è¿˜æ˜¯ä¸‹çº¿ï¼Œé›†ç¾¤åŒ…å«å¤šå°‘ä¸ªèŠ‚ç‚¹ï¼Œé›†ç¾¤å½“å‰çš„é…ç½®çºªå…ƒï¼Œè¯¸å¦‚æ­¤ç±»
```c
typedef struct clusterState {
    //æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„æŒ‡é’ˆ
    clusterNode *myself;
    //é›†ç¾¤å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»
    uint64_t currentEpoch;
    //é›†ç¾¤å½“å‰çš„çŠ¶æ€ï¼šæ˜¯åœ¨çº¿è¿˜æ˜¯ä¸‹çº¿
    int state;
    //é›†ç¾¤ä¸­è‡³å°‘å¤„ç†ç€ä¸€ä¸ªæ§½çš„èŠ‚ç‚¹çš„æ•°é‡
    int size;
    //é›†ç¾¤èŠ‚ç‚¹åå•ï¼ˆåŒ…æ‹¬myselfèŠ‚ç‚¹ï¼‰
    //å­—å…¸çš„é”®ä¸ºèŠ‚ç‚¹çš„åå­—ï¼Œå­—å…¸çš„å€¼ä¸ºèŠ‚ç‚¹å¯¹åº”çš„clusterNodeç»“æ„
    dict *nodes;
    // ...
} clusterState;
```
CLUSTER MEETå‘½ä»¤çš„å®ç°

é€šè¿‡å‘èŠ‚ç‚¹Aå‘é€CLUSTER MEETå‘½ä»¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥è®©æ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹Aå°†å¦ä¸€ä¸ªèŠ‚ç‚¹Bæ·»åŠ åˆ°èŠ‚ç‚¹Aå½“å‰æ‰€åœ¨çš„é›†ç¾¤é‡Œé¢
1ï¼‰èŠ‚ç‚¹Aä¼šä¸ºèŠ‚ç‚¹Båˆ›å»ºä¸€ä¸ªclusterNodeç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„clusterState.nodeså­—å…¸é‡Œé¢ã€‚
2ï¼‰ä¹‹åï¼ŒèŠ‚ç‚¹Aå°†æ ¹æ®CLUSTER MEETå‘½ä»¤ç»™å®šçš„IPåœ°å€å’Œç«¯å£å·ï¼Œå‘èŠ‚ç‚¹Bå‘é€ä¸€æ¡MEETæ¶ˆæ¯ï¼ˆmessageï¼‰ã€‚
3ï¼‰å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼ŒèŠ‚ç‚¹Bå°†æ¥æ”¶åˆ°èŠ‚ç‚¹Aå‘é€çš„MEETæ¶ˆæ¯ï¼ŒèŠ‚ç‚¹Bä¼šä¸ºèŠ‚ç‚¹Aåˆ›å»ºä¸€ä¸ªclusterNodeç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„clusterState.nodeså­—å…¸é‡Œé¢ã€‚
4ï¼‰ä¹‹åï¼ŒèŠ‚ç‚¹Bå°†å‘èŠ‚ç‚¹Aè¿”å›ä¸€æ¡PONGæ¶ˆæ¯ã€‚
5ï¼‰å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼ŒèŠ‚ç‚¹Aå°†æ¥æ”¶åˆ°èŠ‚ç‚¹Bè¿”å›çš„PONGæ¶ˆæ¯ï¼Œé€šè¿‡è¿™æ¡PONGæ¶ˆæ¯èŠ‚ç‚¹Aå¯ä»¥çŸ¥é“èŠ‚ç‚¹Bå·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·±å‘é€çš„MEETæ¶ˆæ¯ã€‚
6ï¼‰ä¹‹åï¼ŒèŠ‚ç‚¹Aå°†å‘èŠ‚ç‚¹Bè¿”å›ä¸€æ¡PINGæ¶ˆæ¯ã€‚
7ï¼‰å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼ŒèŠ‚ç‚¹Bå°†æ¥æ”¶åˆ°èŠ‚ç‚¹Aè¿”å›çš„PINGæ¶ˆæ¯ï¼Œé€šè¿‡è¿™æ¡PINGæ¶ˆæ¯èŠ‚ç‚¹Bå¯ä»¥çŸ¥é“èŠ‚ç‚¹Aå·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·±è¿”å›çš„PONGæ¶ˆæ¯ï¼Œæ¡æ‰‹å®Œæˆã€‚

ä¹‹åï¼ŒèŠ‚ç‚¹Aä¼šå°†èŠ‚ç‚¹Bçš„ä¿¡æ¯é€šè¿‡Gossipåè®®ä¼ æ’­ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè®©å…¶ä»–èŠ‚ç‚¹ä¹Ÿä¸èŠ‚ç‚¹Bè¿›è¡Œæ¡æ‰‹ï¼Œæœ€ç»ˆï¼Œç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒèŠ‚ç‚¹Bä¼šè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è®¤è¯†ã€‚

#### æ§½æŒ‡æ´¾

Redisé›†ç¾¤é€šè¿‡åˆ†ç‰‡çš„å½¢å¼æ¥ä¿å­˜redisæ•°æ®åº“ä¸­çš„é”®å€¼å¯¹,é›†ç¾¤ä¸­æ•´ä¸ªæ•°æ®åº“è¢«åˆ†æˆ16384ä¸ªæ§½,æ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½æ•°æ®è¿™äº›æ§½ä¸­çš„ä¸€ä¸ª,é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å¤„ç†0-16384ä¸ªæ§½.

å½“æ•°æ®åº“ä¸­çš„16384ä¸ªæ§½éƒ½æœ‰èŠ‚ç‚¹å¤„ç†æ—¶,é›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€,ç›¸åè‹¥æœ‰ä¸€ä¸ªæ§½æ²¡æœ‰è¢«å¤„ç†,åˆ™æ•´ä¸ªé›†ç¾¤æ˜¯ä¸‹çº¿çŠ¶æ€.

é€šè¿‡å‘èŠ‚ç‚¹å‘é€`CLUSTER ADDSLOTS`å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ§½æŒ‡æ´¾ï¼ˆassignï¼‰ç»™èŠ‚ç‚¹è´Ÿè´£.
```c
CLUSTER ADDSLOTS <slot> [slot ...]
127.0.0.1:7000> CLUSTER ADDSLOTS 0 1 2 3 4 ... 5000
OK
127.0.0.1:7000> CLUSTER NODES
9dfb4c4e016e627d9769e4c9bb0d4fa208e65c26 127.0.0.1:7002 master - 0 1388316664849 0 connected
68eef66df23420a5862208ef5b1a7005b806f2ff 127.0.0.1:7001 master - 0 1388316665850 0 connected
51549e625cfda318ad27423a31e7476fe3cd2939 :0 myself,master - 0 0 0 connected 0-5000
// ä¸ºäº†è®©7000ã€7001ã€7002ä¸‰ä¸ªèŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤è¿›å…¥ä¸Šçº¿çŠ¶æ€ï¼Œæˆ‘ä»¬ç»§ç»­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†æ§½5001è‡³æ§½10000æŒ‡æ´¾ç»™èŠ‚ç‚¹7001è´Ÿè´£ï¼š
127.0.0.1:7001> CLUSTER ADDSLOTS 5001 5002 5003 5004 ... 10000
OK
127.0.0.1:7002> CLUSTER ADDSLOTS 10001 10002 10003 10004 ... 16383
OK
```
æ•°æ®åº“ä¸­çš„16384ä¸ªæ§½éƒ½å·²ç»è¢«æŒ‡æ´¾ç»™äº†ç›¸åº”çš„èŠ‚ç‚¹ï¼Œé›†ç¾¤è¿›å…¥ä¸Šçº¿çŠ¶æ€

è®°å½•èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯

clusterNodeç»“æ„çš„slotså±æ€§å’Œnumslotå±æ€§è®°å½•äº†èŠ‚ç‚¹è´Ÿè´£å¤„ç†å“ªäº›æ§½ï¼š
```c
struct clusterNode {
    // ...
    unsigned char slots[16384/8];
    int numslots;
};
```
å¦‚æœslotsæ•°ç»„åœ¨ç´¢å¼•iä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º1ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹è´Ÿè´£å¤„ç†æ§½iã€‚å¦‚æœslotsæ•°ç»„åœ¨ç´¢å¼•iä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º0ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹ä¸è´Ÿè´£å¤„ç†æ§½iã€‚

è‡³äºnumslotså±æ€§åˆ™è®° å½• èŠ‚ ç‚¹ è´Ÿ è´£ å¤„ ç† çš„ æ§½ çš„ æ•° é‡ ï¼Œ ä¹Ÿ å³ æ˜¯slotsæ•°ç»„ä¸­å€¼ä¸º1çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡

ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯

ä¸€ä¸ªèŠ‚ç‚¹é™¤äº†å°†è‡ªå·±è´Ÿè´£å¤„ç†çš„æ§½è®°å½•åœ¨clusterNodeç»“æ„çš„slotså±æ€§å’Œnumslots,å®ƒè¿˜ä¼šå°†è‡ªå·±çš„slotsæ•°ç»„é€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œä»¥æ­¤æ¥å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹è‡ªå·±ç›®å‰è´Ÿè´£å¤„ç†å“ªäº›æ§½ã€‚

å½“èŠ‚ç‚¹Aé€šè¿‡æ¶ˆæ¯æ¥æ”¶åˆ°äº†Bçš„slotsæ•°ç»„,èŠ‚ç‚¹Aä¼šä»è‡ªå·±çš„clusterState.nodeså­—å…¸ä¸­æŸ¥æ‰¾èŠ‚ç‚¹Bå¯¹åº”çš„clusterNodeç»“æ„,å¹¶å¯¹ç»“æ„ä¸­çš„slotsæ•°ç»„è¿›è¡Œä¿å­˜æˆ–æ›´æ–°.

å› ä¸ºé›†ç¾¤ä¸­çš„èŠ‚ç‚¹éƒ½ä¼šå°†è‡ªå·±çš„slotsæ•°ç»„é€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹,å¹¶ä¸”æ¯ä¸ªæ¥æ”¶åˆ°slotsæ•°ç»„çš„èŠ‚ç‚¹éƒ½ä¼šå°†æ•°ç»„ä¿å­˜åˆ°ç›¸åº”èŠ‚ç‚¹çš„clusterNodeç»“æ„ä¸­,å› æ­¤ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æ•°æ®åº“ä¸­çš„16384ä¸ªæ§½åˆ†åˆ«è¢«æŒ‡æ´¾ç»™äº†é›†ç¾¤ä¸­çš„å“ªäº›èŠ‚ç‚¹ã€‚

è®°å½•é›†ç¾¤æ‰€æœ‰æ§½çš„æŒ‡æ´¾ä¿¡æ¯

clusterStateç»“æ„ä¸­çš„slotsæ•°ç»„è®°å½•äº†é›†ç¾¤ä¸­æ‰€æœ‰16384ä¸ªæ§½çš„æŒ‡æ´¾ä¿¡æ¯ï¼š
```c
typedef struct clusterState {
    // ...
    clusterNode *slots[16384];
    // ...
} clusterState;
```
slots æ•° ç»„ åŒ… å« 16384 ä¸ª é¡¹ ï¼Œ æ¯ ä¸ª æ•° ç»„ é¡¹ éƒ½ æ˜¯ ä¸€ ä¸ª æŒ‡ å‘clusterNodeç»“æ„çš„æŒ‡é’ˆï¼š
- å¦‚æœslots[i]æŒ‡é’ˆæŒ‡å‘NULLï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½iå°šæœªæŒ‡æ´¾ç»™ä»»ä½•èŠ‚ç‚¹ã€‚
- å¦‚æœslots[i]æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªclusterNodeç»“æ„ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½iå·²ç»æŒ‡æ´¾ç»™äº†clusterNodeç»“æ„æ‰€ä»£è¡¨çš„èŠ‚ç‚¹

å¦‚æœåªå°†æ§½æŒ‡æ´¾ä¿¡æ¯ä¿å­˜åœ¨å„ä¸ªèŠ‚ç‚¹çš„clusterNode.slotsæ•°ç»„é‡Œï¼Œä¼šå‡ºç°ä¸€äº›æ— æ³•é«˜æ•ˆåœ°è§£å†³çš„é—®é¢˜ï¼Œè€ŒclusterState.slotsæ•°ç»„çš„å­˜åœ¨è§£å†³äº†è¿™äº›é—®é¢˜

å¦‚æœèŠ‚ç‚¹åªä½¿ç”¨clusterNode.slotsæ•°ç»„æ¥è®°å½•æ§½çš„æŒ‡æ´¾ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸ºäº†çŸ¥é“æ§½iæ˜¯å¦å·²ç»è¢«æŒ‡æ´¾ï¼Œæˆ–è€…æ§½iè¢«æŒ‡æ´¾ç»™äº†å“ªä¸ªèŠ‚ç‚¹ï¼Œç¨‹åºéœ€è¦éå†clusterState.nodeså­—å…¸ä¸­çš„æ‰€æœ‰clusterNodeç»“æ„ï¼Œæ£€æŸ¥è¿™äº›ç»“æ„çš„slotsæ•°ç»„ï¼Œç›´åˆ°æ‰¾åˆ°è´Ÿè´£å¤„ç†æ§½içš„èŠ‚ç‚¹ä¸ºæ­¢ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å¤ æ‚ åº¦ ä¸º O ï¼ˆ N ï¼‰ ï¼Œ å…¶ ä¸­ N ä¸º clusterState.nodes å­— å…¸ ä¿ å­˜ çš„clusterNodeç»“æ„çš„æ•°é‡ã€‚

è€Œé€šè¿‡å°†æ‰€æœ‰æ§½çš„æŒ‡æ´¾ä¿¡æ¯ä¿å­˜åœ¨clusterState.slotsæ•°ç»„é‡Œé¢ï¼Œç¨‹åºè¦æ£€æŸ¥æ§½iæ˜¯å¦å·²ç»è¢«æŒ‡æ´¾ï¼Œåˆæˆ–è€…å–å¾—è´Ÿè´£å¤„ç†æ§½içš„èŠ‚ç‚¹ï¼Œåªéœ€è¦è®¿é—®clusterState.slots[i]çš„å€¼å³å¯ï¼Œè¿™ä¸ªæ“ä½œçš„å¤æ‚åº¦ä»…ä¸ºOï¼ˆ1ï¼‰ã€‚

CLUSTER ADDSLOTSå‘½ä»¤çš„å®ç°

CLUSTER ADDSLOTSå‘½ä»¤æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªæ§½ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†æ‰€æœ‰è¾“å…¥çš„æ§½æŒ‡æ´¾ç»™æ¥æ”¶è¯¥å‘½ä»¤çš„èŠ‚ç‚¹è´Ÿè´£,è‹¥è¾“å…¥çš„æ§½æœ‰ä»»ä½•ä¸€ä¸ªæ§½æœ‰èŠ‚ç‚¹,é‚£ä¹ˆè¿”å›é”™è¯¯.

æœ€åï¼Œåœ¨CLUSTER ADDSLOTSå‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åï¼ŒèŠ‚ç‚¹ä¼šé€šè¿‡å‘é€æ¶ˆæ¯å‘ŠçŸ¥é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè‡ªå·±ç›®å‰æ­£åœ¨è´Ÿè´£å¤„ç†å“ªäº›æ§½ã€‚

#### åœ¨é›†ç¾¤ä¸­æ‰§è¡Œå‘½ä»¤

åœ¨å¯¹æ•°æ®åº“ä¸­çš„16384ä¸ªæ§½éƒ½è¿›è¡Œäº†æŒ‡æ´¾ä¹‹åï¼Œé›†ç¾¤å°±ä¼šè¿›å…¥ä¸Šçº¿çŠ¶æ€ï¼Œè¿™æ—¶å®¢æˆ·ç«¯å°±å¯ä»¥å‘é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å‘é€æ•°æ®å‘½ä»¤äº†ã€‚å½“å®¢æˆ·ç«¯å‘èŠ‚ç‚¹å‘é€ä¸æ•°æ®åº“é”®æœ‰å…³çš„å‘½ä»¤æ—¶ï¼Œæ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹ä¼šè®¡ç®—å‡ºå‘½ä»¤è¦å¤„ç†çš„æ•°æ®åº“é”®å±äºå“ªä¸ªæ§½ï¼Œå¹¶æ£€æŸ¥è¿™ä¸ªæ§½æ˜¯å¦æŒ‡æ´¾ç»™äº†è‡ªå·±ï¼š
- å¦‚æœé”®æ‰€åœ¨çš„æ§½æ­£å¥½å°±æŒ‡æ´¾ç»™äº†å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ç›´æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚
- å¦‚æœé”®æ‰€åœ¨çš„æ§½å¹¶æ²¡æœ‰æŒ‡æ´¾ç»™å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªMOVEDé”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘ï¼ˆredirectï¼‰è‡³æ­£ç¡®çš„èŠ‚ç‚¹ï¼Œå¹¶å†æ¬¡å‘é€ä¹‹å‰æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚

è®¡ç®—é”®å±äºå“ªä¸ªæ§½

èŠ‚ç‚¹ä½¿ç”¨ä»¥ä¸‹ç®—æ³•æ¥è®¡ç®—ç»™å®šé”®keyå±äºå“ªä¸ªæ§½ï¼š
```py
def slot_number(key):
return CRC16(key) & 16383
```
å…¶ä¸­CRC16ï¼ˆkeyï¼‰è¯­å¥ç”¨äºè®¡ç®—é”®keyçš„CRC-16æ ¡éªŒå’Œï¼Œè€Œ&16383è¯­å¥åˆ™ç”¨äºè®¡ç®—å‡ºä¸€ä¸ªä»‹äº0è‡³16383ä¹‹é—´çš„æ•´æ•°ä½œä¸ºé”®keyçš„æ§½å·ã€‚

ä½¿ç”¨`CLUSTER KEYSLOT <key>`å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç»™å®šé”®å±äºå“ªä¸ªæ§½ï¼š
```c
127.0.0.1:7000> CLUSTER KEYSLOT "date"
(integer) 2022
127.0.0.1:7000> CLUSTER KEYSLOT "msg"
(integer) 6257
```

åˆ¤æ–­æ§½æ˜¯å¦ç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£å¤„ç†

å½“èŠ‚ç‚¹è®¡ç®—å‡ºé”®æ‰€å±çš„æ§½iä¹‹åï¼ŒèŠ‚ç‚¹å°±ä¼šæ£€æŸ¥è‡ªå·±åœ¨clusterState.slotsæ•°ç»„ä¸­çš„é¡¹iï¼Œåˆ¤æ–­é”®æ‰€åœ¨çš„æ§½æ˜¯å¦ç”±è‡ªå·±è´Ÿè´£

MOVEDé”™è¯¯

å½“èŠ‚ç‚¹å‘ç°é”®æ‰€åœ¨çš„æ§½å¹¶éç”±è‡ªå·±è´Ÿè´£å¤„ç†çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹å°±ä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªMOVEDé”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘è‡³æ­£åœ¨è´Ÿè´£æ§½çš„èŠ‚ç‚¹ã€‚
```c
MOVED <slot> <ip>:<port>
```
ä¸€ä¸ªå®¢æˆ·ç«¯é€šå¸¸ä¼šä¸é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹å»ºç«‹socketè¿æ¥,è€Œæ‰€è°“çš„èŠ‚ç‚¹è½¬å‘å®é™…ä¸Šå°±æ˜¯æ¢ä¸€ä¸ªsocketæ¥å‘é€å‘½ä»¤

å¦‚æœå®¢æˆ·ç«¯è¿˜æ²¡æœ‰ä¸æƒ³è¦è½¬å‘çš„èŠ‚ç‚¹å»ºç«‹socketè¿æ¥,é‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå…ˆæ ¹æ®MOVEDé”™è¯¯æä¾›çš„IPåœ°å€å’Œç«¯å£å·æ¥å»ºç«‹è¿æ¥,å†è¿›è¡Œè½¬å‘.

é›†ç¾¤æ¨¡å¼çš„redis-cliå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°MOVEDé”™è¯¯æ—¶ï¼Œå¹¶ä¸ä¼šæ‰“å°å‡ºMOVEDé”™è¯¯ï¼Œè€Œæ˜¯æ ¹æ®MOVEDé”™è¯¯è‡ªåŠ¨è¿›è¡ŒèŠ‚ç‚¹è½¬å‘ï¼Œå¹¶æ‰“å°å‡ºè½¬å‘ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯çœ‹ä¸è§èŠ‚ç‚¹è¿”å›çš„MOVEDé”™è¯¯çš„.

#####  èŠ‚ç‚¹æ•°æ®åº“çš„å®ç°
é›†ç¾¤èŠ‚ç‚¹ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹çš„è¿‡æœŸæ–¹å¼ä¸Rediså•æœºä¿å­˜é”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼å®Œå…¨ç›¸åŒ.

ä¸åŒçš„æ˜¯,èŠ‚ç‚¹åªèƒ½ä½¿ç”¨0å·æ•°æ®åº“

å¦å¤–ï¼Œé™¤äº†å°†é”®å€¼å¯¹ä¿å­˜åœ¨æ•°æ®åº“é‡Œé¢ä¹‹å¤–ï¼ŒèŠ‚ç‚¹è¿˜ä¼šç”¨clusterStateç»“æ„ä¸­çš„slots_to_keysè·³è·ƒè¡¨æ¥ä¿å­˜æ§½å’Œé”®ä¹‹é—´çš„å…³ç³»

### é‡æ–°åˆ†ç‰‡

Redisé›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œå¯ä»¥å°†ä»»æ„æ•°é‡å·²ç»æŒ‡æ´¾ç»™æŸä¸ªèŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹,å¹¶ä¸”ç›¸å…³æ§½æ‰€å±çš„é”®å€¼å¯¹ä¹Ÿä¼šä»æºèŠ‚ç‚¹è¢«ç§»åŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹.

é‡æ–°åˆ†ç‰‡æ“ä½œå¯ä»¥åœ¨çº¿è¿›è¡Œ,åœ¨é‡æ–°åˆ†ç‰‡è¿‡ç¨‹ä¸­,é›†ç¾¤ä¸éœ€è¦ä¸‹çº¿,è€Œä¸”æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹éƒ½å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚.

é‡æ–°åˆ†ç‰‡çš„å®ç°åŸç†

Redisé›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œå…¶å®æ˜¯ç”±edisçš„é›†ç¾¤ç®¡ç†è½¯ä»¶redis-tribè´Ÿè´£æ‰§è¡Œçš„ï¼ŒRedisæä¾›äº†è¿›è¡Œé‡æ–°åˆ†ç‰‡æ‰€éœ€çš„æ‰€æœ‰å‘½ä»¤ï¼Œè€Œredis-tribåˆ™é€šè¿‡å‘æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹å‘é€å‘½ä»¤æ¥è¿›è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œã€‚

redis-tribå¯¹é›†ç¾¤çš„å•ä¸ªæ§½slotè¿›è¡Œé‡æ–°åˆ†ç‰‡çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. å¯¹ç›®æ ‡èŠ‚ç‚¹å‘é€`CLUSTER SETSLOT<slot>IMPORTING<source_id>å‘½ä»¤`è®©ç›®æ ‡èŠ‚ç‚¹å‡†å¤‡å¥½ä»æºèŠ‚ç‚¹å¯¼å…¥å±äºæ§½çš„é”®å€¼å¯¹
2. redis-trib å¯¹ æº èŠ‚ ç‚¹ å‘ é€ `CLUSTER SETSLOT<slot>MIGRATING<target_id>`å‘½ä»¤ï¼Œè®©æºèŠ‚ç‚¹å‡†å¤‡å¥½å°†å±äºæ§½slotçš„é”®å€¼å¯¹è¿ç§»ï¼ˆmigrateï¼‰è‡³ç›®æ ‡èŠ‚ç‚¹ã€‚
3. redis-tribå‘æºèŠ‚ç‚¹å‘é€`CLUSTER GETKEYSINSLOT<slot><count>`å‘½ä»¤ï¼Œè·å¾—æœ€å¤šcountä¸ªå±äºæ§½slotçš„é”®å€¼å¯¹çš„é”®åï¼ˆkey nameï¼‰ã€‚
4. å¯¹äºæ­¥éª¤3è·å¾—çš„æ¯ä¸ªé”®åï¼Œredis-tribéƒ½å‘æºèŠ‚ç‚¹å‘é€ä¸€ä¸ª`MIGRATE<target_ip><target_port><key_name>0<timeout>`å‘½ä»¤ï¼Œå°†è¢«é€‰ä¸­çš„é”®åŸå­åœ°ä»æºèŠ‚ç‚¹è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹ã€‚
5. é‡å¤3-4ç›´åˆ°æ‰€æœ‰çš„é”®å€¼å¯¹è¢«è¿ç§»å®Œæ¯•
6. redis-trib å‘ é›† ç¾¤ ä¸­ çš„ ä»» æ„ ä¸€ ä¸ª èŠ‚ ç‚¹ å‘ é€ `CLUSTERSETSLOT<slot>NODE<target_id>`å‘½ä»¤ï¼Œå°†æ§½slotæŒ‡æ´¾ç»™ç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™ä¸€æŒ‡æ´¾ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯å‘é€è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šçŸ¥æ§½slotå·²ç»æŒ‡æ´¾ç»™äº†ç›®æ ‡èŠ‚ç‚¹ã€‚

### ASKé”™è¯¯

åœ¨è¿›è¡Œé‡æ–°åˆ†ç‰‡æœŸé—´ï¼ŒæºèŠ‚ç‚¹å‘ç›®æ ‡èŠ‚ç‚¹è¿ç§»ä¸€ä¸ªæ§½çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼šå±äºè¢«è¿ç§»æ§½çš„ä¸€éƒ¨åˆ†é”®å€¼å¯¹ä¿å­˜åœ¨æºèŠ‚ç‚¹é‡Œé¢ï¼Œè€Œå¦ä¸€éƒ¨åˆ†é”®å€¼å¯¹åˆ™ä¿å­˜åœ¨ç›®æ ‡èŠ‚ç‚¹é‡Œé¢ã€‚

å½“å®¢æˆ·ç«¯å‘æºèŠ‚ç‚¹å‘é€ä¸€ä¸ªä¸æ•°æ®åº“é”®æœ‰å…³çš„å‘½ä»¤ï¼Œå¹¶ä¸”å‘½ä»¤è¦å¤„ç†çš„æ•°æ®åº“é”®æ°å¥½å°±å±äºæ­£åœ¨è¢«è¿ç§»çš„æ§½æ—¶, æºèŠ‚ç‚¹ä¼šä¼˜å…ˆä»è‡ªå·±çš„æ•°æ®åº“é‡ŒæŸ¥æ‰¾é”®,å¦‚æœæ‰¾åˆ°çš„è¯,ç›´æ¥æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤,ç›¸åå¦‚æœæºèŠ‚ç‚¹æ²¡èƒ½åœ¨è‡ªå·±çš„æ•°æ®åº“é‡Œæ‰¾åˆ°,å°±å¯èƒ½å·²ç»è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹,æºèŠ‚ç‚¹å°±å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªASKé”™è¯¯,æŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘æ­£åœ¨å¯¼å…¥æ§½çš„ç›®æ ‡èŠ‚ç‚¹,å¹¶ä¸”å†æ¬¡å‘é€ä¹‹å‰æƒ³è¦å‘é€çš„å‘½ä»¤

å’Œæ¥åˆ°MOVEDé”™è¯¯æ—¶çš„æƒ…å†µç±»ä¼¼ï¼Œé›†ç¾¤æ¨¡å¼çš„redis-cliåœ¨æ¥åˆ°ASKé”™è¯¯æ—¶ä¹Ÿä¸ä¼šæ‰“å°é”™è¯¯ï¼Œè€Œæ˜¯è‡ªåŠ¨æ ¹æ®é”™è¯¯æä¾›çš„IPåœ°å€å’Œç«¯å£è¿›è¡Œè½¬å‘åŠ¨ä½œã€‚å¦‚æœæƒ³çœ‹åˆ°èŠ‚ç‚¹å‘é€çš„ASKé”™è¯¯çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨å•æœºæ¨¡å¼çš„redis-cliå®¢æˆ·ç«¯


CLUSTER SETSLOT IMPORTINGå‘½ä»¤çš„å®ç°

clusterStateç»“æ„çš„importing_slots_fromæ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨ä»å…¶ä»–èŠ‚ç‚¹å¯¼å…¥çš„æ§½ï¼š

å¦‚ æœ importing_slots_from[i] çš„ å€¼ ä¸ ä¸º NULL ï¼Œ è€Œ æ˜¯ æŒ‡ å‘ ä¸€ ä¸ªclusterNodeç»“æ„ï¼Œé‚£ä¹ˆè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨ä»clusterNodeæ‰€ä»£è¡¨çš„èŠ‚ç‚¹å¯¼å…¥æ§½iã€‚

åœ¨å¯¹é›†ç¾¤è¿›è¡Œé‡æ–°åˆ†ç‰‡çš„æ—¶å€™ï¼Œå‘ç›®æ ‡èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼š
```
CLUSTER SETSLOT <i> IMPORTING <source_id>
```
å¯ä»¥å°†ç›®æ ‡èŠ‚ç‚¹clusterState.importing_slots_from[i]çš„å€¼è®¾ç½®ä¸ºsource_idæ‰€ä»£è¡¨èŠ‚ç‚¹çš„clusterNodeç»“æ„ã€‚

CLUSTER SETSLOT MIGRATINGå‘½ä»¤çš„å®ç°

clusterStateç»“æ„çš„migrating_slots_toæ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿ç§»è‡³å…¶ä»–èŠ‚ç‚¹çš„æ§½

å¦‚ æœ migrating_slots_to[i] çš„ å€¼ ä¸ ä¸º NULL ï¼Œ è€Œ æ˜¯ æŒ‡ å‘ ä¸€ ä¸ªclusterNodeç»“æ„ï¼Œé‚£ä¹ˆè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨å°†æ§½iè¿ç§»è‡³clusterNodeæ‰€ä»£è¡¨çš„èŠ‚ç‚¹ã€‚åœ¨å¯¹é›†ç¾¤è¿›è¡Œé‡æ–°åˆ†ç‰‡çš„æ—¶å€™ï¼Œå‘æºèŠ‚ç‚¹å‘é€å‘½ä»¤
```
CLUSTER SETSLOT <i> MIGRATING <target_id>
```

ASKé”™è¯¯

å¦‚æœèŠ‚ç‚¹æ”¶åˆ°ä¸€ä¸ªé”®keyçš„å‘½ä»¤è¯·æ±‚,å¹¶ä¸”é”®keyæ‰€å±çš„æ§½iæ­£å¥½æŒ‡æ´¾ç»™äº†å½“å‰èŠ‚ç‚¹,é‚£ä¹ˆå°±å°è¯•ä»èŠ‚ç‚¹è‡ªå·±çš„æ•°æ®åº“é‡ŒæŸ¥æ‰¾key,å¦‚æœæ‰¾åˆ°äº†èŠ‚ç‚¹å°±ç›´æ¥æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤.

ä¸æ­¤ç›¸åï¼Œå¦‚æœèŠ‚ç‚¹æ²¡æœ‰åœ¨è‡ªå·±çš„æ•°æ®åº“é‡Œæ‰¾åˆ°é”®keyï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šæ£€æŸ¥è‡ªå·±çš„clusterState.migrating_slots_to[i]ï¼Œçœ‹é”®keyæ‰€å±çš„æ§½iæ˜¯å¦æ­£åœ¨è¿›è¡Œè¿ç§»ï¼Œå¦‚æœæ§½içš„ç¡®åœ¨è¿›è¡Œè¿ç§»çš„è¯ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªASKé”™è¯¯ï¼Œå¼•å¯¼å®¢æˆ·ç«¯åˆ°æ­£åœ¨å¯¼å…¥æ§½içš„èŠ‚ç‚¹å»æŸ¥æ‰¾é”®keyã€‚

ASKINGå‘½ä»¤

åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘èŠ‚ç‚¹å‘é€ä¸€ä¸ªå…³äºæ§½içš„å‘½ä»¤ï¼Œè€Œæ§½iåˆæ²¡æœ‰æŒ‡æ´¾ç»™è¿™ä¸ªèŠ‚ç‚¹çš„è¯ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªMOVEDé”™è¯¯ï¼›ä½†æ˜¯ï¼Œå¦‚æœèŠ‚ç‚¹çš„clusterState.importing_slots_from[i]æ˜¾ç¤ºèŠ‚ç‚¹æ­£åœ¨å¯¼å…¥æ§½iï¼Œå¹¶ä¸”å‘é€å‘½ä»¤çš„å®¢æˆ·ç«¯å¸¦æœ‰REDIS_ASKINGæ ‡è¯†ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°†ç ´ä¾‹æ‰§è¡Œè¿™ä¸ªå…³äºæ§½içš„å‘½ä»¤ä¸€æ¬¡ã€‚

### å¤åˆ¶ä¸æ•…éšœè½¬ç§»
Redisé›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰å’Œä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹ç”¨äºå¤„ç†æ§½ï¼Œè€Œä»èŠ‚ç‚¹åˆ™ç”¨äºå¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹ï¼Œå¹¶åœ¨è¢«å¤åˆ¶çš„ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä»£æ›¿ä¸‹çº¿ä¸»èŠ‚ç‚¹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚

è¿™æ—¶å¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹ä¸‹çº¿,é‚£ä¹ˆé›†ç¾¤ä»åœ¨æ­£å¸¸å·¥ä½œçš„å‡ ä¸ªèŠ‚ç‚¹å°†ä»å…¶ä»èŠ‚ç‚¹ä¸­é€‰æ‹©é€‰ä¸¾å‡ºä¸€ä¸ªæ–°èŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹,è¿™ä¸ªæ–°èŠ‚ç‚¹å°†æ¥ç®¡åŸæ¥èŠ‚ç‚¹å¤„ç†çš„æ§½,å¹¶ç»§ç»­å¤„ç†å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚, å¹¶ä¸”åŸä¸»æœºçš„ä»ä¸»æœºä¹Ÿä¼šæ”¹ä¸ºå¤åˆ¶æ–°ä¸»æœº.

æ­¤æ—¶å¦‚æœåŸä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿,å®ƒä¹Ÿä¼šæˆä¸ºæ–°èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹.

è®¾ç½®ä»èŠ‚ç‚¹

å‘ä¸€ä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤ï¼š`CLUSTER REPLICATE <node_id>`

å¯ä»¥è®©æ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹æˆä¸ºnode_idæ‰€æŒ‡å®šèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶

æ¥æ”¶åˆ°è¯¥å‘½ä»¤çš„èŠ‚ç‚¹é¦–å…ˆä¼šåœ¨è‡ªå·±çš„clusterState.nodeså­—å…¸ä¸­æ‰¾åˆ°node_id æ‰€ å¯¹ åº” èŠ‚ ç‚¹ çš„ clusterNode ç»“ æ„ ï¼Œ å¹¶ å°† è‡ª å·± çš„clusterState.myself.slaveofæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªç»“æ„ï¼Œä»¥æ­¤æ¥è®°å½•è¿™ä¸ªèŠ‚ç‚¹æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹

ç„¶åèŠ‚ç‚¹ä¼šä¿®æ”¹è‡ªå·±åœ¨clusterState.myself.flagsä¸­çš„å±æ€§ï¼Œå…³é—­åŸæœ¬çš„REDIS_NODE_MASTERæ ‡è¯†ï¼Œæ‰“å¼€REDIS_NODE_SLAVEæ ‡è¯†ï¼Œè¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹å·²ç»ç”±åŸæ¥çš„ä¸»èŠ‚ç‚¹å˜æˆäº†ä»èŠ‚ç‚¹ã€‚

æœ€åèŠ‚ç‚¹ä¼šè°ƒç”¨å¤åˆ¶ä»£ç ,å¯¹æŒ‡å®šèŠ‚ç‚¹è¿›è¡Œå¤åˆ¶.

æ•…éšœæ£€æµ‹

é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¼šå®šæœŸå‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯,ç›‘æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿,å¦‚æœæ¥æ”¶PINGçš„èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…è¿”å›PONG,é‚£ä¹ˆå‘é€PINGæ¶ˆæ¯çš„èŠ‚ç‚¹å°±ä¼šå°†æ¥æ”¶PINGæ¶ˆæ¯çš„èŠ‚ç‚¹æ ‡è®°ä¸ºç–‘ä¼¼ä¸‹çº¿ï¼ˆprobablefailï¼ŒPFAILï¼‰.

é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹ä¼šé€šè¿‡ç›¸äº’å‘é€æ¶ˆæ¯æ¥äº¤æ¢é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„æ¶ˆæ¯,ä¾‹å¦‚æŸä¸ªèŠ‚ç‚¹æ˜¯å¦å¤„äºåœ¨çº¿çŠ¶æ€,ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€ï¼ˆPFAILï¼‰ï¼Œè¿˜æ˜¯å·²ä¸‹çº¿çŠ¶æ€ï¼ˆFAILï¼‰ã€‚

å½“ä¸€ä¸ªä¸»èŠ‚ç‚¹Aé€šè¿‡æ¶ˆæ¯å¾—çŸ¥ä¸»èŠ‚ç‚¹Bè®¤ä¸ºä¸»èŠ‚ç‚¹Cè¿›å…¥äº†ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¸»èŠ‚ç‚¹Aä¼šåœ¨è‡ªå·±çš„clusterState.nodeså­—å…¸ä¸­æ‰¾åˆ°ä¸»èŠ‚ç‚¹Cæ‰€å¯¹åº”çš„clusterNodeç»“æ„ï¼Œå¹¶å°†ä¸»èŠ‚ç‚¹Bçš„ä¸‹çº¿æŠ¥å‘Šï¼ˆfailurereportï¼‰æ·»åŠ åˆ°clusterNodeç»“æ„çš„fail_reportsé“¾è¡¨é‡Œé¢

å¦‚æœä¸€ä¸ªé›†ç¾¤ä¸­åŠæ•°ä»¥ä¸Šè´Ÿè´£æ§½çš„ä¸»èŠ‚ç‚¹éƒ½å°†èŠ‚ç‚¹xæŠ¥å‘Šä¸ºç–‘ä¼¼ä¸‹çº¿,é‚£ä¹ˆè¿™ä¸ªä¸»èŠ‚ç‚¹å°†xèŠ‚ç‚¹æ ‡è®°ä¸ºä¸‹çº¿,å¹¶ä¸”å°†xä¸‹çº¿çš„æ¶ˆæ¯å‘é›†ç¾¤å¹¿æ’­,æ‰€æœ‰æ”¶åˆ°è¿™æ¡FAILæ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šç«‹å³å°†ä¸»èŠ‚ç‚¹xæ ‡è®°ä¸ºå·²ä¸‹çº¿ã€‚

æ•…éšœè½¬ç§»

å½“ä¸€ä¸ªä»èŠ‚ç‚¹å‘ç°è‡ªå·±æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥äº†å·²ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä»èŠ‚ç‚¹å°†å¼€å§‹å¯¹ä¸‹çº¿ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œä»¥ä¸‹æ˜¯æ•…éšœè½¬ç§»çš„æ‰§è¡Œæ­¥éª¤

1ï¼‰å¤åˆ¶ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»èŠ‚ç‚¹é‡Œé¢ï¼Œä¼šæœ‰ä¸€ä¸ªä»èŠ‚ç‚¹è¢«é€‰ä¸­ã€‚ç‚¹ã€‚
3ï¼‰æ–°çš„ä¸»èŠ‚ç‚¹ä¼šæ’¤é”€æ‰€æœ‰å¯¹å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ï¼Œå¹¶å°†è¿™äº›æ§½å…¨éƒ¨æŒ‡æ´¾ç»™è‡ªå·±ã€‚
4ï¼‰æ–°çš„ä¸»èŠ‚ç‚¹å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡PONGæ¶ˆæ¯ï¼Œè¿™æ¡PONGæ¶ˆæ¯å¯ä»¥è®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ç«‹å³çŸ¥é“è¿™ä¸ªèŠ‚ç‚¹å·²ç»ç”±ä»èŠ‚ç‚¹å˜æˆäº†ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”è¿™ä¸ªä¸»èŠ‚ç‚¹å·²ç»æ¥ç®¡äº†åŸæœ¬ç”±å·²ä¸‹çº¿èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½ã€‚
5ï¼‰æ–°çš„ä¸»èŠ‚ç‚¹å¼€å§‹æ¥æ”¶å’Œè‡ªå·±è´Ÿè´£å¤„ç†çš„æ§½æœ‰å…³çš„å‘½ä»¤è¯·æ±‚ï¼Œæ•…éšœè½¬ç§»å®Œæˆã€‚

é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹

æ–°çš„ä¸»èŠ‚ç‚¹æ˜¯é€šè¿‡é€‰ä¸¾äº§ç”Ÿçš„ã€‚

1ï¼‰é›†ç¾¤çš„é…ç½®çºªå…ƒæ˜¯ä¸€ä¸ªè‡ªå¢è®¡æ•°å™¨ï¼Œå®ƒçš„åˆå§‹å€¼ä¸º0ã€‚
2ï¼‰å½“é›†ç¾¤é‡Œçš„æŸä¸ªèŠ‚ç‚¹å¼€å§‹ä¸€æ¬¡æ•…éšœè½¬ç§»æ“ä½œæ—¶ï¼Œé›†ç¾¤é…ç½®çºªå…ƒçš„å€¼ä¼šè¢«å¢ä¸€ã€‚
3ï¼‰å¯¹äºæ¯ä¸ªé…ç½®çºªå…ƒï¼Œé›†ç¾¤é‡Œæ¯ä¸ªè´Ÿè´£å¤„ç†æ§½çš„ä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€æ¬¡æŠ•ç¥¨çš„æœºä¼šï¼Œè€Œç¬¬ä¸€ä¸ªå‘ä¸»èŠ‚ç‚¹è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹å°†è·å¾—ä¸»èŠ‚ç‚¹çš„æŠ•ç¥¨ã€‚
4ï¼‰å½“ä»èŠ‚ç‚¹å‘ç°è‡ªå·±æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥å·²ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä»èŠ‚ç‚¹ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUESTæ¶ˆæ¯ï¼Œè¦æ±‚æ‰€æœ‰æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€å¹¶ä¸”å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹å‘è¿™ä¸ªä»èŠ‚ç‚¹æŠ•ç¥¨ã€‚
5ï¼‰å¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹å…·æœ‰æŠ•ç¥¨æƒï¼ˆå®ƒæ­£åœ¨è´Ÿè´£å¤„ç†æ§½ï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªä¸»èŠ‚ç‚¹å°šæœªæŠ•ç¥¨ç»™å…¶ä»–ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å°†å‘è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹è¿”å›ä¸€æ¡CLUSTERMSG_TYPE_FAILOVER_AUTH_ACKæ¶ˆæ¯ï¼Œè¡¨ç¤ºè¿™ä¸ªä¸»èŠ‚ç‚¹æ”¯æŒä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚
6 ï¼‰ æ¯ ä¸ª å‚ ä¸ é€‰ ä¸¾ çš„ ä» èŠ‚ ç‚¹ éƒ½ ä¼š æ¥ æ”¶CLUSTERMSG_TYPE_FAILOVER_AUTH_ACKæ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è‡ªå·±æ”¶åˆ°äº†å¤šå°‘æ¡è¿™ç§æ¶ˆæ¯æ¥ç»Ÿè®¡è‡ªå·±è·å¾—äº†å¤šå°‘ä¸»èŠ‚ç‚¹çš„æ”¯æŒã€‚
7ï¼‰å¦‚æœé›†ç¾¤é‡Œæœ‰Nä¸ªå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªä»èŠ‚ç‚¹æ”¶é›†åˆ°å¤§äºç­‰äºN/2+1å¼ æ”¯æŒç¥¨æ—¶ï¼Œè¿™ä¸ªä»èŠ‚ç‚¹å°±ä¼šå½“é€‰ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚
8ï¼‰å› ä¸ºåœ¨æ¯ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œé¢ï¼Œæ¯ä¸ªå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹åªèƒ½æŠ•ä¸€æ¬¡ç¥¨ï¼Œæ‰€ä»¥å¦‚æœæœ‰Nä¸ªä¸»èŠ‚ç‚¹è¿›è¡ŒæŠ•ç¥¨ï¼Œé‚£ä¹ˆå…·æœ‰å¤§äºç­‰äºN/2+1å¼ æ”¯æŒç¥¨çš„ä»èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ªï¼Œè¿™ç¡®ä¿äº†æ–°çš„ä¸»èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ªã€‚
9ï¼‰å¦‚æœåœ¨ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œé¢æ²¡æœ‰ä»èŠ‚ç‚¹èƒ½æ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„æ”¯æŒç¥¨ï¼Œé‚£ä¹ˆé›†ç¾¤è¿›å…¥ä¸€ä¸ªæ–°çš„é…ç½®çºªå…ƒï¼Œå¹¶å†æ¬¡è¿›è¡Œé€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ä¸ºæ­¢ã€‚è¿™ä¸ªé€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹çš„æ–¹æ³•å’Œç¬¬16ç« ä»‹ç»çš„é€‰ä¸¾é¢†å¤´Sentinelçš„æ–¹æ³•éå¸¸ç›¸ ä¼¼ï¼Œå› ä¸ºä¸¤è€…éƒ½æ˜¯åŸºäºRaftç®—æ³•çš„é¢†å¤´é€‰ä¸¾leade relectionï¼‰æ–¹æ³•æ¥å®ç°çš„ã€‚

### æ¶ˆæ¯

é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆmessageï¼‰æ¥è¿›è¡Œé€šä¿¡ï¼Œæˆ‘ä»¬ç§°å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ä¸ºå‘é€è€…ï¼ˆsenderï¼‰ï¼Œæ¥æ”¶æ¶ˆæ¯çš„èŠ‚ç‚¹ä¸ºæ¥æ”¶è€…ï¼ˆreceiverï¼‰

èŠ‚ç‚¹å‘é€çš„æ¶ˆæ¯ä¸»è¦æœ‰ä»¥ä¸‹äº”ç§ï¼š

- MEETæ¶ˆæ¯ï¼šå½“å‘é€è€…æ¥åˆ°å®¢æˆ·ç«¯å‘é€çš„CLUSTER MEETå‘½ä»¤æ—¶ï¼Œå‘é€è€…ä¼šå‘æ¥æ”¶è€…å‘é€MEETæ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶è€…åŠ å…¥åˆ°å‘é€è€…å½“å‰æ‰€å¤„çš„é›†ç¾¤é‡Œé¢ã€‚
- PINGæ¶ˆæ¯ï¼šé›†ç¾¤é‡Œçš„æ¯ä¸ªèŠ‚ç‚¹é»˜è®¤æ¯éš”ä¸€ç§’é’Ÿå°±ä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­éšæœºé€‰å‡ºäº”ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå¯¹è¿™äº”ä¸ªèŠ‚ç‚¹ä¸­æœ€é•¿æ—¶é—´æ²¡æœ‰å‘é€è¿‡PINGæ¶ˆæ¯çš„èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯ï¼Œä»¥æ­¤æ¥æ£€æµ‹è¢«é€‰ä¸­çš„èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ã€‚
- PONGæ¶ˆæ¯ï¼šå½“æ¥æ”¶è€…æ”¶åˆ°å‘é€è€…å‘æ¥çš„MEETæ¶ˆæ¯æˆ–è€…PINGæ¶ˆæ¯æ—¶ï¼Œä¸ºäº†å‘å‘é€è€…ç¡®è®¤è¿™æ¡MEETæ¶ˆæ¯æˆ–è€…PINGæ¶ˆæ¯å·²åˆ°è¾¾ï¼Œæ¥æ”¶è€…ä¼šå‘å‘é€è€…è¿”å›ä¸€æ¡PONGæ¶ˆæ¯ã€‚
- FAILæ¶ˆæ¯ï¼šå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹Aåˆ¤æ–­å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹Bå·²ç»è¿›å…¥FAILçŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹Aä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡å…³äºèŠ‚ç‚¹Bçš„FAILæ¶ˆæ¯ï¼Œæ‰€æœ‰æ”¶åˆ°è¿™æ¡æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šç«‹å³å°†èŠ‚ç‚¹Bæ ‡è®°ä¸ºå·²ä¸‹çº¿ã€‚
- PUBLISHæ¶ˆæ¯ï¼šå½“èŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ªPUBLISHå‘½ä»¤æ—¶ï¼ŒèŠ‚ç‚¹ä¼šæ‰§è¡Œè¿™ ä¸ª å‘½ ä»¤ ï¼Œ å¹¶ å‘ é›† ç¾¤ å¹¿ æ’­ ä¸€ æ¡ PUBLISH æ¶ˆ æ¯ ï¼Œ æ‰€ æœ‰ æ¥ æ”¶ åˆ° è¿™ æ¡PUBLISHæ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œç›¸åŒçš„PUBLISHå‘½ä»¤ã€‚

ä¸€æ¡æ¶ˆæ¯ç”±æ¶ˆæ¯å¤´ï¼ˆheaderï¼‰å’Œæ¶ˆæ¯æ­£æ–‡ï¼ˆdataï¼‰ç»„æˆï¼Œæ¥ä¸‹æ¥çš„å†…å®¹å°†é¦–å…ˆä»‹ç»æ¶ˆæ¯å¤´ï¼Œç„¶åå†åˆ†åˆ«ä»‹ç»ä¸Šé¢æåˆ°çš„äº”ç§ä¸åŒç±»å‹çš„æ¶ˆæ¯æ­£æ–‡ã€‚

#### æ¶ˆæ¯å¤´
èŠ‚ç‚¹å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ç”±ä¸€ä¸ªæ¶ˆæ¯å¤´åŒ…è£¹ï¼Œæ¶ˆæ¯å¤´é™¤äº†åŒ…å«æ¶ˆæ¯æ­£æ–‡ä¹‹å¤–ï¼Œè¿˜è®°å½•äº†æ¶ˆæ¯å‘é€è€…è‡ªèº«çš„ä¸€äº›ä¿¡æ¯ï¼Œå› ä¸ºè¿™äº›ä¿¡æ¯ä¹Ÿä¼šè¢«æ¶ˆæ¯æ¥æ”¶è€…ç”¨åˆ°ï¼Œæ‰€ä»¥ä¸¥æ ¼æ¥è®²ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ¶ˆæ¯å¤´æœ¬èº«ä¹Ÿæ˜¯æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ã€‚

```c
typedef struct {
    //æ¶ˆæ¯çš„é•¿åº¦ï¼ˆåŒ…æ‹¬è¿™ä¸ªæ¶ˆæ¯å¤´çš„é•¿åº¦å’Œæ¶ˆæ¯æ­£æ–‡çš„é•¿åº¦ï¼‰
    uint32_t totlen;
    //æ¶ˆæ¯çš„ç±»å‹
    uint16_t type;
    //æ¶ˆæ¯æ­£æ–‡åŒ…å«çš„èŠ‚ç‚¹ä¿¡æ¯æ•°é‡
    //åªåœ¨å‘é€MEET PING PONG è¿™ä¸‰ç§Gossip åè®®æ¶ˆæ¯æ—¶ä½¿ç”¨
    uint16_t count;
    //å‘é€è€…æ‰€å¤„çš„é…ç½®çºªå…ƒ
    uint64_t currentEpoch;
    //å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…çš„é…ç½®çºªå…ƒ
    // å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„é…ç½®çºªå…ƒ
    uint64_t configEpoch;
    //å‘é€è€…çš„åå­—ï¼ˆIDï¼‰
    char sender[REDIS_CLUSTER_NAMELEN];
    //å‘é€è€…ç›®å‰çš„æ§½æŒ‡æ´¾ä¿¡æ¯
    unsigned char myslots[REDIS_CLUSTER_SLOTS/8];
    //å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„åå­—
    //å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯REDIS_NODE_NULL_NAME
    //ï¼ˆä¸€ä¸ª40å­—èŠ‚é•¿ï¼Œå€¼å…¨ä¸º0çš„å­—èŠ‚æ•°ç»„ï¼‰
    char slaveof[REDIS_CLUSTER_NAMELEN];
    //å‘é€è€…çš„ç«¯å£å·
    uint16_t port;
    //å‘é€è€…çš„æ ‡è¯†å€¼
    uint16_t flags;
    //å‘é€è€…æ‰€å¤„é›†ç¾¤çš„çŠ¶æ€
    unsigned char state;
    //æ¶ˆæ¯çš„æ­£æ–‡ï¼ˆæˆ–è€…è¯´ï¼Œå†…å®¹ï¼‰
    union clusterMsgData data;
} clusterMsg;
```
clusterMsg.dataå±æ€§æŒ‡å‘è”åˆcluster.h/clusterMsgDataï¼Œè¿™ä¸ªè”åˆå°±æ˜¯æ¶ˆæ¯çš„æ­£æ–‡ï¼š
```c
union clusterMsgData {
    // MEETã€PINGã€PONGæ¶ˆæ¯çš„æ­£æ–‡
    struct {
        //æ¯æ¡MEETã€PINGã€PONGæ¶ˆæ¯éƒ½åŒ…å«ä¸¤ä¸ª
        // clusterMsgDataGossipç»“æ„
        clusterMsgDataGossip gossip[1];
    } ping;
    // FAILæ¶ˆæ¯çš„æ­£æ–‡
    struct {
        clusterMsgDataFail about;
    } fail;
    // PUBLISHæ¶ˆæ¯çš„æ­£æ–‡
    struct {
        clusterMsgDataPublish msg;
    } publish;
    //å…¶ä»–æ¶ˆæ¯çš„æ­£æ–‡...
};
```

MEETã€PINGã€PONGæ¶ˆæ¯çš„å®ç°

Redisé›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡Gossipåè®®æ¥äº¤æ¢å„è‡ªå…³äºä¸åŒèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­Gossipåè®®ç”±MEETã€PINGã€PONGä¸‰ç§æ¶ˆæ¯å®ç°ï¼Œè¿™ä¸‰ç§æ¶ˆæ¯çš„æ­£æ–‡éƒ½ç”±ä¸¤ä¸ªcluster.h/clusterMsgDataGossipç»“æ„ç»„æˆï¼š
```c
union clusterMsgData {
// ...
// MEETã€PINGå’ŒPONGæ¶ˆæ¯çš„æ­£æ–‡
struct {
//æ¯æ¡MEETã€PINGã€PONGæ¶ˆæ¯éƒ½åŒ…å«ä¸¤ä¸ª
// clusterMsgDataGossipç»“æ„
clusterMsgDataGossip gossip[1];
} ping;
//å…¶ä»–æ¶ˆæ¯çš„æ­£æ–‡...
};
```
å½“æ¥æ”¶è€…æ”¶åˆ°MEETã€PINGã€PONGæ¶ˆæ¯æ—¶ï¼Œæ¥æ”¶è€…ä¼šè®¿é—®æ¶ˆæ¯æ­£æ–‡ä¸­çš„ä¸¤ä¸ªclusterMsgDataGossipç»“æ„ï¼Œå¹¶æ ¹æ®è‡ªå·±æ˜¯å¦è®¤è¯†clusterMsgDataGossipç»“æ„ä¸­è®°å½•çš„è¢«é€‰ä¸­èŠ‚ç‚¹æ¥é€‰æ‹©è¿›è¡Œå“ªç§æ“ä½œï¼š
- å¦‚æœè¢«é€‰ä¸­èŠ‚ç‚¹ä¸å­˜åœ¨äºæ¥æ”¶è€…çš„å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ï¼Œé‚£ä¹ˆè¯´æ˜æ¥æ”¶è€…æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°è¢«é€‰ä¸­èŠ‚ç‚¹ï¼Œæ¥æ”¶è€…å°†æ ¹æ®ç»“æ„ä¸­è®°å½•çš„IPåœ°å€å’Œç«¯å£å·ç­‰ä¿¡æ¯ï¼Œä¸è¢«é€‰ä¸­èŠ‚ç‚¹è¿›è¡Œæ¡æ‰‹ã€‚
- å¦‚æœè¢«é€‰ä¸­èŠ‚ç‚¹å·²ç»å­˜åœ¨äºæ¥æ”¶è€…çš„å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ï¼Œé‚£ä¹ˆè¯´æ˜æ¥æ”¶è€…ä¹‹å‰å·²ç»ä¸è¢«é€‰ä¸­èŠ‚ç‚¹è¿›è¡Œè¿‡æ¥è§¦ï¼Œæ¥æ”¶è€…å°†æ ¹æ®clusterMsgDataGossipç»“æ„è®°å½•çš„ä¿¡æ¯ï¼Œå¯¹è¢«é€‰ä¸­èŠ‚ç‚¹æ‰€å¯¹åº”çš„clusterNodeç»“æ„è¿›è¡Œæ›´æ–°ã€‚

ä¸¾ä¸ªå‘é€PINGæ¶ˆæ¯å’Œè¿”å›PONGæ¶ˆæ¯çš„ä¾‹å­ï¼Œå‡è®¾åœ¨ä¸€ä¸ªåŒ…å«Aã€Bã€Cã€Dã€Eã€Få…­ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤é‡Œï¼š
Â·èŠ‚ç‚¹Aå‘èŠ‚ç‚¹Då‘é€PINGæ¶ˆæ¯ï¼Œå¹¶ä¸”æ¶ˆæ¯é‡Œé¢åŒ…å«äº†èŠ‚ç‚¹Bå’ŒèŠ‚ç‚¹Cçš„ä¿¡æ¯ï¼Œå½“èŠ‚ç‚¹Dæ”¶åˆ°è¿™æ¡PINGæ¶ˆæ¯æ—¶ï¼Œå®ƒå°†æ›´æ–°è‡ªå·±å¯¹èŠ‚ç‚¹Bå’ŒèŠ‚ç‚¹Cçš„è®¤è¯†ã€‚
Â·ä¹‹åï¼ŒèŠ‚ç‚¹Då°†å‘èŠ‚ç‚¹Aè¿”å›ä¸€æ¡PONGæ¶ˆæ¯ï¼Œå¹¶ä¸”æ¶ˆæ¯é‡Œé¢åŒ…å«äº†èŠ‚ç‚¹Eå’ŒèŠ‚ç‚¹Fçš„æ¶ˆæ¯ï¼Œå½“èŠ‚ç‚¹Aæ”¶åˆ°è¿™æ¡PONGæ¶ˆæ¯æ—¶ï¼Œå®ƒå°†æ›´æ–°è‡ªå·±å¯¹èŠ‚ç‚¹Eå’ŒèŠ‚ç‚¹Fçš„è®¤è¯†ã€‚

FAILæ¶ˆæ¯çš„å®ç°

å½“é›†ç¾¤é‡Œçš„ä¸»èŠ‚ç‚¹Aå°†ä¸»èŠ‚ç‚¹Bæ ‡è®°ä¸ºå·²ä¸‹çº¿ï¼ˆFAILï¼‰æ—¶ï¼Œä¸»èŠ‚ç‚¹Aå°†å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡å…³äºä¸»èŠ‚ç‚¹Bçš„FAILæ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡FAILæ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°†ä¸»èŠ‚ç‚¹Bæ ‡è®°ä¸ºå·²ä¸‹çº¿ã€‚

åœ¨é›†ç¾¤çš„èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå•çº¯ä½¿ç”¨Gossipåè®®æ¥ä¼ æ’­èŠ‚ç‚¹çš„å·²ä¸‹çº¿ä¿¡æ¯ä¼šç»™èŠ‚ç‚¹çš„ä¿¡æ¯æ›´æ–°å¸¦æ¥ä¸€å®šå»¶è¿Ÿï¼Œå› ä¸ºGossipåè®®æ¶ˆæ¯é€šå¸¸éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œè€Œå‘é€FAILæ¶ˆæ¯å¯ä»¥è®©é›†ç¾¤é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ç«‹å³çŸ¥é“æŸä¸ªä¸»èŠ‚ç‚¹å·²ä¸‹çº¿ï¼Œä»è€Œå°½å¿«åˆ¤æ–­æ˜¯å¦éœ€è¦å°†é›†ç¾¤æ ‡è®°ä¸ºä¸‹çº¿ï¼Œåˆæˆ–è€…å¯¹ä¸‹çº¿ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ã€‚

FAILæ¶ˆæ¯çš„æ­£æ–‡ç”±cluster.h/clusterMsgDataFailç»“æ„è¡¨ç¤ºï¼Œè¿™ä¸ªç»“æ„åªåŒ…å«ä¸€ä¸ªnodenameå±æ€§ï¼Œè¯¥å±æ€§è®°å½•äº†å·²ä¸‹çº¿èŠ‚ç‚¹çš„åå­—ï¼š
```c
typedef struct {
    char nodename[REDIS_CLUSTER_NAMELEN];
} clusterMsgDataFail;
```
å› ä¸ºé›†ç¾¤é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„åå­—ï¼Œæ‰€ä»¥FAILæ¶ˆæ¯é‡Œé¢åªéœ€è¦ä¿å­˜ä¸‹çº¿èŠ‚ç‚¹çš„åå­—ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯çš„èŠ‚ç‚¹å°±å¯ä»¥æ ¹æ®è¿™ä¸ªåå­—æ¥åˆ¤æ–­æ˜¯å“ªä¸ªèŠ‚ç‚¹ä¸‹çº¿äº†ã€‚

PUBLISHæ¶ˆæ¯çš„å®ç°

å½“å®¢æˆ·ç«¯å‘é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤ï¼š
```c
PUBLISH <channel> <message>
```
çš„æ—¶å€™,æ¥æ”¶åˆ°PUBLISHå‘½ä»¤çš„èŠ‚ç‚¹ä¸ä»…ä¼šå‘channelé¢‘é“å‘é€æ¶ˆæ¯messageï¼Œå®ƒè¿˜ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡PUBLISHæ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡PUBLISHæ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå‘channelé¢‘é“å‘é€messageæ¶ˆæ¯, å°†å¯¼è‡´é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å‘channelé¢‘é“å‘é€messageæ¶ˆæ¯ã€‚

PUBLISHæ¶ˆæ¯çš„æ­£æ–‡ç”±cluster.h/clusterMsgDataPublishç»“æ„è¡¨ç¤ºï¼š
```c
typedef struct {
    uint32_t channel_len;
    uint32_t message_len;
    //å®šä¹‰ä¸º8å­—èŠ‚åªæ˜¯ä¸ºäº†å¯¹é½å…¶ä»–æ¶ˆæ¯ç»“æ„
    //å®é™…çš„é•¿åº¦ç”±ä¿å­˜çš„å†…å®¹å†³å®š
    unsigned char bulk_data[8];
} clusterMsgDataPublish;
```

clusterMsgDataPublish ç»“ æ„ çš„ bulk_data å± æ€§ æ˜¯ ä¸€ ä¸ª å­— èŠ‚ æ•°ç»„ ï¼Œ è¿™ ä¸ª å­— èŠ‚ æ•° ç»„ ä¿ å­˜ äº† å®¢ æˆ· ç«¯ é€š è¿‡ PUBLISH å‘½ ä»¤ å‘ é€ ç»™ èŠ‚ ç‚¹ çš„channel å‚ æ•° å’Œ message å‚ æ•° ï¼Œ è€Œç»“ æ„ çš„ channel_len å’Œmessage_lenåˆ™åˆ†åˆ«ä¿å­˜äº†channelå‚æ•°çš„é•¿åº¦å’Œmessageå‚æ•°çš„é•¿åº¦


### Redisåˆ†å¸ƒå¼é”é—®é¢˜
Redisæ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼é”çš„?

Redisæœ¬èº«å¯ä»¥è¢«å¤šä¸ªå®¢æˆ·ç«¯è®¿é—®,æ‰€ä»¥æ°å¥½æ˜¯ä¸€ä¸ªå…±äº«å­˜å‚¨ç³»ç»Ÿ,å¯ä»¥æ¥ä¿å­˜åˆ†å¸ƒå¼é”,è€Œä¸”redisçš„è¯»å†™æ€§èƒ½å¾ˆé«˜,è¶³å¤Ÿåº”ä»˜é«˜å¹¶å‘åœºæ™¯äº†.

Redisçš„SETå‘½ä»¤æœ‰ä¸ªNXå‚æ•°å¯ä»¥å®ç°åœ¨keyä¸å­˜åœ¨æ—¶æ’å…¥,æ‰€ä»¥å¯ä»¥ç”¨å®ƒå®ç°åˆ†å¸ƒå¼é”:
1. keyä¸å­˜åœ¨,åˆ™ç›´æ¥æ’å…¥æˆåŠŸ
2. keyå­˜åœ¨åˆ™æ’å…¥å¤±è´¥

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘½ä»¤æ˜¯è¿™æ ·çš„
```
SETÂ lock_keyÂ unique_valueÂ NXÂ 
expire lock_key px 10000

SETÂ lock_keyÂ unique_valueÂ NXÂ PXÂ 10000
```
é€‰æ‹©ä¸‹é¢ä¸€ç§,å› ä¸ºå¯èƒ½åˆšè®¾ç½®äº†é”,ç¬¬äºŒæ­¥çš„expireè®¾ç½®è¿‡æœŸæ—¶é—´å°±å¤±è´¥äº†,æ‰€ä»¥å¿…é¡»åˆå¹¶åˆ°ä¸€æ­¥,é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼
- lock_key å°±æ˜¯ key é”®ï¼›
- unique_value æ˜¯å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€çš„æ ‡è¯†ï¼ŒåŒºåˆ†æ¥è‡ªä¸åŒå®¢æˆ·ç«¯çš„é”æ“ä½œï¼›
- NX ä»£è¡¨åªåœ¨ lock_key ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹ lock_key è¿›è¡Œè®¾ç½®æ“ä½œï¼›
- PX 10000 è¡¨ç¤ºè®¾ç½® lock_key çš„è¿‡æœŸæ—¶é—´ä¸º 10sï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”ã€‚

é‚£ä¹ˆè§£é”å‘¢?è§£é”éœ€è¦1. ä¿è¯è§£é”çš„å®¢æˆ·ç«¯æ˜¯æŒæœ‰é”çš„å®¢æˆ·ç«¯ 2. åˆ é™¤é”
æ‰€ä»¥éœ€è¦LUAè„šæœ¬æ”¯æŒ

```lua
// é‡Šæ”¾é”æ—¶ï¼Œå…ˆæ¯”è¾ƒÂ unique_valueÂ æ˜¯å¦ç›¸ç­‰ï¼Œé¿å…é”çš„è¯¯é‡Šæ”¾
ifÂ redis.call("get",KEYS[1])Â ==Â ARGV[1]Â then
Â Â Â Â returnÂ redis.call("del",KEYS[1])
else
Â Â Â Â returnÂ 0
end
```

åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ
åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”çš„ä¼˜ç‚¹ï¼š

    æ€§èƒ½é«˜æ•ˆï¼ˆè¿™æ˜¯é€‰æ‹©ç¼“å­˜å®ç°åˆ†å¸ƒå¼é”æœ€æ ¸å¿ƒçš„å‡ºå‘ç‚¹ï¼‰ã€‚
    å®ç°æ–¹ä¾¿ã€‚å¾ˆå¤šç ”å‘å·¥ç¨‹å¸ˆé€‰æ‹©ä½¿ç”¨ Redis æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œå¾ˆå¤§æˆåˆ†ä¸Šæ˜¯å› ä¸º Redis æä¾›äº† setnx æ–¹æ³•ï¼Œå®ç°åˆ†å¸ƒå¼é”å¾ˆæ–¹ä¾¿ã€‚
    é¿å…å•ç‚¹æ•…éšœï¼ˆå› ä¸º Redis æ˜¯è·¨é›†ç¾¤éƒ¨ç½²çš„ï¼Œè‡ªç„¶å°±é¿å…äº†å•ç‚¹æ•…éšœï¼‰ã€‚

åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”çš„ç¼ºç‚¹ï¼š

    è¶…æ—¶æ—¶é—´ä¸å¥½è®¾ç½®ã€‚å¦‚æœé”çš„è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡é•¿ï¼Œä¼šå½±å“æ€§èƒ½ï¼Œå¦‚æœè®¾ç½®çš„è¶…æ—¶æ—¶é—´è¿‡çŸ­ä¼šä¿æŠ¤ä¸åˆ°å…±äº«èµ„æºã€‚æ¯”å¦‚åœ¨æœ‰äº›åœºæ™¯ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹ A è·å–åˆ°äº†é”ä¹‹åï¼Œç”±äºä¸šåŠ¡ä»£ç æ‰§è¡Œæ—¶é—´å¯èƒ½æ¯”è¾ƒé•¿ï¼Œå¯¼è‡´è¶…è¿‡äº†é”çš„è¶…æ—¶æ—¶é—´ï¼Œè‡ªåŠ¨å¤±æ•ˆï¼Œæ³¨æ„ A çº¿ç¨‹æ²¡æ‰§è¡Œå®Œï¼Œåç»­çº¿ç¨‹ B åˆæ„å¤–çš„æŒæœ‰äº†é”ï¼Œæ„å‘³ç€å¯ä»¥æ“ä½œå…±äº«èµ„æºï¼Œé‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„å…±äº«èµ„æºå°±æ²¡åŠæ³•è¿›è¡Œä¿æŠ¤äº†ã€‚
        é‚£ä¹ˆå¦‚ä½•åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥åŸºäºç»­çº¦çš„æ–¹å¼è®¾ç½®è¶…æ—¶æ—¶é—´ï¼šå…ˆç»™é”è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œè®©å®ˆæŠ¤çº¿ç¨‹åœ¨ä¸€æ®µæ—¶é—´åï¼Œé‡æ–°è®¾ç½®è¿™ä¸ªé”çš„è¶…æ—¶æ—¶é—´ã€‚å®ç°æ–¹å¼å°±æ˜¯ï¼šå†™ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œç„¶åå»åˆ¤æ–­é”çš„æƒ…å†µï¼Œå½“é”å¿«å¤±æ•ˆçš„æ—¶å€™ï¼Œå†æ¬¡è¿›è¡Œç»­çº¦åŠ é”ï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œé”€æ¯ç»­çº¦é”å³å¯ï¼Œä¸è¿‡è¿™ç§æ–¹å¼å®ç°èµ·æ¥ç›¸å¯¹å¤æ‚ã€‚

    Redis ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸­çš„æ•°æ®æ˜¯å¼‚æ­¥å¤åˆ¶çš„ï¼Œè¿™æ ·å¯¼è‡´åˆ†å¸ƒå¼é”çš„ä¸å¯é æ€§ã€‚å¦‚æœåœ¨ Redis ä¸»èŠ‚ç‚¹è·å–åˆ°é”åï¼Œåœ¨æ²¡æœ‰åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹æ—¶ï¼ŒRedis ä¸»èŠ‚ç‚¹å®•æœºäº†ï¼Œæ­¤æ—¶æ–°çš„ Redis ä¸»èŠ‚ç‚¹ä¾ç„¶å¯ä»¥è·å–é”ï¼Œæ‰€ä»¥å¤šä¸ªåº”ç”¨æœåŠ¡å°±å¯ä»¥åŒæ—¶è·å–åˆ°é”ã€‚

#### Redis å¦‚ä½•è§£å†³é›†ç¾¤æƒ…å†µä¸‹åˆ†å¸ƒå¼é”çš„å¯é æ€§ï¼Ÿ

Redis å®˜æ–¹å·²ç»è®¾è®¡äº†ä¸€ä¸ªåˆ†å¸ƒå¼é”ç®—æ³• Redlockï¼ˆçº¢é”ï¼‰ã€‚

å®ƒæ˜¯åŸºäºå¤šä¸ª Redis èŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”ï¼Œå³ä½¿æœ‰èŠ‚ç‚¹å‘ç”Ÿäº†æ•…éšœï¼Œé”å˜é‡ä»ç„¶æ˜¯å­˜åœ¨çš„ï¼Œå®¢æˆ·ç«¯è¿˜æ˜¯å¯ä»¥å®Œæˆé”æ“ä½œã€‚

Redlock ç®—æ³•çš„åŸºæœ¬æ€è·¯ï¼Œæ˜¯è®©å®¢æˆ·ç«¯å’Œå¤šä¸ªç‹¬ç«‹çš„ Redis èŠ‚ç‚¹ä¾æ¬¡è¯·æ±‚ç”³è¯·åŠ é”ï¼Œå¦‚æœå®¢æˆ·ç«¯èƒ½å¤Ÿå’ŒåŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æˆåŠŸåœ°å®ŒæˆåŠ é”æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºï¼Œå®¢æˆ·ç«¯æˆåŠŸåœ°è·å¾—åˆ†å¸ƒå¼é”ï¼Œå¦åˆ™åŠ é”å¤±è´¥ã€‚

Redlock ç®—æ³•åŠ é”ä¸‰ä¸ªè¿‡ç¨‹ï¼š

    ç¬¬ä¸€æ­¥æ˜¯ï¼Œå®¢æˆ·ç«¯è·å–å½“å‰æ—¶é—´ã€‚

    ç¬¬äºŒæ­¥æ˜¯ï¼Œå®¢æˆ·ç«¯æŒ‰é¡ºåºä¾æ¬¡å‘ N ä¸ª Redis èŠ‚ç‚¹æ‰§è¡ŒåŠ é”æ“ä½œï¼š
        åŠ é”æ“ä½œä½¿ç”¨ SET å‘½ä»¤ï¼Œå¸¦ä¸Š NXï¼ŒEX/PX é€‰é¡¹ï¼Œä»¥åŠå¸¦ä¸Šå®¢æˆ·ç«¯çš„å”¯ä¸€æ ‡è¯†ã€‚
        å¦‚æœæŸä¸ª Redis èŠ‚ç‚¹å‘ç”Ÿæ•…éšœäº†ï¼Œä¸ºäº†ä¿è¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒRedlock ç®—æ³•èƒ½å¤Ÿç»§ç»­è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦ç»™ã€ŒåŠ é”æ“ä½œã€è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆä¸æ˜¯å¯¹ã€Œé”ã€è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè€Œæ˜¯å¯¹ã€ŒåŠ é”æ“ä½œã€è®¾ç½®è¶…æ—¶æ—¶é—´ï¼‰ã€‚

    ç¬¬ä¸‰æ­¥æ˜¯ï¼Œä¸€æ—¦å®¢æˆ·ç«¯å®Œæˆäº†å’Œæ‰€æœ‰ Redis èŠ‚ç‚¹çš„åŠ é”æ“ä½œï¼Œå®¢æˆ·ç«¯å°±è¦è®¡ç®—æ•´ä¸ªåŠ é”è¿‡ç¨‹çš„æ€»è€—æ—¶ï¼ˆt1ï¼‰ã€‚

åŠ é”æˆåŠŸè¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼ˆç®€è¿°ï¼šå¦‚æœæœ‰è¶…è¿‡åŠæ•°çš„ Redis èŠ‚ç‚¹æˆåŠŸçš„è·å–åˆ°äº†é”ï¼Œå¹¶ä¸”æ€»è€—æ—¶æ²¡æœ‰è¶…è¿‡é”çš„æœ‰æ•ˆæ—¶é—´ï¼Œé‚£ä¹ˆå°±æ˜¯åŠ é”æˆåŠŸï¼‰ï¼š

    æ¡ä»¶ä¸€ï¼šå®¢æˆ·ç«¯ä»è¶…è¿‡åŠæ•°ï¼ˆå¤§äºç­‰äº N/2+1ï¼‰çš„ Redis èŠ‚ç‚¹ä¸ŠæˆåŠŸè·å–åˆ°äº†é”ï¼›
    æ¡ä»¶äºŒï¼šå®¢æˆ·ç«¯è·å–é”çš„æ€»è€—æ—¶ï¼ˆt1ï¼‰æ²¡æœ‰è¶…è¿‡é”çš„æœ‰æ•ˆæ—¶é—´ã€‚

åŠ é”æˆåŠŸåï¼Œå®¢æˆ·ç«¯éœ€è¦é‡æ–°è®¡ç®—è¿™æŠŠé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œè®¡ç®—çš„ç»“æœæ˜¯ã€Œé”çš„æœ€åˆæœ‰æ•ˆæ—¶é—´ã€å‡å»ã€Œå®¢æˆ·ç«¯ä¸ºè·å–é”çš„æ€»è€—æ—¶ï¼ˆt1ï¼‰ã€ã€‚

åŠ é”å¤±è´¥åï¼Œå®¢æˆ·ç«¯å‘æ‰€æœ‰ Redis èŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”çš„æ“ä½œï¼Œé‡Šæ”¾é”çš„æ“ä½œå’Œåœ¨å•èŠ‚ç‚¹ä¸Šé‡Šæ”¾é”çš„æ“ä½œä¸€æ ·ï¼Œåªè¦æ‰§è¡Œé‡Šæ”¾é”çš„ Lua è„šæœ¬å°±å¯ä»¥äº†ã€‚ --></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/lixvyang/edit/main/src/posts/program/redis/note/redis-note.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: lixin@lixins-MacBook-Pro.local">lixin</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">æœ¬ç«™åšå®¢æœªç»æˆæƒç¦æ­¢è½¬è½½</div><div class="vp-copyright">Lixin Â© 2020-2023</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-bd92852c.js" defer></script>
  </body>
</html>
